<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/tango.css">
    <link rel="shortcut icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Java Jvm各内存区域溢出测试 - 剑指Offer</title>
    <meta name="keywords" content="algorithm，python"/>
    <meta name="description" content="for python and algorithm"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/sword_at_offer/">Home</a>&nbsp;&#187;&nbsp;<a href="/sword_at_offer/#java_jvm">java_jvm</a>&nbsp;&#187;&nbsp;Java Jvm各内存区域溢出测试
    <span class="updated">Page Updated&nbsp;
      2019-02-15 00:00
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">Java Jvm各内存区域溢出测试</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#java">java 内存区域和内存溢出异常</a><ul>
<li><a href="#outofmemoryerror">OutOfMemoryError</a></li>
<li><a href="#_1">虚拟机栈和本地方法栈溢出</a></li>
<li><a href="#_2">方法区和运行时常量池溢出</a><ul>
<li><a href="#java7-javalangoutofmemoryerror-java-heap-space">Java7 常量池 仍是java.lang.OutOfMemoryError: Java heap space</a></li>
</ul>
</li>
<li><a href="#_3">直接内存溢出</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="java">java 内存区域和内存溢出异常</h1>
<h2 id="outofmemoryerror">OutOfMemoryError</h2>
<p>java vm参数</p>
<ul>
<li>-Xms20M</li>
</ul>
<p>表示设置<code>堆容量的最小值</code>为20M，必须以M为单位</p>
<ul>
<li>-Xmx20M</li>
</ul>
<p>表示设置堆容量的最大值为20M，必须以M为单位。将-Xmx和-Xms设置为一样可以避免堆自动扩展。</p>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">java7</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * 参数设置：-verbose:gc -Xms20M -Xmx20M -XX:+HeapDumpOnOutOfMemoryError</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2019/2/20 11:05 PM</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HeapOOM</span> <span class="o">{</span>
    <span class="kd">static</span> <span class="kd">class</span> <span class="nc">OOMObject</span><span class="o">{</span>

    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">OOMObject</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="mi">16</span><span class="o">);</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">){</span>
            <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">OOMObject</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<ul>
<li>output</li>
</ul>
<div class="hlcode"><pre><span class="o">[</span><span class="n">GC</span> <span class="mi">5499</span><span class="n">K</span><span class="o">-&gt;</span><span class="mi">3757</span><span class="n">K</span><span class="o">(</span><span class="mi">20480</span><span class="n">K</span><span class="o">),</span> <span class="mf">0.0069130</span> <span class="n">secs</span><span class="o">]</span>
<span class="o">[</span><span class="n">GC</span> <span class="mi">9901</span><span class="n">K</span><span class="o">-&gt;</span><span class="mi">8805</span><span class="n">K</span><span class="o">(</span><span class="mi">20480</span><span class="n">K</span><span class="o">),</span> <span class="mf">0.0089900</span> <span class="n">secs</span><span class="o">]</span>
<span class="o">[</span><span class="n">Full</span> <span class="n">GC</span> <span class="mi">18460</span><span class="n">K</span><span class="o">-&gt;</span><span class="mi">13805</span><span class="n">K</span><span class="o">(</span><span class="mi">20480</span><span class="n">K</span><span class="o">),</span> <span class="mf">0.1417260</span> <span class="n">secs</span><span class="o">]</span>
<span class="o">[</span><span class="n">Full</span> <span class="n">GC</span> <span class="mi">17849</span><span class="n">K</span><span class="o">-&gt;</span><span class="mi">17803</span><span class="n">K</span><span class="o">(</span><span class="mi">20480</span><span class="n">K</span><span class="o">),</span> <span class="mf">0.1140610</span> <span class="n">secs</span><span class="o">]</span>
<span class="o">[</span><span class="n">Full</span> <span class="n">GC</span> <span class="mi">17803</span><span class="n">K</span><span class="o">-&gt;</span><span class="mi">17791</span><span class="n">K</span><span class="o">(</span><span class="mi">20480</span><span class="n">K</span><span class="o">),</span> <span class="mf">0.0981060</span> <span class="n">secs</span><span class="o">]</span>
<span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">OutOfMemoryError</span><span class="o">:</span> <span class="n">Java</span> <span class="n">heap</span> <span class="n">space</span>
<span class="n">Dumping</span> <span class="n">heap</span> <span class="n">to</span> <span class="n">java_pid42185</span><span class="o">.</span><span class="na">hprof</span> <span class="o">...</span>
<span class="n">Heap</span> <span class="n">dump</span> <span class="n">file</span> <span class="n">created</span> <span class="o">[</span><span class="mi">30470683</span> <span class="n">bytes</span> <span class="n">in</span> <span class="mf">0.161</span> <span class="n">secs</span><span class="o">]</span>
<span class="n">Exception</span> <span class="n">in</span> <span class="n">thread</span> <span class="s">&quot;main&quot;</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">OutOfMemoryError</span><span class="o">:</span> <span class="n">Java</span> <span class="n">heap</span> <span class="n">space</span>
    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">2245</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">2219</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">ArrayList</span><span class="o">.</span><span class="na">grow</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">242</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">ArrayList</span><span class="o">.</span><span class="na">ensureExplicitCapacity</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">216</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">ArrayList</span><span class="o">.</span><span class="na">ensureCapacityInternal</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">208</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">ArrayList</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">440</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java7</span><span class="o">.</span><span class="na">HeapOOM</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">HeapOOM</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">17</span><span class="o">)</span>
</pre></div>


<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/java_jvm/imgs/stream_operate.png" /></p>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/java_jvm/imgs/oom_analyse.png" /></p>
<ul>
<li>
<p>Shallow heap是一个对象消费的内存数量。每个对象的引用需要32（或者64 bits，基于CPU架构）。</p>
</li>
<li>
<p>Retained Heap显示的是那些当垃圾回收时候会清理的所有对象的Shallow Heap的总和。</p>
</li>
</ul>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/java_jvm/imgs/histogram.png" /></p>
<ul>
<li>
<p>参考</p>
</li>
<li>
<p>《Java 虚拟机》（第二版）</p>
</li>
<li>
<p>https://www.cnblogs.com/cnmenglang/p/6261435.html</p>
</li>
<li>
<p>https://www.jianshu.com/p/759e02c1feee</p>
</li>
</ul>
<h2 id="_1">虚拟机栈和本地方法栈溢出</h2>
<ul>
<li>
<p>Java程序中，每个线程都有自己的Stack Space(堆栈)。</p>
</li>
<li>
<p>-Xss128k：</p>
</li>
</ul>
<p>设置每个线程的堆栈大小。JDK5.0以后每个线程堆 栈大小为1M，以前每个线程堆栈大小为256K。根据应用的线程所需内存大小进行调整。在相同物理内存下，减小这个值能生成更多的线程。但是操作系统对一个进程内的线程数还是有限制的，不能无限生成，经验值在3000~5000左右</p>
<p>Stack Space用来做方法的递归调用时压入Stack Frame(栈帧)。所以当递归调用太深的时候，就有可能耗尽Stack Space，爆出StackOverflow的错误。</p>
<ul>
<li>code</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">java7</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * 参数设置：-Xss160k</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2019/2/20 11:05 PM</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JavaVMStackSOF</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">stackLength</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">stackLeak</span><span class="o">(){</span>
        <span class="n">stackLength</span> <span class="o">++;</span>
        <span class="n">stackLeak</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
       <span class="n">JavaVMStackSOF</span> <span class="n">javaVMStackSOF</span> <span class="o">=</span> <span class="k">new</span> <span class="n">JavaVMStackSOF</span><span class="o">();</span>
       <span class="k">try</span><span class="o">{</span>
           <span class="n">javaVMStackSOF</span><span class="o">.</span><span class="na">stackLeak</span><span class="o">();</span>
       <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Throwable</span> <span class="n">e</span><span class="o">){</span>
           <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;stackLength:&quot;</span> <span class="o">+</span> <span class="n">javaVMStackSOF</span><span class="o">.</span><span class="na">stackLength</span><span class="o">);</span>
           <span class="k">throw</span> <span class="n">e</span><span class="o">;</span>
       <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>output</p>
<div class="hlcode"><pre><span class="nl">stackLength:</span><span class="mi">774</span>
<span class="n">Exception</span> <span class="n">in</span> <span class="n">thread</span> <span class="s">&quot;main&quot;</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">StackOverflowError</span>
    <span class="n">at</span> <span class="n">java7</span><span class="o">.</span><span class="na">JavaVMStackSOF</span><span class="o">.</span><span class="na">stackLeak</span><span class="o">(</span><span class="n">JavaVMStackSOF</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">10</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java7</span><span class="o">.</span><span class="na">JavaVMStackSOF</span><span class="o">.</span><span class="na">stackLeak</span><span class="o">(</span><span class="n">JavaVMStackSOF</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">11</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java7</span><span class="o">.</span><span class="na">JavaVMStackSOF</span><span class="o">.</span><span class="na">stackLeak</span><span class="o">(</span><span class="n">JavaVMStackSOF</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">11</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java7</span><span class="o">.</span><span class="na">JavaVMStackSOF</span><span class="o">.</span><span class="na">stackLeak</span><span class="o">(</span><span class="n">JavaVMStackSOF</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">11</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java7</span><span class="o">.</span><span class="na">JavaVMStackSOF</span><span class="o">.</span><span class="na">stackLeak</span><span class="o">(</span><span class="n">JavaVMStackSOF</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">11</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java7</span><span class="o">.</span><span class="na">JavaVMStackSOF</span><span class="o">.</span><span class="na">stackLeak</span><span class="o">(</span><span class="n">JavaVMStackSOF</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">11</span><span class="o">)</span>
</pre></div>


<p>参考：</p>
<ol>
<li>https://blog.csdn.net/z69183787/article/details/79228215</li>
</ol>
<h2 id="_2">方法区和运行时常量池溢出</h2>
<p>方法区用于存放Class的相关信息，如：类名，访问修饰符，常量池，字符描述，方法描述等。对于这个区域的测试，基本思路是运行时产生大量的类去填满方法区，直到溢出。</p>
<ul>
<li>Java7中</li>
</ul>
<p>永久代仍存在； 符号引用(Symbols)转移到了native heap；字面量(interned strings)转移到了java heap；类的静态变量(class statics)转移到了java heap。</p>
<h3 id="java7-javalangoutofmemoryerror-java-heap-space">Java7 常量池 仍是<code>java.lang.OutOfMemoryError: Java heap space</code></h3>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">java7</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * VM args: -XX:PermSize=10M -XX:MaxPermSize=10M</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">JavaMethodAreaOOM</span> <span class="o">{</span>
    <span class="cm">/**</span>
<span class="cm">     * 在JDK1.6中，intern()方法会把首次遇到的字符串复制到永久代中，</span>
<span class="cm">     * 返回的也是永久代中这个字符串的引用，</span>
<span class="cm">     * 而由StringBuilder创建的字符串实例在Java堆中，所以必然不是同一个引用，将返回false。</span>
<span class="cm">     * </span>
<span class="cm">     * 而JDK1.7(以及部分其他虚拟机，例如JRockit)的intern()实现不会再复制实例，而是在常量池中记录首次出现的实例引用，</span>
<span class="cm">     * 因此intern()返回的引用和由StringBuilder创建的那个字符串是同一个。</span>
<span class="cm">     */</span>
    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testStringIntern</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">str1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="s">&quot;计算机&quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;软件&quot;</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">str1</span><span class="o">.</span><span class="na">intern</span><span class="o">()</span> <span class="o">==</span> <span class="n">str1</span><span class="o">);</span> <span class="c1">// true</span>

        <span class="n">String</span> <span class="n">str2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="s">&quot;ja&quot;</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;va&quot;</span><span class="o">).</span><span class="na">toString</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">str2</span><span class="o">.</span><span class="na">intern</span><span class="o">()</span> <span class="o">==</span> <span class="n">str2</span><span class="o">);</span> <span class="c1">// false</span>
    <span class="o">}</span>

    <span class="kd">static</span> <span class="n">String</span>  <span class="n">base</span> <span class="o">=</span> <span class="s">&quot;string&quot;</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
        <span class="c1">// 不断生成字符串常量</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span> <span class="n">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">;</span><span class="n">i</span><span class="o">++){</span>
            <span class="n">String</span> <span class="n">str</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">base</span><span class="o">;</span>
            <span class="n">base</span> <span class="o">=</span> <span class="n">str</span><span class="o">;</span>
            <span class="n">list</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">str</span><span class="o">.</span><span class="na">intern</span><span class="o">());</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<ul>
<li>output</li>
</ul>
<div class="hlcode"><pre><span class="n">Exception</span> <span class="n">in</span> <span class="n">thread</span> <span class="s">&quot;main&quot;</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">OutOfMemoryError</span><span class="o">:</span> <span class="n">Java</span> <span class="n">heap</span> <span class="n">space</span>
    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">util</span><span class="o">.</span><span class="na">Arrays</span><span class="o">.</span><span class="na">copyOf</span><span class="o">(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">2367</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">AbstractStringBuilder</span><span class="o">.</span><span class="na">expandCapacity</span><span class="o">(</span><span class="n">AbstractStringBuilder</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">130</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">AbstractStringBuilder</span><span class="o">.</span><span class="na">ensureCapacityInternal</span><span class="o">(</span><span class="n">AbstractStringBuilder</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">114</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">AbstractStringBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">AbstractStringBuilder</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">415</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">StringBuilder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">StringBuilder</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">132</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java7</span><span class="o">.</span><span class="na">JavaMethodAreaOOM</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">JavaMethodAreaOOM</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">31</span>
</pre></div>


<p>参考：</p>
<ol>
<li>https://blog.csdn.net/tlk20071/article/details/77841841</li>
</ol>
<h2 id="_3">直接内存溢出</h2>
<p>NIO的Buffer提供了一个可以不经过JVM内存直接访问系统物理内存的类——DirectBuffer。DirectBuffer类继承自ByteBuffer，但和普通的ByteBuffer不同，普通的ByteBuffer仍在JVM堆上分配内存，其最大内存受到最大堆内存的限制；而DirectBuffer直接分配在物理内存中，并不占用堆空间，其可申请的最大内存受操作系统限制。</p>
<p>直接内存的读写操作比普通Buffer快，但它的创建、销毁比普通Buffer慢。</p>
<p>因此直接内存使用于需要大内存空间且频繁访问的场合，不适用于频繁申请释放内存的场合。</p>
<ul>
<li><code>-XX:MaxDirectMemorySize</code>，该值是有上限的，默认是64M，最大为<code>sun.misc.VM.maxDirectMemory()</code>，此参数的含义是当Direct ByteBuffer分配的堆外内存到达指定大小后，即触发Full GC</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">java7</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.nio.ByteBuffer</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * 参数设置：-verbose:-Xmx20M -XX:MaxDirectMemorySize=10M</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2019/2/20 11:05 PM</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">DirectMemoryOOM</span> <span class="o">{</span>
     <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">_1MB</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="mi">11</span> <span class="o">*</span> <span class="n">_1MB</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<ul>
<li>output</li>
</ul>
<div class="hlcode"><pre><span class="n">Exception</span> <span class="n">in</span> <span class="n">thread</span> <span class="s">&quot;main&quot;</span> <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">OutOfMemoryError</span><span class="o">:</span> <span class="n">Direct</span> <span class="n">buffer</span> <span class="n">memory</span>
    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">Bits</span><span class="o">.</span><span class="na">reserveMemory</span><span class="o">(</span><span class="n">Bits</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">658</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">DirectByteBuffer</span><span class="o">.&lt;</span><span class="n">init</span><span class="o">&gt;(</span><span class="n">DirectByteBuffer</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">123</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java</span><span class="o">.</span><span class="na">nio</span><span class="o">.</span><span class="na">ByteBuffer</span><span class="o">.</span><span class="na">allocateDirect</span><span class="o">(</span><span class="n">ByteBuffer</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">306</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">java7</span><span class="o">.</span><span class="na">DirectMemoryOOM</span><span class="o">.</span><span class="na">main</span><span class="o">(</span><span class="n">DirectMemoryOOM</span><span class="o">.</span><span class="na">java</span><span class="o">:</span><span class="mi">14</span><span class="o">)</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 doctording.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-05-04 22:41:22</p>
      </span>
    </div>

    
    
  </body>
</html>