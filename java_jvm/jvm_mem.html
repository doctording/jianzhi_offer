<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/tango.css">
    <link rel="shortcut icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Java 堆栈 & 各种GC - 剑指Offer</title>
    <meta name="keywords" content="algorithm，python"/>
    <meta name="description" content="for python and algorithm"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/sword_at_offer/">Home</a>&nbsp;&#187;&nbsp;<a href="/sword_at_offer/#java_jvm">java_jvm</a>&nbsp;&#187;&nbsp;Java 堆栈 & 各种GC
    <span class="updated">Page Updated&nbsp;
      2019-02-15 00:00
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">Java 堆栈 & 各种GC</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#java7">Java7堆内存划分</a><ul>
<li><a href="#java">图书《深入理解java虚拟机》堆的描述</a></li>
<li><a href="#_1">堆区域</a></li>
<li><a href="#java7_1">Java7 堆的各区域</a><ul>
<li><a href="#perm-space">永久代(Perm space)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#java8">Java8 内存区域</a><ul>
<li><a href="#_2">元空间</a></li>
</ul>
</li>
<li><a href="#_3">常见的垃圾回收算法</a></li>
<li><a href="#_4">垃圾收集器</a><ul>
<li><a href="#_5">三个问题</a><ul>
<li><a href="#1">1.哪些内存需要回收</a></li>
<li><a href="#2">2.什么时候回收</a></li>
<li><a href="#3">3.如何回收</a></li>
</ul>
</li>
<li><a href="#_6">可达性分析 判定对象是否存活</a><ul>
<li><a href="#javagc-roots">Java中可作为GC Roots的对象包括</a></li>
</ul>
</li>
<li><a href="#reference">引用Reference</a></li>
<li><a href="#_7">对象是生存还是死亡的？(两次标记)</a></li>
<li><a href="#_8">回收方法区</a></li>
<li><a href="#hotspot">HotSpot 算法实现</a></li>
</ul>
</li>
<li><a href="#_9">收集器</a><ul>
<li><a href="#cmsconcurrent-mark-sweep">CMS(Concurrent Mark Sweep)</a></li>
<li><a href="#g1garbage-first">G1(Garbage First)</a><ul>
<li><a href="#_10">参考学习文档</a></li>
<li><a href="#g1">G1 内存区域分布图和概念介绍</a></li>
<li><a href="#g1_1">G1 常用参数</a></li>
<li><a href="#g1gc">G1的gc运作</a><ul>
<li><a href="#young-gcgc">young gc(对年轻代的GC)</a></li>
<li><a href="#gc">对老年代的GC</a><ul>
<li><a href="#initial-marking-phase">Initial Marking Phase</a></li>
<li><a href="#concurrent-marking-phase">Concurrent Marking Phase</a></li>
<li><a href="#remark-phase">Remark Phase</a></li>
<li><a href="#copyingcleanup-phase">Copying/Cleanup Phase</a></li>
</ul>
</li>
<li><a href="#gc_1">对年轻代和老年代GC的总结</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_11">内存分配与回收策略(理论基础)</a><ul>
<li><a href="#eden">对象优先在Eden分配</a><ul>
<li><a href="#minor-gcyong-gc">minor gc(yong gc)</a></li>
<li><a href="#major-gc-full-gc">major gc/ full gc</a></li>
<li><a href="#java-gc-java7-cms">Java GC测试程序 和 初始堆情况(Java7 CMS)</a><ul>
<li><a href="#gc_2">对应GC日志</a></li>
</ul>
</li>
<li><a href="#_12">参考</a></li>
</ul>
</li>
<li><a href="#_13">大对象直接进入老年代</a></li>
<li><a href="#_14">长期存活的对象将进入老年代</a></li>
<li><a href="#_15">动态对象的年龄判定</a></li>
<li><a href="#_16">空间分配担保</a></li>
<li><a href="#gc_3">触发gc的条件</a><ul>
<li><a href="#minor-gc">Minor GC触发条件</a></li>
<li><a href="#full-gc">Full GC触发条件</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#g1-cms">G1 和 CMS</a></li>
<li><a href="#jvmgc">JVM参数与GC</a><ul>
<li><a href="#java8-gc">Java8 默认GC</a></li>
</ul>
</li>
<li><a href="#gc_4">GC收集器及其发展</a><ul>
<li><a href="#serial">(一) Serial 收集器</a></li>
<li><a href="#parallel-scavenge">(二) Parallel Scavenge 收集器</a></li>
<li><a href="#parnew">(二) ParNew 收集器</a></li>
<li><a href="#cms">(三) CMS收集器</a></li>
<li><a href="#g1_2">(四) G1</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="java7">Java7堆内存划分</h1>
<h2 id="java">图书《深入理解java虚拟机》堆的描述</h2>
<ol>
<li>Java堆（Java Heap）是java虚拟机所管理的内存中最大的一块</li>
<li>Java堆被所有线程共享的一块内存区域</li>
<li>虚拟机启动时创建java堆</li>
<li>Java堆的唯一目的就是存放对象实例。</li>
<li>Java堆是垃圾收集器管理的主要区域。</li>
<li>从内存回收的角度来看， 由于现在收集器基本都采用分代收集算法， 所以Java堆可以细分为：新生代（<code>Young</code>）和老年代（<code>Old</code>）。 新生代又被划分为三个区域<code>Eden</code>、<code>From Survivor</code>， <code>To Survivor</code>等。无论怎么划分，最终存储的都是实例对象， 进一步划分的目的是为了更好的回收内存， 或者更快的分配内存。</li>
<li>Java堆的大小是可扩展的， 通过<code>-Xms</code>和<code>-Xmx</code>控制。</li>
<li>如果堆内存不够分配实例对象， 并且对也无法在扩展时， 将会抛出outOfMemoryError异常。</li>
</ol>
<h2 id="_1">堆区域</h2>
<ul>
<li>堆大小 = 新生代 + 老年代（默认：新生代:老年代=<code>1:2</code>，即<code>1/3</code>的新生代，<code>2/3</code>的老年代）。堆大小设置参数：<code>–Xms</code>（堆的初始容量）、<code>-Xmx</code>（堆的最大容量）</li>
<li>其中，新生代 (<code>Young</code>) 被细分为<code>Eden</code>和两个<code>Survivor</code>区域，这两个<code>Survivor</code>区域分别被命名为<code>from</code>和<code>to</code>，以示区分。默认的，<code>Edem : from : to = 8 : 1 : 1</code>。(可以通过参数<code>–XX:SurvivorRatio</code>来设定 。即： Eden = 8/10 的新生代空间大小，from = to = 1/10 的新生代空间大小。</li>
<li>JVM 每次只会使用<code>Eden</code>和其中的一块<code>Survivor</code>区域来为对象服务，所以无论什么时候，总是有一块<code>Survivor</code>区域是空闲着的。</li>
<li>新生代实际可用的内存空间为 9/10 ( 即90% )的新生代空间。</li>
</ul>
<p><code>jstat</code>查看gc相关的堆信息</p>
<h2 id="java7_1">Java7 堆的各区域</h2>
<div class="hlcode"><pre><span class="o">^</span><span class="n">Cmubi</span><span class="nd">@mubideMacBook</span><span class="o">-</span><span class="n">Pro</span> <span class="n">Home</span> <span class="n">$</span> <span class="n">pwd</span>
<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Java</span><span class="o">/</span><span class="n">JavaVirtualMachines</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0</span><span class="n">_80</span><span class="o">.</span><span class="na">jdk</span><span class="o">/</span><span class="n">Contents</span><span class="o">/</span><span class="n">Home</span>
<span class="n">mubi</span><span class="nd">@mubideMacBook</span><span class="o">-</span><span class="n">Pro</span> <span class="n">Home</span> <span class="n">$</span> <span class="n">bin</span><span class="o">/</span><span class="n">jstat</span> <span class="o">-</span><span class="n">gcutil</span> <span class="mi">62850</span> <span class="mi">1000</span> <span class="mi">10</span>
<span class="nl">Warning:</span> <span class="n">Unresolved</span> <span class="nl">Symbol:</span> <span class="n">sun</span><span class="o">.</span><span class="na">gc</span><span class="o">.</span><span class="na">generation</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="na">space</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="na">capacity</span> <span class="n">substituted</span> <span class="n">NaN</span>
<span class="nl">Warning:</span> <span class="n">Unresolved</span> <span class="nl">Symbol:</span> <span class="n">sun</span><span class="o">.</span><span class="na">gc</span><span class="o">.</span><span class="na">generation</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="na">space</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="na">used</span> <span class="n">substituted</span> <span class="n">NaN</span>
<span class="nl">Warning:</span> <span class="n">Unresolved</span> <span class="nl">Symbol:</span> <span class="n">sun</span><span class="o">.</span><span class="na">gc</span><span class="o">.</span><span class="na">generation</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="na">space</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="na">capacity</span> <span class="n">substituted</span> <span class="n">NaN</span>
  <span class="n">S0</span>     <span class="n">S1</span>     <span class="n">E</span>      <span class="n">O</span>      <span class="n">P</span>     <span class="n">YGC</span>     <span class="n">YGCT</span>    <span class="n">FGC</span>    <span class="n">FGCT</span>     <span class="n">GCT</span>
  <span class="mf">0.00</span>  <span class="mf">85.81</span>  <span class="mf">76.97</span>  <span class="mf">56.33</span>      <span class="err">�</span>    <span class="mi">161</span>    <span class="mf">1.624</span>    <span class="mi">14</span>    <span class="mf">0.603</span>    <span class="mf">2.227</span>
  <span class="mf">0.00</span>  <span class="mf">85.81</span>  <span class="mf">77.08</span>  <span class="mf">56.33</span>      <span class="err">�</span>    <span class="mi">161</span>    <span class="mf">1.624</span>    <span class="mi">14</span>    <span class="mf">0.603</span>    <span class="mf">2.227</span>
  <span class="mf">0.00</span>  <span class="mf">85.81</span>  <span class="mf">77.22</span>  <span class="mf">56.33</span>      <span class="err">�</span>    <span class="mi">161</span>    <span class="mf">1.624</span>    <span class="mi">14</span>    <span class="mf">0.603</span>    <span class="mf">2.227</span>
  <span class="mf">0.00</span>   <span class="mf">85.81</span>  <span class="mf">77.33</span>  <span class="mf">56.33</span>      <span class="err">�</span>    <span class="mi">161</span>    <span class="mf">1.624</span>    <span class="mi">14</span>    <span class="mf">0.603</span>    <span class="mf">2.227</span>
</pre></div>


<ul>
<li>E    — Heap上的 Eden space 区已使用空间的百分比(<code>Eden</code>)</li>
<li>S0   — Heap上的 Survivor space 0 区已使用空间的百分比(<code>From</code>)</li>
<li>S1   — Heap上的 Survivor space 1 区已使用空间的百分比(<code>To</code>)</li>
<li>O    — Heap上的 Old space 区已使用空间的百分比(<code>Old</code>)</li>
<li>P    — Perm space 区已使用空间的百分比（<code>Java7中的Perm Generation</code>）</li>
<li>YGC  — 从应用程序启动到采样时发生 Young GC 的次数</li>
<li>YGCT – 从应用程序启动到采样时 Young GC 所用的时间(单位秒)</li>
<li>FGC  — 从应用程序启动到采样时发生 Full GC 的次数</li>
<li>FGCT – 从应用程序启动到采样时 Full GC 所用的时间(单位秒)</li>
<li>GCT  — 从应用程序启动到采样时用于垃圾回收的总时间(单位秒)</li>
</ul>
<h3 id="perm-space">永久代(Perm space)</h3>
<p>这个区域的内存回收目标主要是针对常量池的回收和对类型的卸载</p>
<h1 id="java8">Java8 内存区域</h1>
<div class="hlcode"><pre><span class="n">Cmubi</span><span class="nd">@mubideMacBook</span><span class="o">-</span><span class="n">Pro</span> <span class="n">Home</span> <span class="n">$</span> <span class="n">pwd</span>
<span class="o">/</span><span class="n">Library</span><span class="o">/</span><span class="n">Java</span><span class="o">/</span><span class="n">JavaVirtualMachines</span><span class="o">/</span><span class="n">jdk1</span><span class="o">.</span><span class="mf">7.0</span><span class="n">_80</span><span class="o">.</span><span class="na">jdk</span><span class="o">/</span><span class="n">Contents</span><span class="o">/</span><span class="n">Home</span>
<span class="n">mubi</span><span class="nd">@mubideMacBook</span><span class="o">-</span><span class="n">Pro</span> <span class="n">Home</span> <span class="n">$</span> <span class="n">bin</span><span class="o">/</span><span class="n">jstat</span> <span class="o">-</span><span class="n">gcutil</span> <span class="mi">62850</span> <span class="mi">1000</span> <span class="mi">10</span>
<span class="nl">Warning:</span> <span class="n">Unresolved</span> <span class="nl">Symbol:</span> <span class="n">sun</span><span class="o">.</span><span class="na">gc</span><span class="o">.</span><span class="na">generation</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="na">space</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="na">capacity</span> <span class="n">substituted</span> <span class="n">NaN</span>
<span class="nl">Warning:</span> <span class="n">Unresolved</span> <span class="nl">Symbol:</span> <span class="n">sun</span><span class="o">.</span><span class="na">gc</span><span class="o">.</span><span class="na">generation</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="na">space</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="na">used</span> <span class="n">substituted</span> <span class="n">NaN</span>
<span class="nl">Warning:</span> <span class="n">Unresolved</span> <span class="nl">Symbol:</span> <span class="n">sun</span><span class="o">.</span><span class="na">gc</span><span class="o">.</span><span class="na">generation</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="na">space</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="na">capacity</span> <span class="n">substituted</span> <span class="n">NaN</span>
  <span class="n">S0</span>     <span class="n">S1</span>     <span class="n">E</span>      <span class="n">O</span>      <span class="n">P</span>     <span class="n">YGC</span>     <span class="n">YGCT</span>    <span class="n">FGC</span>    <span class="n">FGCT</span>     <span class="n">GCT</span>
  <span class="mf">0.00</span>  <span class="mf">85.81</span>  <span class="mf">76.97</span>  <span class="mf">56.33</span>      <span class="err">�</span>    <span class="mi">161</span>    <span class="mf">1.624</span>    <span class="mi">14</span>    <span class="mf">0.603</span>    <span class="mf">2.227</span>
  <span class="mf">0.00</span>  <span class="mf">85.81</span>  <span class="mf">77.08</span>  <span class="mf">56.33</span>      <span class="err">�</span>    <span class="mi">161</span>    <span class="mf">1.624</span>    <span class="mi">14</span>    <span class="mf">0.603</span>    <span class="mf">2.227</span>
  <span class="mf">0.00</span>  <span class="mf">85.81</span>  <span class="mf">77.22</span>  <span class="mf">56.33</span>      <span class="err">�</span>    <span class="mi">161</span>    <span class="mf">1.624</span>    <span class="mi">14</span>    <span class="mf">0.603</span>    <span class="mf">2.227</span>
  <span class="mf">0.00</span>  <span class="mf">85.81</span>  <span class="mf">77.33</span>  <span class="mf">56.33</span>      <span class="err">�</span>    <span class="mi">161</span>    <span class="mf">1.624</span>    <span class="mi">14</span>    <span class="mf">0.603</span>    <span class="mf">2.227</span>
<span class="o">^</span><span class="n">Cmubi</span><span class="nd">@mubideMacBook</span><span class="o">-</span><span class="n">Pro</span> <span class="n">Home</span> <span class="n">$</span> <span class="n">jstat</span> <span class="o">-</span><span class="n">gcutil</span> <span class="mi">62850</span> <span class="mi">1000</span> <span class="mi">10</span>
  <span class="n">S0</span>     <span class="n">S1</span>     <span class="n">E</span>      <span class="n">O</span>      <span class="n">M</span>     <span class="n">CCS</span>    <span class="n">YGC</span>     <span class="n">YGCT</span>    <span class="n">FGC</span>    <span class="n">FGCT</span>     <span class="n">GCT</span>
  <span class="mf">0.00</span>  <span class="mf">85.81</span>  <span class="mf">78.86</span>  <span class="mf">56.33</span>  <span class="mf">93.46</span>  <span class="mf">89.80</span>    <span class="mi">161</span>    <span class="mf">1.624</span>    <span class="mi">14</span>    <span class="mf">0.603</span>    <span class="mf">2.227</span>
  <span class="mf">0.00</span>  <span class="mf">85.81</span>  <span class="mf">78.93</span>  <span class="mf">56.33</span>  <span class="mf">93.46</span>  <span class="mf">89.80</span>    <span class="mi">161</span>    <span class="mf">1.624</span>    <span class="mi">14</span>    <span class="mf">0.603</span>    <span class="mf">2.227</span>
  <span class="mf">0.00</span>  <span class="mf">85.81</span>  <span class="mf">79.04</span>  <span class="mf">56.33</span>  <span class="mf">93.46</span>  <span class="mf">89.80</span>    <span class="mi">161</span>    <span class="mf">1.624</span>    <span class="mi">14</span>    <span class="mf">0.603</span>    <span class="mf">2.227</span>
  <span class="mf">0.00</span>  <span class="mf">85.81</span>  <span class="mf">79.17</span>  <span class="mf">56.33</span>  <span class="mf">93.46</span>  <span class="mf">89.80</span>    <span class="mi">161</span>    <span class="mf">1.624</span>    <span class="mi">14</span>    <span class="mf">0.603</span>    <span class="mf">2.227</span>
  <span class="mf">0.00</span>  <span class="mf">85.81</span>  <span class="mf">79.29</span>  <span class="mf">56.33</span>  <span class="mf">93.46</span>  <span class="mf">89.80</span>    <span class="mi">161</span>    <span class="mf">1.624</span>    <span class="mi">14</span>    <span class="mf">0.603</span>    <span class="mf">2.227</span>
<span class="o">^</span><span class="n">Cmubi</span><span class="nd">@mubideMacBook</span><span class="o">-</span><span class="n">Pro</span> <span class="n">Home</span> <span class="n">$</span>
</pre></div>


<ul>
<li>S0   — Heap上的 Survivor space 0 区已使用空间的百分比(<code>From</code>)</li>
<li>S1   — Heap上的 Survivor space 1 区已使用空间的百分比(<code>To</code>)</li>
<li>E    — Heap上的 Eden space 区已使用空间的百分比(<code>Eden</code>)</li>
<li>O    — Heap上的 Old space 区已使用空间的百分比(<code>Old</code>)</li>
<li>M    - 元空间（Metaspace）： Klass Metaspace, NoKlass Metaspace</li>
<li>CCS  - 表示的是NoKlass Metaspace的使用率</li>
<li>YGC  — 从应用程序启动到采样时发生 Young GC 的次数</li>
<li>YGCT – 从应用程序启动到采样时 Young GC 所用的时间(单位秒)</li>
<li>FGC  — 从应用程序启动到采样时发生 Full GC 的次数</li>
<li>FGCT – 从应用程序启动到采样时 Full GC 所用的时间(单位秒)</li>
<li>GCT  — 从应用程序启动到采样时用于垃圾回收的总时间(单位秒)</li>
</ul>
<h2 id="_2">元空间</h2>
<p>参考学习1: <a target='_blank' href='http://openjdk.java.net/jeps/122'>openjdk相关文档</a></p>
<p>Class metadata, interned Strings and class static variables will be moved from the permanent generation to either the Java heap or native memory.<br />
(原来的永久代(class元信息、字面常量、静态变量等)转移到heap或者native memory中)</p>
<p><strong>Metaspace</strong>由两大部分组成：Klass Metaspace和NoKlass Metaspace。</p>
<ol>
<li>klass Metaspace就是用来存klass的，就是class文件在jvm里的运行时数据结构，是一块连续的内存区域，紧接着Heap</li>
<li>NoKlass Metaspace专门来存klass相关的其他的内容，比如method，constantPool等，可以由多块不连续的内存组成</li>
</ol>
<h1 id="_3">常见的垃圾回收算法</h1>
<p>参考学习：</p>
<p><a href='https://blog.csdn.net/qq_26437925/article/details/53728388'>几种垃圾回收算法</a></p>
<h1 id="_4">垃圾收集器</h1>
<h2 id="_5">三个问题</h2>
<h3 id="1">1.哪些内存需要回收</h3>
<h3 id="2">2.什么时候回收</h3>
<h3 id="3">3.如何回收</h3>
<h2 id="_6"><code>可达性分析</code> 判定对象是否存活</h2>
<p>算法的基本思路就是通过一系列的称为<code>GC Roots</code>的对象作为起始点，从这些节点向下搜索，搜索所走过的路径称为<code>引用链(Reference Chain)</code>,当一个对象到<code>GC Roots</code>没有任何引用链相连(用图论的话来说，就是<code>GC Roots</code>到这个对象不可达)时，则证明此对象是不可用的。</p>
<h3 id="javagc-roots">Java中可作为<code>GC Roots</code>的对象包括</h3>
<ul>
<li>虚拟机栈（栈帧中的本地变量表）中引用的对象</li>
<li>方法区中类静态属性引用的对象</li>
<li>方法区中常量引用的对象</li>
<li>本地方法栈中JNI(即一般说的Native方法)引用的对象</li>
</ul>
<h2 id="reference">引用<code>Reference</code></h2>
<p>强引用(Strong)，软引用(Soft)，弱引用(Weak)，虚引用(Phantom)；引用强度依次减弱</p>
<ul>
<li>强引用是使用最普遍的引用。如果一个对象具有强引用，那垃圾回收器绝不会回收它。如</li>
</ul>
<div class="hlcode"><pre><span class="n">Object</span> <span class="n">o</span><span class="o">=</span><span class="k">new</span> <span class="n">Object</span><span class="o">();</span>
</pre></div>


<ul>
<li>软引用是用来描述一些还有用但并非必需的对象，对于软引用关联者的对象，在系统将要发生内存溢出异常之前，将会吧这些对象列进回收范围之中进行第二次回收。如果这次回收还没有足够的内存，才会抛出内存溢出异常。<code>SoftReference</code></li>
</ul>
<div class="hlcode"><pre><span class="n">String</span> <span class="n">str</span><span class="o">=</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="s">&quot;abc&quot;</span><span class="o">);</span>                                     <span class="c1">// 强引用</span>
<span class="n">SoftReference</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">softRef</span><span class="o">=</span><span class="k">new</span> <span class="n">SoftReference</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span><span class="n">str</span><span class="o">);</span>     <span class="c1">// 软引用</span>
</pre></div>


<ul>
<li>弱引用也是用来描述非必需对象的。但是它的强度比弱引用更弱一些，被弱引用关联的对象只能生成到下一次垃圾收集之前。当垃圾收集器工作时，无论当前内存是否足够，都会回收掉只被弱引用关联的对象。<code>WeakReference</code></li>
</ul>
<div class="hlcode"><pre><span class="n">String</span> <span class="n">str</span><span class="o">=</span><span class="k">new</span> <span class="n">String</span><span class="o">(</span><span class="s">&quot;abc&quot;</span><span class="o">);</span>
<span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">abcWeakRef</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;(</span><span class="n">str</span><span class="o">);</span>
<span class="n">str</span><span class="o">=</span><span class="kc">null</span><span class="o">;</span>
</pre></div>


<ul>
<li>虚引用也称为幽灵引用或者幻影引用，它是最弱的一种引用关系。一个对象是否有虚引用的存在，完全不会对其生存时间构成影响，也无法通过虚引用来取得一个对象实例。为一个对象设置虚引用关联的唯一目的就是能够在这个对象被收集器回收时收到一个系统通知。<code>PhantomReference</code></li>
</ul>
<p>参考：https://www.cnblogs.com/fengbs/p/7019687.html</p>
<h2 id="_7">对象是生存还是死亡的？(两次标记)</h2>
<p>对对象进行可达性分析 ？<br />
=》没有GC Roots的引用链 =》 判断对象是否有必要执行<code>finalize()</code>方法</p>
<ol>
<li>对象没有覆盖<code>finalize()</code>方法，或者<code>finalize()</code>方法已经被虚拟机调用过,虚拟机将这两种情况都视为"没有必要执行"</li>
<li>如果这个对象被判定为有必要执行<code>finalize()</code>方法,则这个对象会放置在一个叫做<code>F-Queue</code>的队列之中，并在稍后由一个虚拟机自动建立的，低优先级的<code>Finalizer线程</code>去执行它。</li>
</ol>
<p>如果对象对象要在<code>finalize()</code>中成功拯救自己--只需要重新与引用链上的任何一个对象建立关联即可，GC对<code>F-Queue</code>中对对象进行第二次标记时，会将它移出"即将回收"的集合，否则会被回收</p>
<ul>
<li>自救代码</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">java7</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * 此代码说明如下两点：</span>
<span class="cm"> * 1. 对象可以在GC时自我拯救</span>
<span class="cm"> * 2. 这种自救的机会只有一次，因为一个对象的`finalize()`方法最多只会被系统自动调用一次</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">FinalizeEscapeGC</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">FinalizeEscapeGC</span> <span class="n">SAVE_HOOK</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">FinalizeEscapeGC</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">isAlive</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;yes, i am still alive&quot;</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">finalize</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">finalize</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;finalize method executed!&quot;</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
        <span class="n">FinalizeEscapeGC</span><span class="o">.</span><span class="na">SAVE_HOOK</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
        <span class="n">SAVE_HOOK</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FinalizeEscapeGC</span><span class="o">(</span><span class="s">&quot;abc&quot;</span><span class="o">);</span>
        <span class="c1">// 对象第一次成功拯救自己</span>
        <span class="n">SAVE_HOOK</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">gc</span><span class="o">();</span>
        <span class="c1">// finalize方法的优先级很低，暂停0.5秒等待它</span>
        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">SAVE_HOOK</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">SAVE_HOOK</span><span class="o">.</span><span class="na">isAlive</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;no, i am dead&quot;</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="c1">// 下面这段代码与上面完全相同，但是这次自救却失败了</span>
        <span class="n">SAVE_HOOK</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">System</span><span class="o">.</span><span class="na">gc</span><span class="o">();</span>
        <span class="n">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">500</span><span class="o">);</span>
        <span class="k">if</span><span class="o">(</span><span class="n">SAVE_HOOK</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">SAVE_HOOK</span><span class="o">.</span><span class="na">isAlive</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;no, i am dead&quot;</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<ul>
<li>output</li>
</ul>
<div class="hlcode"><pre>finalize method executed!
abc
yes, i am still alive
no, i am dead
</pre></div>


<ul>
<li>最后，不推荐<code>finalize()</code></li>
</ul>
<h2 id="_8">回收方法区</h2>
<p>堆中，新生代进行一次垃圾收集一般可以回收70%-95%的空间，而永久代的垃圾收集效率远低于此。</p>
<p>永久代主要回收两部分内容： 废弃常量和无用的类， 判断"无用的类"：</p>
<ol>
<li>该类所有的实例都已经被回收，也就是Java堆中不存在该类的任何实例</li>
<li>加载该类的ClassLoader已经被回收</li>
<li>该类对应的java.lang.Class对象没有在任何地方被引用，无法在任何地方通过反射访问该类的方法</li>
</ol>
<p>是否对类进行回收，HotSpot虚拟机提供了<code>-Xnoclassgc</code>参数进行控制，还可以使用<code>-verbose:class</code>以及<code>-XX:+TraceClassLoading</code>,<code>-XX:+TraceClassUnLoading</code>查看类加载和卸载信息，其中<code>-verbose:class</code>和<code>-XX:+TraceClassLoading</code>可以在Product版的虚拟机中使用，<code>-XX:+TraceClassUnLoading</code>参数需要FastDebug版的虚拟机支持</p>
<p>在大量使用反射，动态代理，CGLib等ByteCode框架，动态生成JSP以及OSGi这类频繁自定义ClassLoader的场景都需要虚拟机具备类卸载的功能，以保证永久代不会溢出</p>
<h2 id="hotspot">HotSpot 算法实现</h2>
<p>可达性分析的"一致性"分析，GC进行时必须停顿所有Java执行线程(Sun将这件事情称为<code>Stop The World</code>)</p>
<p>虚拟机有办法直接得知哪些地方存放着对象的引用，HotSpot中使用一组称为<code>OopMap</code>的数据结构来达到这个目的：在类加载完成的时候，HotPot就把对象内什么偏移量是什么类型的数据计算出来，在JIT编译过程中，也会在特定的位置记录下栈和寄存器中哪些位置是引用。这样，GC在扫描时就可以直接得知这些信息了。</p>
<p>借助<code>OopMap</code>，HotSpot可以快速且准确地完成GC Roots枚举，问题：</p>
<ul>
<li>可能导致引用关系变化，或者说OopMap内容变化的指令特别多，如果为每一条指令都生成对应的OopMap，那将会需要大量的额外空间，这样GC的空间成本将会变得很高</li>
</ul>
<p>实际上，HotSpot没有为每条指令都生成<code>oopMap</code>, 安全点(<code>Sagepoint</code>) GC， 选举以"是否具有让程序长时间执行的特征"为标准进行选定，如方法调用，循环跳转，异常跳转等，这些功能的指令会产生安全点</p>
<h1 id="_9">收集器</h1>
<p>垃圾收集器，并发&amp;并行</p>
<ul>
<li>
<p>并行(Parallel)： 指多条垃圾收集线程并行工作，但此时用户线程仍然处于等待状态</p>
</li>
<li>
<p>并发(Concurrent): 只用户线程与垃圾收集线程同时执行（但不一定是并行但，可能会交替执行），用户程序在继续运行，而垃圾收集程序运行于另一个CPU上</p>
</li>
</ul>
<h2 id="cmsconcurrent-mark-sweep">CMS(Concurrent Mark Sweep)</h2>
<ul>
<li>并发收集，低停顿</li>
</ul>
<p>一种以获取最短回收停顿时间为目标但收集器：希望系统停顿时间最短，给用户带来较好但体验，4个步骤如下：</p>
<ol>
<li>初始标记（CMS initial mark）</li>
<li>并发标记（CMS concurrent mark）</li>
<li>重新标记（CMS remark）</li>
<li>并发清除（CMS concurrent sweep）</li>
</ol>
<p>1,3两个步骤仍需要"Stop The World"</p>
<ul>
<li>
<p>缺点</p>
</li>
<li>
<p>CMS收集器对CPU资源非常敏感。在并发阶段，虽然不会导致用户线程停顿，但是会因为占用了一部分线程使应用程序变慢，总吞吐量会降低，为了解决这种情况，虚拟机提供了一种"增量式并发收集器"(Incremental Concurrent Mark Sweep/i-CMS)的CMS收集器变种，所做对事情就是在并发标记和并发清除的时候让GC线程和用户线程交替运行，尽量减少GC线程独占资源的时间，这样整个垃圾收集的过程会变长，但是对用户程序的影响会减少。（效果不明显，已经不推荐）</p>
</li>
<li>
<p>CMS处理器无法处理浮动垃圾（Floating Garbage）。由于CMS在并发清理阶段有用户线程还在运行这，伴随着程序的运行自然也会产生新的垃圾，这一部分垃圾产生在标记过程之后，CMS无法再当次手机中处理掉它们，所以只有等到下次gc时候再清理掉，这一部分垃圾就称作"浮动垃圾"，因此CMS收集器不能像其它收集器那样等到老年代几乎完全被填满了再进行收集，而是需要预留一部分空间提高并发收集时的程序运作使用。</p>
</li>
<li>
<p>CMS是基于"标记--清除"算法实现的，所以在收集结束的时候会有大量的<code>空间碎片</code>产生。空间碎片太多的时候，将会给大对象的分配带来很大的麻烦，往往会出现老年代还有很大的空间剩余，但是无法找到足够大的连续空间来分配当前对象的，只能提前触发 full gc。</p>
</li>
</ul>
<p>为了解决这个问题，CMS提供了一个开关参数（<code>-XX: UseCMSCompactAtFullCollection</code>），用于在CMS顶不住要进行full gc的时候开启内存碎片的合并整理过程，内存整理的过程是无法并发的，空间碎片没有了，但是停顿的时间变长了。另外一个参数(<code>-XX: CMSFullGCsBeforeCompaction</code>)用于设置执行多少次不压缩的full gc后，跟着来一次带压缩的（默认值为0，表示每次进入full gc时都进行碎片整理）</p>
<h2 id="g1garbage-first">G1(Garbage First)</h2>
<h3 id="_10">参考学习文档</h3>
<p>参考学习1: <a target='_blank' href='https://tech.meituan.com/2016/09/23/g1.html'>美团技术文章</a></p>
<p>参考学习2: <a target='_blank' href='https://www.oracle.com/technetwork/tutorials/tutorials-1876574.html'>oracle g1 document</a></p>
<p>参考学习3: <a target='_blank' href='https://blogs.oracle.com/poonam/understanding-g1-gc-logs'>g1 log</a></p>
<h3 id="g1">G1 内存区域分布图和概念介绍</h3>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/java_jvm/imgs/g1.png" /></p>
<ul>
<li>Humongous区域：如果一个对象占用的空间超过了分区容量(<code>region size</code>)50%以上，G1收集器就认为这是一个巨型对象。这些巨型对象，默认直接会被分配在老年代</li>
</ul>
<p>When performing garbage collections, G1 operates in a manner similar to the CMS collector. G1 performs a concurrent global marking phase to determine the liveness of objects throughout the heap. After the mark phase completes, G1 knows which regions are mostly empty. It collects in these regions first, which usually yields a large amount of free space. This is why this method of garbage collection is called Garbage-First.</p>
<h3 id="g1_1">G1 常用参数</h3>
<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>-XX:G1HeapRegionSize=n</td>
<td>设置Region大小，并非最终值</td>
</tr>
<tr>
<td>-XX:MaxGCPauseMillis</td>
<td>设置G1收集过程目标时间，默认值200ms，不是硬性条件</td>
</tr>
<tr>
<td>-XX:G1NewSizePercent</td>
<td>新生代最小值，默认值5%</td>
</tr>
<tr>
<td>-XX:G1MaxNewSizePercent</td>
<td>新生代最大值，默认值60%</td>
</tr>
<tr>
<td>-XX:ParallelGCThreads</td>
<td>STW期间，并行GC线程数</td>
</tr>
<tr>
<td>-XX:ConcGCThreads=n</td>
<td>并发标记阶段，并行执行的线程数</td>
</tr>
<tr>
<td>-XX:InitiatingHeapOccupancyPercent</td>
<td>设置触发标记周期的 Java 堆占用率阈值。默认值是45%。这里的java堆占比指的是non_young_capacity_bytes，包括old+humongous</td>
</tr>
</tbody>
</table>
<ul>
<li>如下一个线上配置(机器<code>2C4G</code>)例子：</li>
</ul>
<div class="hlcode"><pre><span class="o">-</span><span class="n">Xms2700M</span> <span class="o">-</span><span class="n">Xmx2700M</span> <span class="o">-</span><span class="n">Xss512K</span> <span class="o">-</span><span class="nl">XX:</span><span class="n">MaxDirectMemorySize</span><span class="o">=</span><span class="mi">512</span><span class="n">M</span>

<span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="n">UseG1GC</span> <span class="o">-</span><span class="nl">XX:</span><span class="n">MaxGCPauseMillis</span><span class="o">=</span><span class="mi">200</span> <span class="o">-</span><span class="nl">XX:</span><span class="n">ParallelGCThreads</span><span class="o">=</span><span class="mi">4</span> <span class="o">-</span><span class="nl">XX:</span><span class="n">ConcGCThreads</span><span class="o">=</span><span class="mi">2</span> <span class="o">-</span><span class="nl">XX:</span><span class="n">InitiatingHeapOccupancyPercent</span><span class="o">=</span><span class="mi">70</span> <span class="o">-</span><span class="nl">XX:</span><span class="n">MaxMetaspaceSize</span><span class="o">=</span><span class="mi">500</span><span class="n">m</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="n">PrintGCDetails</span>
</pre></div>


<h3 id="g1gc">G1的gc运作</h3>
<p>G1不提供<code>Full GC</code>,G1的GC包括<code>young gc</code>和<code>mixed GC</code></p>
<p><strong>Note:</strong> G1 has both concurrent (runs along with application threads, e.g., refinement, marking, cleanup) and parallel (multi-threaded, e.g., stop the world) phases. Full garbage collections are still single threaded, but if tuned properly your applications should avoid full GCs.</p>
<h4 id="young-gcgc">young gc(对年轻代的GC)</h4>
<p>Live objects are evacuated to one or more survivor regions. If the aging threshold is met, some of the objects are promoted to old generation regions.</p>
<p>（存活的对象会进入survivor区域，如果达到aging阈值则进入到老年代）</p>
<p>This is a stop the world (STW) pause. Eden size and survivor size is calculated for the next young GC. Accounting information is kept to help calculate the size. Things like the pause time goal are taken into consideration.</p>
<p>This approach makes it very easy to resize regions, making them bigger or smaller as needed.</p>
<p>（这是一个stop the world的停顿,<code>eden</code>和<code>survivor</code>区域会重新计算分配，停顿时间是要考虑到的）</p>
<h4 id="gc">对老年代的GC</h4>
<table>
<thead>
<tr>
<th>Phase</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>(1) Initial Mark (Stop the World Event)</td>
<td>This is a stop the world event. With G1, it is piggybacked on a normal young GC. Mark survivor regions (root regions) which may have references to objects in old generation.</td>
</tr>
<tr>
<td>(2) Root Region Scanning</td>
<td>Scan survivor regions for references into the old generation. This happens while the application continues to run. The phase must be completed before a young GC can occur.</td>
</tr>
<tr>
<td>(3) Concurrent Marking</td>
<td>Find live objects over the entire heap. This happens while the application is running. This phase can be interrupted by young generation garbage collections.</td>
</tr>
<tr>
<td>(4) Remark(Stop the World Event)</td>
<td>Completes the marking of live object in the heap. Uses an algorithm called snapshot-at-the-beginning (SATB) which is much faster than what was used in the CMS collector.</td>
</tr>
<tr>
<td>(5) Cleanup(Stop the World Event and Concurrent)</td>
<td>* Performs accounting on live objects and completely free regions. (Stop the world); * Scrubs the Remembered Sets. (Stop the world); * Reset the empty regions and return them to the free list. (Concurrent)</td>
</tr>
<tr>
<td>(*) Copying</td>
<td>(Stop the World Event) These are the stop the world pauses to evacuate or copy live objects to new unused regions. This can be done with young generation regions which are logged as [GC pause (young)]. Or both young and old generation regions which are logged as [GC Pause (mixed)].</td>
</tr>
</tbody>
</table>
<h5 id="initial-marking-phase">Initial Marking Phase</h5>
<p>Initial marking of live object is piggybacked on a young generation garbage collection.(标记存活对象)</p>
<p>gc log: <code>(young) (initial-mark)</code></p>
<h5 id="concurrent-marking-phase">Concurrent Marking Phase</h5>
<p>If empty regions are found (as denoted by the "X"), they are removed immediately in the Remark phase. Also, "accounting" information that determines liveness is calculated.<br />
（空区域会立刻被标记，这个阶段会计算存活对象）</p>
<h5 id="remark-phase">Remark Phase</h5>
<p>Empty regions are removed and reclaimed. Region liveness is now calculated for all regions.<br />
（空区域会被删除可以让重新分配，所有区域的liveness会计算）</p>
<h5 id="copyingcleanup-phase">Copying/Cleanup Phase</h5>
<p>G1 selects the regions with the lowest "liveness", those regions which can be collected the fastest. Then those regions are collected at the same time as a young GC. This is denoted in the logs as [GC pause (mixed)]. So both young and old generations are collected at the same time.</p>
<p>（the lowest "liveness"有限被清理调）</p>
<p>（<code>yong gc</code>和<code>mixed gc</code>会同时进行）</p>
<p>gc log: <code>GC pause (mixed)</code></p>
<h4 id="gc_1">对年轻代和老年代GC的总结</h4>
<ul>
<li>
<p>对年轻代的GC</p>
</li>
<li>
<p>young gc需要stop the world</p>
</li>
<li>young gc是多线程并行处理的</li>
<li>
<p>eden会到达<code>survivor</code>或者<code>old</code> generation regions</p>
</li>
<li>
<p>对老年代的GC</p>
</li>
<li>
<p>Concurrent Marking Phase</p>
<ul>
<li>Liveness information is calculated concurrently while the application is running.</li>
<li>This liveness information identifies which regions will be best to reclaim during an evacuation pause.</li>
<li>There is no sweeping phase like in CMS.</li>
</ul>
</li>
<li>Remark Phase<ul>
<li>Uses the Snapshot-at-the-Beginning (SATB) algorithm which is much faster then what was used with CMS.</li>
<li>Completely empty regions are reclaimed.(完全空的regions会立刻被会收掉)</li>
</ul>
</li>
<li>Copying/Cleanup Phase<ul>
<li>Young generation and old generation are reclaimed at the same time.（年轻代和老年代会同时被回收）</li>
<li>Old generation regions are selected based on their liveness.</li>
</ul>
</li>
</ul>
<h2 id="_11">内存分配与回收策略(理论基础)</h2>
<h3 id="eden">对象优先在Eden分配</h3>
<p>大多数情况下，对象在新生代Eden区中分配。当Eden区没有足够空间进行分配是，虚拟机将发起一次<code>Minor GC</code>。（<code>-XX:+PrintGCDetails</code>）</p>
<h4 id="minor-gcyong-gc">minor gc(yong gc)</h4>
<p>新生代GC(<code>Minor GC</code>): 指发生在新生代的垃圾收集动作，因为Java对象大多数都具备朝生夕灭的性质，所以<code>Minor GC</code>非常频繁，一般回收速度也比较快</p>
<p>新创建的对象都是用新生代分配内存，<code>Eden</code>空间不足时，触发<code>Minor GC</code>，这时会把存活的对象转移进Survivor区。</p>
<p>新生代通常存活时间较短基于Copying算法进行回收，所谓Copying算法就是扫描出存活的对象，并复制到一块新的完全未使用的空间中，对应于新生代，就是在<code>Eden</code>和<code>From Space</code>或<code>To Space</code>之间copy。新生代采用空闲指针的方式来控制GC触发，指针保持最后一个分配的对象在新生代区间的位置，当有新的对象要分配内存时，用于检查空间是否足够，不够就触发GC。当连续分配对象时，对象会逐渐从Eden到Survivor，最后到老年代。</p>
<h4 id="major-gc-full-gc">major gc/ full gc</h4>
<p>老年代GC(Major GC/Full GC): 指发生在老年代的GC,出现了<code>Major GC</code>, 经常会伴随至少一次的<code>Minor GC</code>(但非绝对的，在Parallel Scavenge收集器的收集策略里就有直接进行<code>Major GC</code>的策略选择过程)。Major GC的速度一般会比Minor GC慢10倍以上</p>
<p>老年代用于存放经过多次Minor GC之后依然存活的对象。</p>
<p>老年代与新生代不同，老年代对象存活的时间比较长、比较稳定，因此采用标记(Mark)算法来进行回收，所谓标记就是扫描出存活的对象，然后再进行回收未被标记的对象，回收后对用空出的空间要么进行合并、要么标记出来便于下次进行分配，总之目的就是要减少内存碎片带来的效率损耗。</p>
<ul>
<li>-Xms 默认情况下堆内存的64分之一</li>
<li>-Xmx 默认情况下堆内存的4分之一</li>
<li>-Xmn 默认情况下堆内存的64分之一， 新生代大小，该配置优先于-XX:NewRatio，即如果配置了-Xmn，-XX:NewRatio会失效。</li>
<li>-XXNewRatio 默认为2</li>
<li>-XX:SurvivorRatio 默认为8，表示Suvivor:eden=2:8,即一个Survivor占年轻代的1/10</li>
</ul>
<h4 id="java-gc-java7-cms">Java GC测试程序 和 初始堆情况(Java7 CMS)</h4>
<ul>
<li>jdk1.7.0_80</li>
</ul>
<div class="hlcode"><pre><span class="cm">/*</span>
<span class="cm"> * -verbose:gc -Xms20M -Xmx20M -Xmn10M  -XX:+PrintGCDetails -XX:SurvivorRatio=8</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainTest</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">_1MB</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">alloc1</span><span class="o">,</span> <span class="n">alloc2</span><span class="o">,</span> <span class="n">alloc3</span><span class="o">,</span> <span class="n">alloc4</span><span class="o">;</span>
        <span class="n">alloc1</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">_1MB</span><span class="o">];</span>
        <span class="n">alloc2</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">_1MB</span><span class="o">];</span>
        <span class="n">alloc3</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">_1MB</span><span class="o">];</span>
        <span class="c1">// 出现 GC</span>
        <span class="n">alloc4</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">3</span> <span class="o">*</span> <span class="n">_1MB</span><span class="o">];</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<div class="hlcode"><pre><span class="o">-</span><span class="nx">verbose</span><span class="o">:</span><span class="nx">gc</span> <span class="o">-</span><span class="nx">Xms20M</span> <span class="o">-</span><span class="nx">Xmx20M</span> <span class="o">-</span><span class="nx">Xmn10M</span> <span class="o">-</span><span class="nx">XX</span><span class="o">:+</span><span class="nx">PrintGCDetails</span> <span class="o">-</span><span class="nx">XX</span><span class="o">:</span><span class="nx">SurvivorRatio</span><span class="o">=</span><span class="mi">8</span>
</pre></div>


<table>
<thead>
<tr>
<th>eden</th>
<th>from survivor</th>
<th>to survivor</th>
<th>old</th>
</tr>
</thead>
<tbody>
<tr>
<td>8192K</td>
<td>1024K</td>
<td>1024K</td>
<td>10240K</td>
</tr>
</tbody>
</table>
<h5 id="gc_2">对应GC日志</h5>
<div class="hlcode"><pre><span class="p">[</span>GC <span class="p">[</span>PSYoungGen<span class="o">:</span> <span class="m">7534</span>K<span class="o">-&gt;</span><span class="m">416</span>K<span class="p">(</span><span class="m">9216</span>K<span class="p">)]</span> <span class="m">7534</span>K<span class="o">-&gt;</span><span class="m">6560</span>K<span class="p">(</span><span class="m">19456</span>K<span class="p">),</span> <span class="m">0.0049590</span> secs<span class="p">]</span> <span class="p">[</span>Times<span class="o">:</span> user<span class="o">=</span><span class="m">0.01</span> sys<span class="o">=</span><span class="m">0.00</span><span class="p">,</span> real<span class="o">=</span><span class="m">0.01</span> secs<span class="p">]</span>
<span class="p">[</span>Full GC <span class="p">[</span>PSYoungGen<span class="o">:</span> <span class="m">416</span>K<span class="o">-&gt;</span><span class="m">0</span>K<span class="p">(</span><span class="m">9216</span>K<span class="p">)]</span> <span class="p">[</span>ParOldGen<span class="o">:</span> <span class="m">6144</span>K<span class="o">-&gt;</span><span class="m">6466</span>K<span class="p">(</span><span class="m">10240</span>K<span class="p">)]</span> <span class="m">6560</span>K<span class="o">-&gt;</span><span class="m">6466</span>K<span class="p">(</span><span class="m">19456</span>K<span class="p">)</span> <span class="p">[</span>PSPermGen<span class="o">:</span> <span class="m">3121</span>K<span class="o">-&gt;</span><span class="m">3120</span>K<span class="p">(</span><span class="m">21504</span>K<span class="p">)],</span> <span class="m">0.0103590</span> secs<span class="p">]</span> <span class="p">[</span>Times<span class="o">:</span> user<span class="o">=</span><span class="m">0.02</span> sys<span class="o">=</span><span class="m">0.00</span><span class="p">,</span> real<span class="o">=</span><span class="m">0.01</span> secs<span class="p">]</span>
Heap
 PSYoungGen      total <span class="m">9216</span>K<span class="p">,</span> used <span class="m">3403</span>K <span class="p">[</span><span class="mh">0x00000007ff600000</span><span class="p">,</span> <span class="mh">0x0000000800000000</span><span class="p">,</span> <span class="mh">0x0000000800000000</span><span class="p">)</span>
  eden space <span class="m">8192</span>K<span class="p">,</span> <span class="m">41</span><span class="o">% used [0x00000007ff600000,0x00000007ff952de0,0x00000007ffe00000)</span>
<span class="o">  from space 1024K, 0%</span> used <span class="p">[</span><span class="mh">0x00000007ffe00000</span><span class="p">,</span><span class="mh">0x00000007ffe00000</span><span class="p">,</span><span class="mh">0x00000007fff00000</span><span class="p">)</span>
  to   space <span class="m">1024</span>K<span class="p">,</span> <span class="m">0</span><span class="o">% used [0x00000007fff00000,0x00000007fff00000,0x0000000800000000)</span>
<span class="o"> ParOldGen       total 10240K, used 6466K [0x00000007fec00000, 0x00000007ff600000, 0x00000007ff600000)</span>
<span class="o">  object space 10240K, 63%</span> used <span class="p">[</span><span class="mh">0x00000007fec00000</span><span class="p">,</span><span class="mh">0x00000007ff250b48</span><span class="p">,</span><span class="mh">0x00000007ff600000</span><span class="p">)</span>
 PSPermGen       total <span class="m">21504</span>K<span class="p">,</span> used <span class="m">3142</span>K <span class="p">[</span><span class="mh">0x00000007f9a00000</span><span class="p">,</span> <span class="mh">0x00000007faf00000</span><span class="p">,</span> <span class="mh">0x00000007fec00000</span><span class="p">)</span>
  object space <span class="m">21504</span>K<span class="p">,</span> <span class="m">14</span>% used <span class="p">[</span><span class="mh">0x00000007f9a00000</span><span class="p">,</span><span class="mh">0x00000007f9d118a0</span><span class="p">,</span><span class="mh">0x00000007faf00000</span><span class="p">)</span>
</pre></div>


<ul>
<li>gc过程</li>
</ul>
<table>
<thead>
<tr>
<th>状态</th>
<th>eden</th>
<th>from survivor</th>
<th>to survivor</th>
<th>old</th>
</tr>
</thead>
<tbody>
<tr>
<td>初始状态总大小</td>
<td>8192K</td>
<td>1024K</td>
<td>1024K</td>
<td>10240K</td>
</tr>
<tr>
<td>分配了alloc1,2,3</td>
<td>使用了6144K</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>接着需要分配alloc4，需要3M,不够用，GC</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>内存重新分配</td>
<td>3M存alloc4</td>
<td>-</td>
<td>-</td>
<td>old使用了6M用来存alloc1,2,3</td>
</tr>
<tr>
<td>最后使用占比</td>
<td>37%多</td>
<td>0%</td>
<td>0%</td>
<td>60%多</td>
</tr>
</tbody>
</table>
<h4 id="_12">参考</h4>
<p>JVM GC log文件的查看<a target='_blank' href='https://www.cnblogs.com/xuezhiyizu1120/p/6237510.html'>参考博文链接</a></p>
<ul>
<li>[PSYoungGen: 7698K-&gt;448K(9216K)]<ol>
<li>PSYoungGen 新生代/</li>
<li>GC前该内存区域已使用容量 -&gt; GC后该内存区域已使用容量(该内存区域的总容量)。</li>
</ol>
</li>
<li>7698K-&gt;6592K(19456K)<ol>
<li>GC前Java堆已使用容量 -&gt; GC后Java堆已使用容量（Java堆总容量）。</li>
</ol>
</li>
</ul>
<h3 id="_13">大对象直接进入老年代</h3>
<p>这里所谓的大对象是指，需要大量连续内存空间的Java对象，，最典型的大对象就是那种很长的字符串以及数组。大对象对虚拟机的内存分配来说就是一个坏消息。（更坏的：一群"朝生夕灭"的"短命大对象"），经常出现大对象容易导致内存还有不少空间时就提前触发垃圾收集以获取足够的连续空间来"安置"它们</p>
<p><code>-XX:PretenureSizeThreshold</code>参数，另大于这个设置值的对象直接在老年代分配。这样做的目的是避免在Eden区以及两个Survivor区之间发生大量的内存复制(复习一下：新生代采用复制算法收集内存)</p>
<h3 id="_14">长期存活的对象将进入老年代</h3>
<p>内存回收时，必须识别哪些对象应该在新生代，哪些对象应放到老年代。</p>
<p>虚拟机给每个对象定义了一个对象年龄(<code>Age</code>)计数器。如果对象在<code>Eden</code>出生并经历过第一次<code>Minor GC</code>后仍然存活，并且能被<code>Survivor</code>容纳的话，将被移动到<code>Survivor</code>空间,并且对象的年龄为1.对象在<code>Survivor</code>区中每"熬过"一次<code>Minor GC</code>，年龄就增加1岁，当他的年龄增加到一定程度（默认15岁），就将会被晋升到老年代中。对象晋升老年代的年龄阈值，可以通过参数<code>-XX:MaxTenuringThreshold</code>设置</p>
<h3 id="_15">动态对象的年龄判定</h3>
<p>为了更好地适应不同程序的内存状况，虚拟机并不是永远地要求对象的年龄必须达到了<code>MaxTenuringThreshold</code>才能晋升老年代，如果在<code>Survivor</code>空间中相同年龄所有对象大小的总和大于<code>Survivor</code>空间的一半，年龄大于或等于该年龄对象就可以直接进入老年代，无须等到<code>MaxTenuringThreshold</code>要求的年龄。</p>
<h3 id="_16">空间分配担保</h3>
<p>老年代最大可用的连续空间 &gt; 新生代所有对象总空间, 这样能确保<code>Minor GC</code>是安全的。</p>
<p>如果不成立，虚拟机会查看<code>HandlerPromotionFailure</code>设置值是否允许担保失败。如果允许，那么会继续检查老年代最大可用的连续空间是否大于历次晋升到老年代对象的平均大小</p>
<p>如果大于，将尝试着进行一次<code>Minor GC</code>,尽管这次的<code>Minor GC</code>是有风险的</p>
<p>如果小于，或者<code>HandlerPromotionFailure</code>设置值不允许担保失败，这时改为进行一次<code>Full GC</code></p>
<h3 id="gc_3">触发gc的条件</h3>
<p>“什么时候”即就是GC触发的条件。GC触发的条件有两种。（1）程序调用System.gc时可以触发；（2）系统自身来决定GC触发的时机。</p>
<h4 id="minor-gc">Minor GC触发条件</h4>
<ul>
<li>当<code>Eden</code>区满时，触发<code>Minor GC</code></li>
</ul>
<h4 id="full-gc">Full GC触发条件</h4>
<ul>
<li>
<p>（1）调用System.gc时，系统建议执行Full GC，但是不必然执行</p>
</li>
<li>
<p>（2）老年代空间不足</p>
</li>
<li>
<p>（3）方法区空间不足</p>
</li>
<li>
<p>（4）通过Minor GC后进入老年代的平均大小大于老年代的可用内存</p>
</li>
<li>
<p>（5）由Eden区、From Space区向To Space区复制时，对象大小大于To Space可用内存，则把该对象转存到老年代，且老年代的可用内存小于该对象大小</p>
</li>
</ul>
<h2 id="g1-cms">G1 和 CMS</h2>
<p>参考1: http://www.woowen.com/java/2016/12/10/G1%20CMS%E5%8C%BA%E5%88%AB/</p>
<p>参考2: https://www.jianshu.com/p/35cd012eeb8c</p>
<ol>
<li>
<p>G1 和 CMS 堆空间分配不同</p>
</li>
<li>
<p><code>CMS</code>将堆逻辑上分成<code>Eden</code>,<code>Survivor(S0,S1)</code>,<code>Old</code>；并且他们是固定大小JVM启动的时候就已经设定不能改变,并且是连续的内存块</p>
</li>
<li>
<p><code>G1</code>将堆分成多个大小相同的<code>Region(区域)</code>,默认2048个,在1Mb到32Mb之间大小,逻辑上分成<code>Eden</code>,<code>Survivor</code>,<code>Old</code>,<code>Humongous</code>(巨型),<code>空闲</code>；他们不是固定大小,会根据每次GC的信息做出调整</p>
</li>
<li>
<p>G1 和 CMS GC的区别</p>
</li>
</ol>
<p>CMS的Young GC就是依赖并行GC(ParNew)去完成的.只有老年代中使用CMS GC(也就是Old GC)</p>
<p>CMS 使用<strong>分代回收</strong>,堆被分成了年轻代和老年代,其中年轻代回收依赖ParNew去回收,需要STW(<code>Stop The World</code>)</p>
<p>G1中提供了三种模式垃圾回收模式，young gc、mixed gc 和 full gc，在不同的条件下被触发。</p>
<ul>
<li>young gc</li>
</ul>
<p>发生在年轻代的GC算法，一般对象（除了巨型对象）都是在eden region中分配内存，当所有eden region被耗尽无法申请内存时，就会触发一次young gc，这种触发机制和之前的young gc差不多，执行完一次young gc，活跃对象会被拷贝到survivor region或者晋升到old region中，空闲的region会被放入空闲列表中，等待下次被使用。</p>
<ul>
<li>mixed gc</li>
</ul>
<p>当越来越多的对象晋升到老年代old region时，为了避免堆内存被耗尽，虚拟机会触发一个混合的垃圾收集器，即mixed gc，该算法并不是一个old gc，除了回收整个young region，还会回收一部分的old region，这里需要注意：是一部分老年代，而不是全部老年代，可以选择哪些old region进行收集，从而可以对垃圾回收的耗时时间进行控制</p>
<ul>
<li>full gc</li>
</ul>
<p>如果对象内存分配速度过快，mixed gc来不及回收，导致老年代被填满，就会触发一次full gc，G1的full gc算法就是单线程执行的<code>serial old gc</code>，会导致异常长时间的暂停时间，需要进行不断的调优，尽可能的避免full gc</p>
<p><strong>yong gc log</strong></p>
<div class="hlcode"><pre><span class="o">[</span><span class="n">GC</span> <span class="n">pause</span> <span class="o">(</span><span class="n">G1</span> <span class="n">Evacuation</span> <span class="n">Pause</span><span class="o">)</span> <span class="o">(</span><span class="n">young</span><span class="o">),</span> <span class="mf">0.0707344</span> <span class="n">secs</span><span class="o">]</span>
   <span class="o">[</span><span class="n">Parallel</span> <span class="nl">Time:</span> <span class="mf">68.6</span> <span class="n">ms</span><span class="o">,</span> <span class="n">GC</span> <span class="nl">Workers:</span> <span class="mi">2</span><span class="o">]</span>
      <span class="o">[</span><span class="n">GC</span> <span class="n">Worker</span> <span class="n">Start</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">4044130.9</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">4044130.9</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">4044131.0</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.0</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Ext</span> <span class="n">Root</span> <span class="n">Scanning</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">3.1</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">3.3</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">3.5</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.5</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mf">6.6</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Update</span> <span class="n">RS</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">2.2</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">2.2</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">2.2</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mf">4.4</span><span class="o">]</span>
         <span class="o">[</span><span class="n">Processed</span> <span class="nl">Buffers:</span> <span class="nl">Min:</span> <span class="mi">77</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">111.5</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mi">146</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mi">69</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mi">223</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Scan</span> <span class="n">RS</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">0.4</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">0.4</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">0.4</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mf">0.7</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Code</span> <span class="n">Root</span> <span class="n">Scanning</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">0.5</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">1.0</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">1.0</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mf">1.0</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Object</span> <span class="n">Copy</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">61.4</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">62.1</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">62.8</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">1.4</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mf">124.1</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Termination</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mf">0.0</span><span class="o">]</span>
         <span class="o">[</span><span class="n">Termination</span> <span class="nl">Attempts:</span> <span class="nl">Min:</span> <span class="mi">1</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">1.0</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mi">1</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mi">0</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mi">2</span><span class="o">]</span>
      <span class="o">[</span><span class="n">GC</span> <span class="n">Worker</span> <span class="n">Other</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mf">0.1</span><span class="o">]</span>
      <span class="o">[</span><span class="n">GC</span> <span class="n">Worker</span> <span class="n">Total</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">68.5</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">68.5</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">68.5</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mf">137.0</span><span class="o">]</span>
      <span class="o">[</span><span class="n">GC</span> <span class="n">Worker</span> <span class="n">End</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">4044199.4</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">4044199.4</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">4044199.4</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.0</span><span class="o">]</span>
   <span class="o">[</span><span class="n">Code</span> <span class="n">Root</span> <span class="nl">Fixup:</span> <span class="mf">0.0</span> <span class="n">ms</span><span class="o">]</span>
   <span class="o">[</span><span class="n">Code</span> <span class="n">Root</span> <span class="nl">Purge:</span> <span class="mf">0.0</span> <span class="n">ms</span><span class="o">]</span>
   <span class="o">[</span><span class="n">Clear</span> <span class="nl">CT:</span> <span class="mf">0.4</span> <span class="n">ms</span><span class="o">]</span>
   <span class="o">[</span><span class="nl">Other:</span> <span class="mf">1.7</span> <span class="n">ms</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Choose</span> <span class="nl">CSet:</span> <span class="mf">0.0</span> <span class="n">ms</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Ref</span> <span class="nl">Proc:</span> <span class="mf">0.1</span> <span class="n">ms</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Ref</span> <span class="nl">Enq:</span> <span class="mf">0.0</span> <span class="n">ms</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Redirty</span> <span class="nl">Cards:</span> <span class="mf">0.1</span> <span class="n">ms</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Humongous</span> <span class="nl">Register:</span> <span class="mf">0.1</span> <span class="n">ms</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Humongous</span> <span class="nl">Reclaim:</span> <span class="mf">0.0</span> <span class="n">ms</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Free</span> <span class="nl">CSet:</span> <span class="mf">0.7</span> <span class="n">ms</span><span class="o">]</span>
   <span class="o">[</span><span class="nl">Eden:</span> <span class="mf">1160.0</span><span class="n">M</span><span class="o">(</span><span class="mf">1160.0</span><span class="n">M</span><span class="o">)-&gt;</span><span class="mf">0.0</span><span class="n">B</span><span class="o">(</span><span class="mf">1153.0</span><span class="n">M</span><span class="o">)</span> <span class="nl">Survivors:</span> <span class="mf">68.0</span><span class="n">M</span><span class="o">-&gt;</span><span class="mf">75.0</span><span class="n">M</span> <span class="nl">Heap:</span> <span class="mf">1551.2</span><span class="n">M</span><span class="o">(</span><span class="mf">2048.0</span><span class="n">M</span><span class="o">)-&gt;</span><span class="mf">398.7</span><span class="n">M</span><span class="o">(</span><span class="mf">2048.0</span><span class="n">M</span><span class="o">)]</span>
 <span class="o">[</span><span class="nl">Times:</span> <span class="n">user</span><span class="o">=</span><span class="mf">0.14</span> <span class="n">sys</span><span class="o">=</span><span class="mf">0.00</span><span class="o">,</span> <span class="n">real</span><span class="o">=</span><span class="mf">0.07</span> <span class="n">secs</span><span class="o">]</span>
</pre></div>


<h2 id="jvmgc">JVM参数与GC</h2>
<table>
<thead>
<tr>
<th>年轻代</th>
<th>老年代</th>
<th>jvm 参数</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>Serial (DefNew)</td>
<td>Serial Old(PSOldGen)</td>
<td>-XX:+UseSerialGC</td>
<td></td>
</tr>
<tr>
<td>Parallel Scavenge (PSYoungGen)</td>
<td>Serial Old(PSOldGen)</td>
<td>-XX:+UseParallelGC</td>
<td></td>
</tr>
<tr>
<td>Parallel Scavenge (PSYoungGen)</td>
<td>Parallel Old (ParOldGen)</td>
<td>-XX:+UseParallelOldGC</td>
<td></td>
</tr>
<tr>
<td>ParNew (ParNew)</td>
<td>Serial Old(PSOldGen)</td>
<td>-XX:-UseParNewGC</td>
<td></td>
</tr>
<tr>
<td>ParNew (ParNew)</td>
<td>CMS+Serial Old(PSOldGen)</td>
<td>-XX:+UseConcMarkSweepGC</td>
<td></td>
</tr>
<tr>
<td>G1</td>
<td>G1</td>
<td>-XX:+UseG1GC</td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="java8-gc">Java8 默认GC</h3>
<ul>
<li>jvm 配置</li>
</ul>
<div class="hlcode"><pre><span class="o">-</span><span class="nl">Xloggc:</span><span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">mubi</span><span class="o">/</span><span class="n">git_workspace</span><span class="o">/</span><span class="n">java8</span><span class="o">/</span><span class="n">gc</span><span class="o">.</span><span class="na">log</span> <span class="o">-</span><span class="nl">verbose:</span><span class="n">gc</span> <span class="o">-</span><span class="n">Xms20M</span> <span class="o">-</span><span class="n">Xmx20M</span> <span class="o">-</span><span class="n">Xmn10M</span> <span class="o">-</span><span class="nl">XX:</span><span class="n">SurvivorRatio</span><span class="o">=</span><span class="mi">8</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="n">PrintGCDetails</span>
</pre></div>


<ul>
<li>java 程序</li>
</ul>
<div class="hlcode"><pre> <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testAllocation</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">a1</span><span class="o">,</span> <span class="n">a2</span><span class="o">,</span> <span class="n">a3</span><span class="o">,</span> <span class="n">a4</span><span class="o">;</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;free:&quot;</span> <span class="o">+</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">freeMemory</span><span class="o">()</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;total:&quot;</span> <span class="o">+</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">totalMemory</span><span class="o">()</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;max:&quot;</span> <span class="o">+</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">maxMemory</span><span class="o">()</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;used:&quot;</span> <span class="o">+</span> <span class="o">(</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">totalMemory</span><span class="o">()</span> <span class="o">-</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">freeMemory</span><span class="o">())</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">);</span>

        <span class="n">a1</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">_1MB</span><span class="o">];</span>

        <span class="n">a2</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">_1MB</span><span class="o">];</span>

        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;free:&quot;</span> <span class="o">+</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">freeMemory</span><span class="o">()</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;total:&quot;</span> <span class="o">+</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">totalMemory</span><span class="o">()</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;max:&quot;</span> <span class="o">+</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">maxMemory</span><span class="o">()</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;used:&quot;</span> <span class="o">+</span> <span class="o">(</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">totalMemory</span><span class="o">()</span> <span class="o">-</span> <span class="n">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">freeMemory</span><span class="o">())</span>
                <span class="o">/</span> <span class="mi">1024</span> <span class="o">/</span> <span class="mi">1024</span><span class="o">);</span>

        <span class="n">a3</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">_1MB</span><span class="o">];</span>

        <span class="n">a4</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">6</span> <span class="o">*</span> <span class="n">_1MB</span><span class="o">];</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span> <span class="o">{</span>
        <span class="n">testAllocation</span><span class="o">();</span>
        <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">30</span><span class="o">);</span>
    <span class="o">}</span>
</pre></div>


<ul>
<li>gc.log 文件</li>
</ul>
<div class="hlcode"><pre><span class="n">Java</span> <span class="nf">HotSpot</span><span class="o">(</span><span class="n">TM</span><span class="o">)</span> <span class="mi">64</span><span class="o">-</span><span class="n">Bit</span> <span class="n">Server</span> <span class="n">VM</span> <span class="o">(</span><span class="mf">25.171</span><span class="o">-</span><span class="n">b11</span><span class="o">)</span> <span class="k">for</span> <span class="n">bsd</span><span class="o">-</span><span class="n">amd64</span> <span class="n">JRE</span> <span class="o">(</span><span class="mf">1.8</span><span class="o">.</span><span class="mi">0</span><span class="n">_171</span><span class="o">-</span><span class="n">b11</span><span class="o">),</span> <span class="n">built</span> <span class="n">on</span> <span class="n">Mar</span> <span class="mi">28</span> <span class="mi">2018</span> <span class="mi">12</span><span class="o">:</span><span class="mi">50</span><span class="o">:</span><span class="mi">57</span> <span class="n">by</span> <span class="s">&quot;java_re&quot;</span> <span class="n">with</span> <span class="n">gcc</span> <span class="mf">4.2</span><span class="o">.</span><span class="mi">1</span> <span class="o">(</span><span class="n">Based</span> <span class="n">on</span> <span class="n">Apple</span> <span class="n">Inc</span><span class="o">.</span> <span class="n">build</span> <span class="mi">5658</span><span class="o">)</span> <span class="o">(</span><span class="n">LLVM</span> <span class="n">build</span> <span class="mf">2336.11</span><span class="o">.</span><span class="mi">00</span><span class="o">)</span>
<span class="nl">Memory:</span> <span class="mi">4</span><span class="n">k</span> <span class="n">page</span><span class="o">,</span> <span class="n">physical</span> <span class="mi">16777216</span><span class="n">k</span><span class="o">(</span><span class="mi">3251600</span><span class="n">k</span> <span class="n">free</span><span class="o">)</span>

<span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="nl">meminfo:</span>

<span class="n">CommandLine</span> <span class="nl">flags:</span> <span class="o">-</span><span class="nl">XX:</span><span class="n">InitialHeapSize</span><span class="o">=</span><span class="mi">20971520</span> <span class="o">-</span><span class="nl">XX:</span><span class="n">MaxHeapSize</span><span class="o">=</span><span class="mi">20971520</span> <span class="o">-</span><span class="nl">XX:</span><span class="n">MaxNewSize</span><span class="o">=</span><span class="mi">10485760</span> <span class="o">-</span><span class="nl">XX:</span><span class="n">NewSize</span><span class="o">=</span><span class="mi">10485760</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="n">PrintGC</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="n">PrintGCDetails</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="n">PrintGCTimeStamps</span> <span class="o">-</span><span class="nl">XX:</span><span class="n">SurvivorRatio</span><span class="o">=</span><span class="mi">8</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="n">UseCompressedClassPointers</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="n">UseCompressedOops</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="n">UseParallelGC</span>
<span class="mf">0.240</span><span class="o">:</span> <span class="o">[</span><span class="n">GC</span> <span class="o">(</span><span class="n">Allocation</span> <span class="n">Failure</span><span class="o">)</span> <span class="o">[</span><span class="nl">PSYoungGen:</span> <span class="mi">6524</span><span class="n">K</span><span class="o">-&gt;</span><span class="mi">706</span><span class="n">K</span><span class="o">(</span><span class="mi">9216</span><span class="n">K</span><span class="o">)]</span> <span class="mi">6524</span><span class="n">K</span><span class="o">-&gt;</span><span class="mi">4810</span><span class="n">K</span><span class="o">(</span><span class="mi">19456</span><span class="n">K</span><span class="o">),</span> <span class="mf">0.0127210</span> <span class="n">secs</span><span class="o">]</span> <span class="o">[</span><span class="nl">Times:</span> <span class="n">user</span><span class="o">=</span><span class="mf">0.01</span> <span class="n">sys</span><span class="o">=</span><span class="mf">0.00</span><span class="o">,</span> <span class="n">real</span><span class="o">=</span><span class="mf">0.02</span> <span class="n">secs</span><span class="o">]</span>
<span class="mf">0.256</span><span class="o">:</span> <span class="o">[</span><span class="n">GC</span> <span class="o">(</span><span class="n">Allocation</span> <span class="n">Failure</span><span class="o">)</span> <span class="o">[</span><span class="nl">PSYoungGen:</span> <span class="mi">2754</span><span class="n">K</span><span class="o">-&gt;</span><span class="mi">690</span><span class="n">K</span><span class="o">(</span><span class="mi">9216</span><span class="n">K</span><span class="o">)]</span> <span class="mi">6858</span><span class="n">K</span><span class="o">-&gt;</span><span class="mi">6850</span><span class="n">K</span><span class="o">(</span><span class="mi">19456</span><span class="n">K</span><span class="o">),</span> <span class="mf">0.0114299</span> <span class="n">secs</span><span class="o">]</span> <span class="o">[</span><span class="nl">Times:</span> <span class="n">user</span><span class="o">=</span><span class="mf">0.00</span> <span class="n">sys</span><span class="o">=</span><span class="mf">0.00</span><span class="o">,</span> <span class="n">real</span><span class="o">=</span><span class="mf">0.01</span> <span class="n">secs</span><span class="o">]</span>
<span class="mf">0.267</span><span class="o">:</span> <span class="o">[</span><span class="n">Full</span> <span class="n">GC</span> <span class="o">(</span><span class="n">Ergonomics</span><span class="o">)</span> <span class="o">[</span><span class="nl">PSYoungGen:</span> <span class="mi">690</span><span class="n">K</span><span class="o">-&gt;</span><span class="mi">0</span><span class="n">K</span><span class="o">(</span><span class="mi">9216</span><span class="n">K</span><span class="o">)]</span> <span class="o">[</span><span class="nl">ParOldGen:</span> <span class="mi">6160</span><span class="n">K</span><span class="o">-&gt;</span><span class="mi">6699</span><span class="n">K</span><span class="o">(</span><span class="mi">10240</span><span class="n">K</span><span class="o">)]</span> <span class="mi">6850</span><span class="n">K</span><span class="o">-&gt;</span><span class="mi">6699</span><span class="n">K</span><span class="o">(</span><span class="mi">19456</span><span class="n">K</span><span class="o">),</span> <span class="o">[</span><span class="nl">Metaspace:</span> <span class="mi">3305</span><span class="n">K</span><span class="o">-&gt;</span><span class="mi">3305</span><span class="n">K</span><span class="o">(</span><span class="mi">1056768</span><span class="n">K</span><span class="o">)],</span> <span class="mf">0.0128112</span> <span class="n">secs</span><span class="o">]</span> <span class="o">[</span><span class="nl">Times:</span> <span class="n">user</span><span class="o">=</span><span class="mf">0.01</span> <span class="n">sys</span><span class="o">=</span><span class="mf">0.00</span><span class="o">,</span> <span class="n">real</span><span class="o">=</span><span class="mf">0.01</span> <span class="n">secs</span><span class="o">]</span>
<span class="n">Heap</span>
 <span class="n">PSYoungGen</span>      <span class="n">total</span> <span class="mi">9216</span><span class="n">K</span><span class="o">,</span> <span class="n">used</span> <span class="mi">6547</span><span class="n">K</span> <span class="o">[</span><span class="mh">0x00000007bf600000</span><span class="o">,</span> <span class="mh">0x00000007c0000000</span><span class="o">,</span> <span class="mh">0x00000007c0000000</span><span class="o">)</span>
  <span class="n">eden</span> <span class="n">space</span> <span class="mi">8192</span><span class="n">K</span><span class="o">,</span> <span class="mi">79</span><span class="o">%</span> <span class="n">used</span> <span class="o">[</span><span class="mh">0x00000007bf600000</span><span class="o">,</span><span class="mh">0x00000007bfc64d10</span><span class="o">,</span><span class="mh">0x00000007bfe00000</span><span class="o">)</span>
  <span class="n">from</span> <span class="n">space</span> <span class="mi">1024</span><span class="n">K</span><span class="o">,</span> <span class="mi">0</span><span class="o">%</span> <span class="n">used</span> <span class="o">[</span><span class="mh">0x00000007bff00000</span><span class="o">,</span><span class="mh">0x00000007bff00000</span><span class="o">,</span><span class="mh">0x00000007c0000000</span><span class="o">)</span>
  <span class="n">to</span>   <span class="n">space</span> <span class="mi">1024</span><span class="n">K</span><span class="o">,</span> <span class="mi">0</span><span class="o">%</span> <span class="n">used</span> <span class="o">[</span><span class="mh">0x00000007bfe00000</span><span class="o">,</span><span class="mh">0x00000007bfe00000</span><span class="o">,</span><span class="mh">0x00000007bff00000</span><span class="o">)</span>
 <span class="n">ParOldGen</span>       <span class="n">total</span> <span class="mi">10240</span><span class="n">K</span><span class="o">,</span> <span class="n">used</span> <span class="mi">6699</span><span class="n">K</span> <span class="o">[</span><span class="mh">0x00000007bec00000</span><span class="o">,</span> <span class="mh">0x00000007bf600000</span><span class="o">,</span> <span class="mh">0x00000007bf600000</span><span class="o">)</span>
  <span class="n">object</span> <span class="n">space</span> <span class="mi">10240</span><span class="n">K</span><span class="o">,</span> <span class="mi">65</span><span class="o">%</span> <span class="n">used</span> <span class="o">[</span><span class="mh">0x00000007bec00000</span><span class="o">,</span><span class="mh">0x00000007bf28afe8</span><span class="o">,</span><span class="mh">0x00000007bf600000</span><span class="o">)</span>
 <span class="n">Metaspace</span>       <span class="n">used</span> <span class="mi">3339</span><span class="n">K</span><span class="o">,</span> <span class="n">capacity</span> <span class="mi">4500</span><span class="n">K</span><span class="o">,</span> <span class="n">committed</span> <span class="mi">4864</span><span class="n">K</span><span class="o">,</span> <span class="n">reserved</span> <span class="mi">1056768</span><span class="n">K</span>
  <span class="kd">class</span> <span class="nc">space</span>    <span class="n">used</span> <span class="mi">371</span><span class="n">K</span><span class="o">,</span> <span class="n">capacity</span> <span class="mi">388</span><span class="n">K</span><span class="o">,</span> <span class="n">committed</span> <span class="mi">512</span><span class="n">K</span><span class="o">,</span> <span class="n">reserved</span> <span class="mi">1048576</span><span class="n">K</span>
</pre></div>


<table>
<thead>
<tr>
<th>gc 类型</th>
<th>方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>yong gc</td>
<td>Parallel Scavenge（PSYoungGen）</td>
</tr>
<tr>
<td>full gc</td>
<td>Parallel Old（ParOldGen）</td>
</tr>
</tbody>
</table>
<h2 id="gc_4">GC收集器及其发展</h2>
<h3 id="serial">(一) Serial 收集器</h3>
<ul>
<li>
<p>是一个单线程的收集器，但是它的"单线程"的意义并不仅仅说明它只会使用<strong>一个CPU</strong>或者<strong>一条收集线程</strong>去完成垃圾收集工作，更重要的是它进行垃圾收集时，<strong>必须暂停其他所有的工作线程，直到收集结束</strong>即<code>Stop The World</code></p>
</li>
<li>
<p>标记，清除</p>
</li>
</ul>
<h3 id="parallel-scavenge">(二) Parallel Scavenge 收集器</h3>
<p>使用复制算法的<strong>并行多线程收集器</strong>。Parallel Scavenge是Java1.8默认的收集器，特点是并行的多线程回收，以吞吐量（CPU用于运行用户代码的时间与CPU总消耗时间的比值，吞吐量=运行用户代码时间/(运行用户代码时间+垃圾收集时间)）优先</p>
<p>停顿时间越短就越适合需要与用户交互的程序，良好的响应速度能提升用户体验，而高吞吐量则可以高效率地利用CPU时间，尽快完成程序的运算任务，主要适合在后台运算而不需要太多交互的任务</p>
<h3 id="parnew">(二) ParNew 收集器</h3>
<p>是Serial收集器的多线程版本，除了使用多条线程进行垃圾收集外，其余与Serial收集器完全一样</p>
<h3 id="cms">(三) CMS收集器</h3>
<p>CMS收集器在Minor GC时会暂停所有的应用线程，并以多线程的方式进行垃圾回收。在Full GC时不再暂停应用线程，而是使用若干个后台线程定期的对老年代空间进行扫描，及时回收其中不再使用的对象</p>
<h3 id="g1_2">(四) G1</h3>
<p>G1收集器（或者垃圾优先收集器）的设计初衷是为了尽量缩短处理超大堆（大于4GB）时产生的停顿。相对于CMS的优势而言是内存碎片的产生率大大降低</p>
<div class="hlcode"><pre><span class="n">Java</span> <span class="nf">HotSpot</span><span class="o">(</span><span class="n">TM</span><span class="o">)</span> <span class="mi">64</span><span class="o">-</span><span class="n">Bit</span> <span class="n">Server</span> <span class="n">VM</span> <span class="o">(</span><span class="mf">25.171</span><span class="o">-</span><span class="n">b11</span><span class="o">)</span> <span class="k">for</span> <span class="n">bsd</span><span class="o">-</span><span class="n">amd64</span> <span class="n">JRE</span> <span class="o">(</span><span class="mf">1.8</span><span class="o">.</span><span class="mi">0</span><span class="n">_171</span><span class="o">-</span><span class="n">b11</span><span class="o">),</span> <span class="n">built</span> <span class="n">on</span> <span class="n">Mar</span> <span class="mi">28</span> <span class="mi">2018</span> <span class="mi">12</span><span class="o">:</span><span class="mi">50</span><span class="o">:</span><span class="mi">57</span> <span class="n">by</span> <span class="s">&quot;java_re&quot;</span> <span class="n">with</span> <span class="n">gcc</span> <span class="mf">4.2</span><span class="o">.</span><span class="mi">1</span> <span class="o">(</span><span class="n">Based</span> <span class="n">on</span> <span class="n">Apple</span> <span class="n">Inc</span><span class="o">.</span> <span class="n">build</span> <span class="mi">5658</span><span class="o">)</span> <span class="o">(</span><span class="n">LLVM</span> <span class="n">build</span> <span class="mf">2336.11</span><span class="o">.</span><span class="mi">00</span><span class="o">)</span>
<span class="nl">Memory:</span> <span class="mi">4</span><span class="n">k</span> <span class="n">page</span><span class="o">,</span> <span class="n">physical</span> <span class="mi">16777216</span><span class="n">k</span><span class="o">(</span><span class="mi">1978920</span><span class="n">k</span> <span class="n">free</span><span class="o">)</span>

<span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="nl">meminfo:</span>

<span class="n">CommandLine</span> <span class="nl">flags:</span> <span class="o">-</span><span class="nl">XX:</span><span class="n">InitialHeapSize</span><span class="o">=</span><span class="mi">20971520</span> <span class="o">-</span><span class="nl">XX:</span><span class="n">MaxHeapSize</span><span class="o">=</span><span class="mi">20971520</span> <span class="o">-</span><span class="nl">XX:</span><span class="n">MaxNewSize</span><span class="o">=</span><span class="mi">10485760</span> <span class="o">-</span><span class="nl">XX:</span><span class="n">NewSize</span><span class="o">=</span><span class="mi">10485760</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="n">PrintGC</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="n">PrintGCDetails</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="n">PrintGCTimeStamps</span> <span class="o">-</span><span class="nl">XX:</span><span class="n">SurvivorRatio</span><span class="o">=</span><span class="mi">8</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="n">UseCompressedClassPointers</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="n">UseCompressedOops</span> <span class="o">-</span><span class="nl">XX:</span><span class="o">+</span><span class="n">UseG1GC</span>
<span class="mf">0.196</span><span class="o">:</span> <span class="o">[</span><span class="n">GC</span> <span class="n">pause</span> <span class="o">(</span><span class="n">G1</span> <span class="n">Humongous</span> <span class="n">Allocation</span><span class="o">)</span> <span class="o">(</span><span class="n">young</span><span class="o">)</span> <span class="o">(</span><span class="n">initial</span><span class="o">-</span><span class="n">mark</span><span class="o">),</span> <span class="mf">0.0022978</span> <span class="n">secs</span><span class="o">]</span>
   <span class="o">[</span><span class="n">Parallel</span> <span class="nl">Time:</span> <span class="mf">2.0</span> <span class="n">ms</span><span class="o">,</span> <span class="n">GC</span> <span class="nl">Workers:</span> <span class="mi">4</span><span class="o">]</span>
      <span class="o">[</span><span class="n">GC</span> <span class="n">Worker</span> <span class="n">Start</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">196.2</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">196.2</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">196.3</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.0</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Ext</span> <span class="n">Root</span> <span class="n">Scanning</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">0.6</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">0.6</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">0.6</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mf">2.4</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Update</span> <span class="n">RS</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mf">0.0</span><span class="o">]</span>
         <span class="o">[</span><span class="n">Processed</span> <span class="nl">Buffers:</span> <span class="nl">Min:</span> <span class="mi">0</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mi">0</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mi">0</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mi">0</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Scan</span> <span class="n">RS</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mf">0.0</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Code</span> <span class="n">Root</span> <span class="n">Scanning</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mf">0.0</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Object</span> <span class="n">Copy</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">0.8</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">1.1</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">1.3</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.5</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mf">4.3</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Termination</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">0.3</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">0.5</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.5</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mf">1.1</span><span class="o">]</span>
         <span class="o">[</span><span class="n">Termination</span> <span class="nl">Attempts:</span> <span class="nl">Min:</span> <span class="mi">1</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">1.2</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mi">2</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mi">1</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mi">5</span><span class="o">]</span>
      <span class="o">[</span><span class="n">GC</span> <span class="n">Worker</span> <span class="n">Other</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mf">0.0</span><span class="o">]</span>
      <span class="o">[</span><span class="n">GC</span> <span class="n">Worker</span> <span class="n">Total</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">1.9</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">2.0</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">2.0</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.0</span><span class="o">,</span> <span class="nl">Sum:</span> <span class="mf">7.8</span><span class="o">]</span>
      <span class="o">[</span><span class="n">GC</span> <span class="n">Worker</span> <span class="n">End</span> <span class="o">(</span><span class="n">ms</span><span class="o">):</span> <span class="nl">Min:</span> <span class="mf">198.2</span><span class="o">,</span> <span class="nl">Avg:</span> <span class="mf">198.2</span><span class="o">,</span> <span class="nl">Max:</span> <span class="mf">198.2</span><span class="o">,</span> <span class="nl">Diff:</span> <span class="mf">0.0</span><span class="o">]</span>
   <span class="o">[</span><span class="n">Code</span> <span class="n">Root</span> <span class="nl">Fixup:</span> <span class="mf">0.0</span> <span class="n">ms</span><span class="o">]</span>
   <span class="o">[</span><span class="n">Code</span> <span class="n">Root</span> <span class="nl">Purge:</span> <span class="mf">0.0</span> <span class="n">ms</span><span class="o">]</span>
   <span class="o">[</span><span class="n">Clear</span> <span class="nl">CT:</span> <span class="mf">0.0</span> <span class="n">ms</span><span class="o">]</span>
   <span class="o">[</span><span class="nl">Other:</span> <span class="mf">0.2</span> <span class="n">ms</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Choose</span> <span class="nl">CSet:</span> <span class="mf">0.0</span> <span class="n">ms</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Ref</span> <span class="nl">Proc:</span> <span class="mf">0.1</span> <span class="n">ms</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Ref</span> <span class="nl">Enq:</span> <span class="mf">0.0</span> <span class="n">ms</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Redirty</span> <span class="nl">Cards:</span> <span class="mf">0.0</span> <span class="n">ms</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Humongous</span> <span class="nl">Register:</span> <span class="mf">0.0</span> <span class="n">ms</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Humongous</span> <span class="nl">Reclaim:</span> <span class="mf">0.0</span> <span class="n">ms</span><span class="o">]</span>
      <span class="o">[</span><span class="n">Free</span> <span class="nl">CSet:</span> <span class="mf">0.0</span> <span class="n">ms</span><span class="o">]</span>
   <span class="o">[</span><span class="nl">Eden:</span> <span class="mf">3072.0</span><span class="n">K</span><span class="o">(</span><span class="mf">10.0</span><span class="n">M</span><span class="o">)-&gt;</span><span class="mf">0.0</span><span class="n">B</span><span class="o">(</span><span class="mf">9216.0</span><span class="n">K</span><span class="o">)</span> <span class="nl">Survivors:</span> <span class="mf">0.0</span><span class="n">B</span><span class="o">-&gt;</span><span class="mf">1024.0</span><span class="n">K</span> <span class="nl">Heap:</span> <span class="mf">8629.0</span><span class="n">K</span><span class="o">(</span><span class="mf">20.0</span><span class="n">M</span><span class="o">)-&gt;</span><span class="mf">6823.5</span><span class="n">K</span><span class="o">(</span><span class="mf">20.0</span><span class="n">M</span><span class="o">)]</span>
 <span class="o">[</span><span class="nl">Times:</span> <span class="n">user</span><span class="o">=</span><span class="mf">0.00</span> <span class="n">sys</span><span class="o">=</span><span class="mf">0.00</span><span class="o">,</span> <span class="n">real</span><span class="o">=</span><span class="mf">0.01</span> <span class="n">secs</span><span class="o">]</span> 
<span class="mf">0.199</span><span class="o">:</span> <span class="o">[</span><span class="n">GC</span> <span class="n">concurrent</span><span class="o">-</span><span class="n">root</span><span class="o">-</span><span class="n">region</span><span class="o">-</span><span class="n">scan</span><span class="o">-</span><span class="n">start</span><span class="o">]</span>
<span class="mf">0.199</span><span class="o">:</span> <span class="o">[</span><span class="n">GC</span> <span class="n">concurrent</span><span class="o">-</span><span class="n">root</span><span class="o">-</span><span class="n">region</span><span class="o">-</span><span class="n">scan</span><span class="o">-</span><span class="n">end</span><span class="o">,</span> <span class="mf">0.0005314</span> <span class="n">secs</span><span class="o">]</span>
<span class="mf">0.199</span><span class="o">:</span> <span class="o">[</span><span class="n">GC</span> <span class="n">concurrent</span><span class="o">-</span><span class="n">mark</span><span class="o">-</span><span class="n">start</span><span class="o">]</span>
<span class="mf">0.199</span><span class="o">:</span> <span class="o">[</span><span class="n">GC</span> <span class="n">concurrent</span><span class="o">-</span><span class="n">mark</span><span class="o">-</span><span class="n">end</span><span class="o">,</span> <span class="mf">0.0000251</span> <span class="n">secs</span><span class="o">]</span>
<span class="mf">0.202</span><span class="o">:</span> <span class="o">[</span><span class="n">GC</span> <span class="n">remark</span> <span class="mf">0.202</span><span class="o">:</span> <span class="o">[</span><span class="n">Finalize</span> <span class="n">Marking</span><span class="o">,</span> <span class="mf">0.0000621</span> <span class="n">secs</span><span class="o">]</span> <span class="mf">0.202</span><span class="o">:</span> <span class="o">[</span><span class="n">GC</span> <span class="n">ref</span><span class="o">-</span><span class="n">proc</span><span class="o">,</span> <span class="mf">0.0000215</span> <span class="n">secs</span><span class="o">]</span> <span class="mf">0.202</span><span class="o">:</span> <span class="o">[</span><span class="n">Unloading</span><span class="o">,</span> <span class="mf">0.0003779</span> <span class="n">secs</span><span class="o">],</span> <span class="mf">0.0005651</span> <span class="n">secs</span><span class="o">]</span>
 <span class="o">[</span><span class="nl">Times:</span> <span class="n">user</span><span class="o">=</span><span class="mf">0.00</span> <span class="n">sys</span><span class="o">=</span><span class="mf">0.00</span><span class="o">,</span> <span class="n">real</span><span class="o">=</span><span class="mf">0.00</span> <span class="n">secs</span><span class="o">]</span> 
<span class="mf">0.203</span><span class="o">:</span> <span class="o">[</span><span class="n">GC</span> <span class="n">cleanup</span> <span class="mi">13</span><span class="n">M</span><span class="o">-&gt;</span><span class="mi">13</span><span class="n">M</span><span class="o">(</span><span class="mi">20</span><span class="n">M</span><span class="o">),</span> <span class="mf">0.0001664</span> <span class="n">secs</span><span class="o">]</span>
 <span class="o">[</span><span class="nl">Times:</span> <span class="n">user</span><span class="o">=</span><span class="mf">0.00</span> <span class="n">sys</span><span class="o">=</span><span class="mf">0.00</span><span class="o">,</span> <span class="n">real</span><span class="o">=</span><span class="mf">0.00</span> <span class="n">secs</span><span class="o">]</span> 
 <span class="n">Heap</span>
 <span class="n">garbage</span><span class="o">-</span><span class="n">first</span> <span class="n">heap</span>   <span class="n">total</span> <span class="mi">20480</span><span class="n">K</span><span class="o">,</span> <span class="n">used</span> <span class="mi">12967</span><span class="n">K</span> <span class="o">[</span><span class="mh">0x00000007bec00000</span><span class="o">,</span> <span class="mh">0x00000007bed000a0</span><span class="o">,</span> <span class="mh">0x00000007c0000000</span><span class="o">)</span>
  <span class="n">region</span> <span class="n">size</span> <span class="mi">1024</span><span class="n">K</span><span class="o">,</span> <span class="mi">2</span> <span class="n">young</span> <span class="o">(</span><span class="mi">2048</span><span class="n">K</span><span class="o">),</span> <span class="mi">1</span> <span class="n">survivors</span> <span class="o">(</span><span class="mi">1024</span><span class="n">K</span><span class="o">)</span>
 <span class="n">Metaspace</span>       <span class="n">used</span> <span class="mi">3342</span><span class="n">K</span><span class="o">,</span> <span class="n">capacity</span> <span class="mi">4500</span><span class="n">K</span><span class="o">,</span> <span class="n">committed</span> <span class="mi">4864</span><span class="n">K</span><span class="o">,</span> <span class="n">reserved</span> <span class="mi">1056768</span><span class="n">K</span>
  <span class="kd">class</span> <span class="nc">space</span>    <span class="n">used</span> <span class="mi">371</span><span class="n">K</span><span class="o">,</span> <span class="n">capacity</span> <span class="mi">388</span><span class="n">K</span><span class="o">,</span> <span class="n">committed</span> <span class="mi">512</span><span class="n">K</span><span class="o">,</span> <span class="n">reserved</span> <span class="mi">1048576</span><span class="n">K</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 doctording.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-03-07 22:17:36</p>
      </span>
    </div>

    
    
  </body>
</html>