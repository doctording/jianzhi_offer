<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/tango.css">
    <link rel="shortcut icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>一致性Hash - 剑指Offer</title>
    <meta name="keywords" content="algorithm，python"/>
    <meta name="description" content="for python and algorithm"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/sword_at_offer/">Home</a>&nbsp;&#187;&nbsp;<a href="/sword_at_offer/#db_cache">db_cache</a>&nbsp;&#187;&nbsp;一致性Hash
    <span class="updated">Page Updated&nbsp;
      2020-03-31 00:00
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">一致性Hash</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#hash">一致性Hash</a><ul>
<li><a href="#_1">问题引入</a></li>
<li><a href="#hash_1">一致性Hash算法</a><ul>
<li><a href="#_2">节点少，数据倾斜问题</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="hash">一致性Hash</h1>
<h2 id="_1">问题引入</h2>
<p>在解决分布式系统中负载均衡的问题时候可以使用Hash算法让固定的一部分请求落到同一台服务器上，这样每台服务器固定处理一部分请求（并维护这些请求的信息），起到负载均衡的作用。</p>
<p>但是普通的除留余数法（<code>hash(比如用户id)%服务器机器数</code>）算法伸缩性很差，当新增或者下线服务器机器时候，用户id与服务器的映射关系会大量失效。一致性hash则利用hash环对其进行了改进。</p>
<h2 id="hash_1">一致性Hash算法</h2>
<ol>
<li>
<p>将整个哈希值空间映射成一个虚拟的圆环，整个哈希空间的取值范围为0~2^32-1（即是一个32位无符号整型）</p>
</li>
<li>
<p>将各个服务器使用Hash进行一个哈希，具体可以选择服务器的ip或主机名作为关键字进行哈希，这样每台机器就能确定其在哈希环上的位置</p>
</li>
</ol>
<p>数据如何定位到服务器？</p>
<p>将数据key使用相同的函数Hash计算出哈希值，并确定此数据在环上的位置，从此位置沿环顺时针“行走”，第一台遇到的服务器就是其应该定位到的服务器。</p>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/db_cache/imgs/consistent_hash.png" /></p>
<p>现假设Node C不幸宕机，可以看到此时对象A、B、D不会受到影响，只有C对象被重定位到Node D。一般的，在一致性哈希算法中，如果一台服务器不可用，则受影响的数据仅仅是此服务器到其环空间中前一台服务器（即沿着逆时针方向行走遇到的第一台服务器）之间数据，其它不会受到影响。</p>
<p>现假设新增了服务器X，可以看到此时对象A、B、D不会受到影响，只有C对象被重定位到Node X，则受影响的数据仅仅是新服务器到其环空间中前一台服务器（即沿着逆时针方向行走遇到的第一台服务器）之间数据，其它数据也不会受到影响。</p>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/db_cache/imgs/consistent_hash2.png" /></p>
<h3 id="_2">节点少，数据倾斜问题</h3>
<p>引入虚拟节点</p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 doctording.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-05-26 09:32:49</p>
      </span>
    </div>

    
    
  </body>
</html>