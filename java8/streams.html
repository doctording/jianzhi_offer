<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/tango.css">
    <link rel="shortcut icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Java8 Streams - 剑指Offer</title>
    <meta name="keywords" content="algorithm，python"/>
    <meta name="description" content="for python and algorithm"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/sword_at_offer/">Home</a>&nbsp;&#187;&nbsp;<a href="/sword_at_offer/#java8">java8</a>&nbsp;&#187;&nbsp;Java8 Streams
    <span class="updated">Page Updated&nbsp;
      2019-02-16 00:00
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">Java8 Streams</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#streams">Streams</a><ul>
<li><a href="#_1">流是什么,流的简单使用</a></li>
<li><a href="#_2">流 特点</a><ul>
<li><a href="#_3">流操作</a></li>
<li><a href="#_4">流与集合</a></li>
<li><a href="#_5">流操作</a><ul>
<li><a href="#reduce">规约(reduce)</a></li>
<li><a href="#max-min">max, min</a></li>
<li><a href="#_6">流操作: 无状态和有状态 ?</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="streams">Streams</h1>
<h2 id="_1">流是什么,流的简单使用</h2>
<div class="hlcode"><pre><span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;</span> <span class="n">menu</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span>
                <span class="k">new</span> <span class="nf">Dish</span><span class="o">(</span><span class="s">&quot;pork&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">800</span><span class="o">,</span> <span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">MEAT</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">Dish</span><span class="o">(</span><span class="s">&quot;beef&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">700</span><span class="o">,</span> <span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">MEAT</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">Dish</span><span class="o">(</span><span class="s">&quot;chicken&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">400</span><span class="o">,</span> <span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">MEAT</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">Dish</span><span class="o">(</span><span class="s">&quot;french fries&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mi">530</span><span class="o">,</span> <span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">OTHER</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">Dish</span><span class="o">(</span><span class="s">&quot;rice&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mi">350</span><span class="o">,</span> <span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">OTHER</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">Dish</span><span class="o">(</span><span class="s">&quot;season fruit&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mi">120</span><span class="o">,</span> <span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">OTHER</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">Dish</span><span class="o">(</span><span class="s">&quot;pizza&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mi">550</span><span class="o">,</span> <span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">OTHER</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">Dish</span><span class="o">(</span><span class="s">&quot;prawns&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">300</span><span class="o">,</span> <span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">FISH</span><span class="o">),</span>
                <span class="k">new</span> <span class="nf">Dish</span><span class="o">(</span><span class="s">&quot;salmon&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mi">450</span><span class="o">,</span> <span class="n">Dish</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">FISH</span><span class="o">));</span>
</pre></div>


<ul>
<li>java7 写法</li>
</ul>
<div class="hlcode"><pre><span class="n">List</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;</span> <span class="n">lowCaloricDishes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="c1">// 用累加器筛选卡路里&lt;400的元素</span>
<span class="k">for</span><span class="o">(</span><span class="n">Dish</span> <span class="nl">d:</span> <span class="n">menu</span><span class="o">){</span>
    <span class="k">if</span><span class="o">(</span><span class="n">d</span><span class="o">.</span><span class="na">getCalories</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="o">){</span>
        <span class="n">lowCaloricDishes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">d</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">// 用匿名类对菜肴排序</span>
<span class="n">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">lowCaloricDishes</span><span class="o">,</span> <span class="k">new</span> <span class="n">Comparator</span><span class="o">&lt;</span><span class="n">Dish</span><span class="o">&gt;()</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compare</span><span class="o">(</span><span class="n">Dish</span> <span class="n">d1</span><span class="o">,</span> <span class="n">Dish</span> <span class="n">d2</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Integer</span><span class="o">.</span><span class="na">compare</span><span class="o">(</span><span class="n">d1</span><span class="o">.</span><span class="na">getCalories</span><span class="o">(),</span> <span class="n">d2</span><span class="o">.</span><span class="na">getCalories</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">});</span>
<span class="c1">// 获取最后的菜肴列表</span>
<span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">lowCaloricDishesName</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
<span class="k">for</span><span class="o">(</span><span class="n">Dish</span> <span class="nl">d:</span> <span class="n">lowCaloricDishes</span><span class="o">){</span>
    <span class="n">lowCaloricDishesName</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">d</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
<span class="o">}</span>
</pre></div>


<p>在这段代码中，你用了一个"垃圾变量"lowCaloricDishes。它唯一的作用就是作为一次性的中间容器。在Java8中，实现的细节被放在它本该归属的库里了</p>
<ul>
<li>java8</li>
</ul>
<div class="hlcode"><pre><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">lowCaloricDishesName</span> <span class="o">=</span>
                <span class="n">menu</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">d</span> <span class="o">-&gt;</span> <span class="n">d</span><span class="o">.</span><span class="na">getCalories</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="o">)</span>
                <span class="o">.</span><span class="na">sorted</span><span class="o">(</span><span class="n">comparing</span><span class="o">(</span><span class="nl">Dish:</span><span class="o">:</span><span class="n">getCalories</span><span class="o">))</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Dish:</span><span class="o">:</span><span class="n">getName</span><span class="o">)</span>
                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">toList</span><span class="o">());</span>
</pre></div>


<p>为了利用多核架构并行处理，需把<code>stream()</code>换成<code>parallelStream()</code></p>
<div class="hlcode"><pre><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">lowCaloricDishesName</span> <span class="o">=</span>
                <span class="n">menu</span><span class="o">.</span><span class="na">parallelStream</span><span class="o">()</span>
                <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">d</span> <span class="o">-&gt;</span> <span class="n">d</span><span class="o">.</span><span class="na">getCalories</span><span class="o">()</span> <span class="o">&lt;</span> <span class="mi">400</span><span class="o">)</span>
                <span class="o">.</span><span class="na">sorted</span><span class="o">(</span><span class="n">comparing</span><span class="o">(</span><span class="nl">Dish:</span><span class="o">:</span><span class="n">getCalories</span><span class="o">))</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Dish:</span><span class="o">:</span><span class="n">getName</span><span class="o">)</span>
                <span class="o">.</span><span class="na">collect</span><span class="o">(</span><span class="n">toList</span><span class="o">());</span>
</pre></div>


<p>优势：</p>
<ul>
<li>
<p>代码是以声明性方式写的:说明想要完成什么(筛选热量低的菜肴)而不是说明如何实现一个操作(利用循环和if条件等控制流语句)。</p>
</li>
<li>
<p>你可以把几个基础操作链接起来，来表达复杂等流水线(在filter后面接上 sorted、map和collect操作),同时保持代码清晰可读</p>
</li>
</ul>
<p>所以通过Java8的Stream API可以写出如下的代码：</p>
<ul>
<li>声明性 —— 更简洁，更易读</li>
<li>可复合 —— 更灵活</li>
<li>可并行 —— 性能更好</li>
</ul>
<h2 id="_2">流 特点</h2>
<h3 id="_3">流操作</h3>
<p>"A sequence of elements supporting sequential and parallel aggregate operations."</p>
<p>从支持<code>数据处理</code>操作的<code>源</code>生成的<code>元素序列</code></p>
<ol>
<li>
<p>Stream是元素的集合，这点让Stream看起来用些类似Iterator</p>
</li>
<li>
<p>可以支持顺序和并行的对原Stream进行汇聚的操作</p>
</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/java8/imgs/streams.png" /></p>
<h3 id="_4">流与集合</h3>
<ul>
<li>只能遍历一次</li>
</ul>
<p>和迭代器类似，流只能遍历一次。遍历完之后，我们就说这个流已经被消费掉了。</p>
<ul>
<li>外部迭代与内部迭代</li>
</ul>
<p>使用Collection接口需要用户去做迭代(比如用for-each)，这称为外部迭代。相反，Streams库使用内部迭代——它帮你把迭代做了</p>
<h3 id="_5">流操作</h3>
<ul>
<li>filter、map和limit可以连成一条流水线;</li>
<li>collect触发流水线执行并关闭它。</li>
</ul>
<p>可以连接起来的流操作称为<code>中间操作</code>，关闭流的操作称为<code>终端操作</code></p>
<p>流的使用一般包括三件事:</p>
<ol>
<li>一个数据源(如集合)来执行一个查询</li>
<li>一个中间操作链，形成一条流的流水线</li>
<li>一个终端操作，执行流水线，并能生成结果</li>
</ol>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/java8/imgs/stream_operate.png" /></p>
<h4 id="reduce">规约(reduce)</h4>
<div class="hlcode"><pre><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">numberList</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="mi">6</span><span class="o">,</span><span class="mi">7</span><span class="o">);</span>

<span class="kt">int</span> <span class="n">numberSum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="nl">num:</span> <span class="n">numberList</span><span class="o">){</span>
    <span class="n">numberSum</span> <span class="o">+=</span> <span class="n">num</span><span class="o">;</span>
<span class="o">}</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;sum:&quot;</span><span class="o">+</span> <span class="n">numberSum</span><span class="o">);</span>

<span class="kt">int</span> <span class="n">numberSum2</span> <span class="o">=</span> <span class="n">numberList</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
        <span class="o">.</span><span class="na">reduce</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;sum2:&quot;</span><span class="o">+</span> <span class="n">numberSum2</span><span class="o">);</span>
</pre></div>


<p>reduce接受两个参数</p>
<ul>
<li>
<p>总和变量初始值，设为了0</p>
</li>
<li>
<p>将列表中所有原始结合在一起的操作，设为了<code>+</code> （<code>BinaryOperator&lt;T&gt;</code>操作用lambda表达式表示）</p>
</li>
</ul>
<p>如下返回<code>Optional</code>对象，因为Stream中可能一个元素都没有</p>
<div class="hlcode"><pre><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">numberSum3</span> <span class="o">=</span> <span class="n">numberList</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
    <span class="o">.</span><span class="na">reduce</span><span class="o">(</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;sum3:&quot;</span><span class="o">+</span> <span class="n">numberSum3</span><span class="o">);</span>
</pre></div>


<h4 id="max-min">max, min</h4>
<div class="hlcode"><pre><span class="n">List</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">numberList</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span><span class="mi">6</span><span class="o">,</span><span class="mi">7</span><span class="o">);</span>

<span class="kt">int</span> <span class="n">numberMax</span> <span class="o">=</span> <span class="n">numberList</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
        <span class="o">.</span><span class="na">reduce</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">b</span> <span class="o">?</span> <span class="n">a</span> <span class="o">:</span> <span class="n">b</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;max:&quot;</span><span class="o">+</span> <span class="n">numberMax</span><span class="o">);</span>

<span class="n">Optional</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">numberMax2</span> <span class="o">=</span> <span class="n">numberList</span><span class="o">.</span><span class="na">stream</span><span class="o">()</span>
        <span class="o">.</span><span class="na">reduce</span><span class="o">(</span><span class="nl">Integer:</span><span class="o">:</span><span class="n">max</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;max2:&quot;</span><span class="o">+</span> <span class="n">numberMax2</span><span class="o">);</span>
</pre></div>


<h4 id="_6">流操作: 无状态和有状态 ?</h4>
<p>诸如<code>map</code>或<code>filter</code>等操作会从输入流中获取每一个元素，并在输出流中输出0个或1个结果，这些操作是<code>无状态</code>的:它们没有内部状态（假设用户提高的lambda或方法引用没有内部可变状态）</p>
<p>诸如<code>reduce</code>,<code>sum</code>，<code>max</code>等操作需要<code>内部状态</code>来累计结果，要求流是<code>有界</code>的</p>
<p>诸如<code>sort</code>或<code>distince</code>等操作，开始与<code>map</code>,<code>filter</code>相同，但是需要有个缓冲区存放所有元素，这个存储要求是<code>无界</code>的</p>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/java8/imgs/stream_operate2.png" /></p>
<p>注：如果能避开有状态，选用无状态操作，就能获得更好的<code>并行</code>性能。</p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 doctording.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-05-27 23:49:44</p>
      </span>
    </div>

    
    
  </body>
</html>