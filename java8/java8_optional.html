<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/tango.css">
    <link rel="shortcut icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>Java8 Optional - 剑指Offer</title>
    <meta name="keywords" content="algorithm，python"/>
    <meta name="description" content="for python and algorithm"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/sword_at_offer/">Home</a>&nbsp;&#187;&nbsp;<a href="/sword_at_offer/#java8">java8</a>&nbsp;&#187;&nbsp;Java8 Optional
    <span class="updated">Page Updated&nbsp;
      2019-02-17 13:00
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">Java8 Optional</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#optionnull">用option取代null</a><ul>
<li><a href="#javalangnullpointerexception">经典的java.lang.NullPointerException问题</a></li>
<li><a href="#nullpointerexception">采用防御式检查减少NullPointerException</a></li>
<li><a href="#null">null 带来的种种问题</a></li>
<li><a href="#optional">Optional</a><ul>
<li><a href="#optional_1">Optional 对象如何创建</a></li>
<li><a href="#optional_2">Optional 使用实际例子</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="optionnull">用option取代null</h1>
<h2 id="javalangnullpointerexception">经典的<code>java.lang.NullPointerException</code>问题</h2>
<div class="hlcode"><pre><span class="kd">class</span> <span class="nc">Insurance</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">name</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Car</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Insurance</span> <span class="n">insurance</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setInsurance</span><span class="o">(</span><span class="n">Insurance</span> <span class="n">insurance</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">insurance</span> <span class="o">=</span> <span class="n">insurance</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Insurance</span> <span class="nf">getInsurance</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">insurance</span><span class="o">;</span> <span class="o">}</span>

<span class="o">}</span>
<span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Car</span> <span class="n">car</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCar</span><span class="o">(</span><span class="n">Car</span> <span class="n">car</span><span class="o">){</span> <span class="k">this</span><span class="o">.</span><span class="na">car</span> <span class="o">=</span> <span class="n">car</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Car</span> <span class="nf">getCar</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">car</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainTest</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getCarInsuranceName</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">person</span><span class="o">.</span><span class="na">getCar</span><span class="o">().</span><span class="na">getInsurance</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">carInsuranceName</span> <span class="o">=</span> <span class="n">getCarInsuranceName</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="n">carInsuranceName</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2 id="nullpointerexception">采用防御式检查减少<code>NullPointerException</code></h2>
<ol>
<li>深层质疑</li>
</ol>
<div class="hlcode"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getCarInsuranceName</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">person</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="na">getCar</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="na">getCar</span><span class="o">().</span><span class="na">getInsurance</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">person</span><span class="o">.</span><span class="na">getCar</span><span class="o">().</span><span class="na">getInsurance</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="s">&quot;Unknown&quot;</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>


<ol>
<li>过多的退出语句</li>
</ol>
<div class="hlcode"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getCarInsuranceName</span><span class="o">(</span><span class="n">Person</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span><span class="o">(</span><span class="n">person</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;Unknown&quot;</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="na">getCar</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;Unknown&quot;</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">if</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="na">getCar</span><span class="o">().</span><span class="na">getInsurance</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;Unknown&quot;</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">person</span><span class="o">.</span><span class="na">getCar</span><span class="o">().</span><span class="na">getInsurance</span><span class="o">().</span><span class="na">getName</span><span class="o">();</span>
<span class="o">}</span>
</pre></div>


<h2 id="null"><code>null</code> 带来的种种问题</h2>
<ul>
<li>它是错误之源</li>
</ul>
<p>NullPointerException是目前Java程序开发中最典型的异常</p>
<ul>
<li>它会使你的代码膨胀</li>
</ul>
<p>它让你的代码充斥着深度嵌套的null检查，代码的可读性糟糕透顶</p>
<ul>
<li>它自身是毫无意义的</li>
</ul>
<p>null自身没有任何的语义，尤其是，它代表的是在静态类型语言中以一种错误的方式对缺少变量值的建模</p>
<ul>
<li>它破坏了Java的哲学</li>
</ul>
<p>Java一直试图避免让程序员意识到指针的存在，唯一的例外是:null指针。</p>
<ul>
<li>它在Java的类型系统上开了个口子。</li>
</ul>
<p>null并不属于任何类型，这意味着它可以被赋值给任意引用类型的变量。这会导致问题，原因是当这个变量被传递到系统中的另一个部分后，你将无法获知这个null变量最初的赋值到底是什么类型</p>
<h2 id="optional">Optional</h2>
<div class="hlcode"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
</pre></div>


<p>变量存在时，Optional类只是对类简单封装。变量不存在时，缺失的值会被建模成一个"空"的Optional对象，由方法<code>Optional.empty()</code>返回。<code>Optional.empty()</code>方法是一个静态工厂方法，它返回Optional类的特定单一实例。</p>
<p>使用Optional而不是null的一个非常重要而又实际的语义区别是，我们在声明变量时使用的是<code>Optional&lt;Car&gt;</code>类型，而不是<code>Car</code>类型，这句声明非常清楚地表明了这里发生变量缺失是允许的。与此相反，使用Car这样的类型，可能将变量赋值为null，这意味着你需要独立面对这些，你只能依赖你对业务模型的理解，判断一个null是否属于该变量的有效范畴。</p>
<h3 id="optional_1">Optional 对象如何创建</h3>
<ul>
<li>几种创建方式</li>
</ul>
<div class="hlcode"><pre><span class="c1">// 依据一个非空值创建 Optional</span>
<span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">();</span>
<span class="n">Optional</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">optPerson</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>

<span class="c1">// 声明一个空的 Optional</span>
<span class="n">Optional</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">optionalEmptyPerson</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>

<span class="c1">// 可接受 null 的 Optional</span>
<span class="n">Person</span> <span class="n">personNull</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="n">Optional</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">optionalNullPerson</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">personNull</span><span class="o">);</span>
</pre></div>


<ul>
<li>在域模型中使用Optional，以及为什么它们无法序列化</li>
</ul>
<p>建议你像下面这个例子那样，提供一个能访问声明为Optional、变量值可能缺失的接口，</p>
<div class="hlcode"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Car</span> <span class="n">car</span><span class="o">;</span>
    <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Car</span><span class="o">&gt;</span> <span class="nf">getCarAsOptional</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">car</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h3 id="optional_2">Optional 使用实际例子</h3>
<p>如果你对一个<code>空的Optional对象</code>调用<code>flatMap</code>，实际情况又会如何呢?结果不会发生任何改变，返回值也是个空的Optional对象(<code>Optional.empty</code>)。对null进行flatmap会抛出<code>NullPointerException</code></p>
<div class="hlcode"><pre><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">personOptional</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
<span class="c1">// 对 Optional.empty 进行 flatMap 会返回 Optional.empty</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span> <span class="n">personOptional</span><span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="nl">Person:</span><span class="o">:</span><span class="n">getCar</span><span class="o">));</span>
<span class="c1">// 对 null 进行 flatMap 会抛出 java.lang.NullPointerException</span>
<span class="n">personOptional</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="n">personOptional</span><span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="nl">Person:</span><span class="o">:</span><span class="n">getCar</span><span class="o">);</span>
</pre></div>


<div class="hlcode"><pre><span class="kd">class</span> <span class="nc">Insurance</span> <span class="o">{</span>
    <span class="cm">/**</span>
<span class="cm">     * 保险公司必须要有名字，此处非Optional</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">name</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">Car</span> <span class="o">{</span>
    <span class="cm">/**</span>
<span class="cm">     * 车可能有保险，也可能没有保险，因此将这个字段声明为Optional</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Insurance</span><span class="o">&gt;</span> <span class="n">insurance</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setInsurance</span><span class="o">(</span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Insurance</span><span class="o">&gt;</span> <span class="n">insurance</span><span class="o">)</span> <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">insurance</span> <span class="o">=</span> <span class="n">insurance</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Insurance</span><span class="o">&gt;</span> <span class="nf">getInsurance</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">insurance</span><span class="o">;</span> <span class="o">}</span>

<span class="o">}</span>
<span class="kd">class</span> <span class="nc">Person</span> <span class="o">{</span>
    <span class="cm">/**</span>
<span class="cm">     * 人可能有车，也可能没有车，因此将这个字段声明为Optional</span>
<span class="cm">      */</span>
    <span class="kd">private</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Car</span><span class="o">&gt;</span> <span class="n">car</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCar</span><span class="o">(</span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Car</span><span class="o">&gt;</span> <span class="n">car</span><span class="o">){</span> <span class="k">this</span><span class="o">.</span><span class="na">car</span> <span class="o">=</span> <span class="n">car</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Car</span><span class="o">&gt;</span> <span class="nf">getCar</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">car</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainTest</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">getCarInsuranceName</span><span class="o">(</span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">person</span><span class="o">)</span> <span class="o">{</span>
        <span class="cm">/**</span>
<span class="cm">         * flatMap 链接 Optional 对象</span>
<span class="cm">         */</span>
        <span class="k">return</span> <span class="n">person</span><span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="nl">Person:</span><span class="o">:</span><span class="n">getCar</span><span class="o">)</span>
                <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="nl">Car:</span><span class="o">:</span><span class="n">getInsurance</span><span class="o">)</span>
                <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Insurance:</span><span class="o">:</span><span class="n">getName</span><span class="o">)</span>
                <span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="s">&quot;Unknown&quot;</span><span class="o">);</span>

    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

        <span class="cm">/**</span>
<span class="cm">         * 1.  Person 为空</span>
<span class="cm">         */</span>
        <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">optionalEmptyPerson</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">carInsuranceName</span> <span class="o">=</span> <span class="n">getCarInsuranceName</span><span class="o">(</span><span class="n">optionalEmptyPerson</span><span class="o">);</span>
        <span class="c1">// Unknown</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">carInsuranceName</span><span class="o">);</span>

        <span class="cm">/**</span>
<span class="cm">         * 2. Person非空，但 Car 为空</span>
<span class="cm">         */</span>
        <span class="c1">// 构造 Optional&lt;Person&gt;</span>
        <span class="n">Person</span> <span class="n">person</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Person</span><span class="o">();</span>
        <span class="c1">// person 非空，必须设置 Car</span>
        <span class="n">person</span><span class="o">.</span><span class="na">setCar</span><span class="o">(</span><span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">());</span>
        <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Person</span><span class="o">&gt;</span> <span class="n">optPerson</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>

        <span class="n">carInsuranceName</span> <span class="o">=</span> <span class="n">getCarInsuranceName</span><span class="o">(</span><span class="n">optPerson</span><span class="o">);</span>
        <span class="c1">// Unknown</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">carInsuranceName</span><span class="o">);</span>

        <span class="cm">/**</span>
<span class="cm">         * 3. Person非空，Car 非空， 但 Insurance 为空</span>
<span class="cm">         */</span>
        <span class="c1">// 声明 Optional&lt;Car&gt;</span>
        <span class="n">Car</span> <span class="n">car</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Car</span><span class="o">();</span>
        <span class="c1">// car 非空，必须设置 Insurance</span>
        <span class="n">car</span><span class="o">.</span><span class="na">setInsurance</span><span class="o">(</span><span class="n">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">());</span>
        <span class="n">Optional</span><span class="o">&lt;</span><span class="n">Car</span><span class="o">&gt;</span> <span class="n">optionalOfNullCar</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">car</span><span class="o">);</span>
        <span class="c1">// 构造 Optional&lt;Person&gt;</span>
        <span class="n">person</span><span class="o">.</span><span class="na">setCar</span><span class="o">(</span><span class="n">optionalOfNullCar</span><span class="o">);</span>
        <span class="n">optPerson</span> <span class="o">=</span> <span class="n">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">person</span><span class="o">);</span>
        <span class="n">carInsuranceName</span> <span class="o">=</span> <span class="n">getCarInsuranceName</span><span class="o">(</span><span class="n">optPerson</span><span class="o">);</span>
        <span class="c1">// Unknown</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">carInsuranceName</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 doctording.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-05-23 14:49:36</p>
      </span>
    </div>

    
    
  </body>
</html>