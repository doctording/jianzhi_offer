<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/tango.css">
    <link rel="shortcut icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>自定义线程池 - 剑指Offer</title>
    <meta name="keywords" content="algorithm，python"/>
    <meta name="description" content="for python and algorithm"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/sword_at_offer/">Home</a>&nbsp;&#187;&nbsp;<a href="/sword_at_offer/#java_thread_concurrent">java_thread_concurrent</a>&nbsp;&#187;&nbsp;自定义线程池
    <span class="updated">Page Updated&nbsp;
      2019-02-15 00:00
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">自定义线程池</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#_1">自定义线程池步骤</a></li>
</ul>
</div>
<h1 id="_1">自定义线程池步骤</h1>
<ol>
<li>
<p>自定义一个阻塞队列</p>
</li>
<li>
<p>线程池：工作线程核心数，任务的接收执行（没有最大线程数量）</p>
</li>
<li>
<p>自定义队列满时新增任务的拒绝策略</p>
</li>
<li>
<p>测试验证</p>
</li>
</ol>
<div class="hlcode"><pre><span class="kd">class</span> <span class="nc">SelfBlockingQueue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="c1">// 任务队列</span>
    <span class="n">Deque</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">queue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayDeque</span><span class="o">&lt;&gt;();</span>

    <span class="n">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ReentrantLock</span><span class="o">();</span>

    <span class="n">Condition</span> <span class="n">notFull</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>

    <span class="n">Condition</span> <span class="n">notEmpty</span> <span class="o">=</span> <span class="n">lock</span><span class="o">.</span><span class="na">newCondition</span><span class="o">();</span>

    <span class="c1">// 容量</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">capcity</span><span class="o">;</span>

    <span class="n">SelfBlockingQueue</span><span class="o">(</span><span class="kt">int</span> <span class="n">cap</span><span class="o">){</span>
        <span class="n">capcity</span> <span class="o">=</span> <span class="n">cap</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">put</span><span class="o">(</span><span class="n">T</span> <span class="n">val</span><span class="o">){</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">getSize</span><span class="o">()</span> <span class="o">==</span> <span class="n">capcity</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;queue is Full now. notFull await ...&quot;</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;等待加入任务队列...&quot;</span> <span class="o">+</span> <span class="n">val</span><span class="o">);</span>
                    <span class="n">notFull</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>

                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;加入任务队列...&quot;</span> <span class="o">+</span> <span class="n">val</span><span class="o">);</span>
            <span class="n">queue</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">val</span><span class="o">);</span>
            <span class="n">notEmpty</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">offer</span><span class="o">(</span><span class="n">T</span> <span class="n">task</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">timeUnit</span><span class="o">){</span>
        <span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="n">timeUnit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">getSize</span><span class="o">()</span> <span class="o">==</span> <span class="n">capcity</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;queue is Full now. notFull await ...&quot;</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;等待加入任务队列...&quot;</span> <span class="o">+</span> <span class="n">task</span><span class="o">);</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">time</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">){</span>
                        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;等待加入任务队列...超时...&quot;</span> <span class="o">+</span> <span class="n">task</span><span class="o">);</span>
                        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">notFull</span><span class="o">.</span><span class="na">awaitNanos</span><span class="o">(</span><span class="n">time</span><span class="o">);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>

                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;加入任务队列...&quot;</span> <span class="o">+</span> <span class="n">task</span><span class="o">);</span>
            <span class="n">queue</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
            <span class="n">notEmpty</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">T</span> <span class="nf">take</span><span class="o">(){</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()){</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;queue is Empty now. notEmpty await ...&quot;</span><span class="o">);</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">notEmpty</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>

                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">T</span> <span class="n">e</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">removeFirst</span><span class="o">();</span>
            <span class="n">notFull</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">T</span> <span class="nf">poll</span><span class="o">(</span><span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">unit</span><span class="o">){</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">time</span> <span class="o">=</span> <span class="n">unit</span><span class="o">.</span><span class="na">toNanos</span><span class="o">(</span><span class="n">timeout</span><span class="o">);</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">queue</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">()){</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;queue is Empty now. notEmpty await ...&quot;</span><span class="o">);</span>
                <span class="k">try</span><span class="o">{</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">time</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">){</span>
                        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="c1">// 返回剩余等待时间</span>
                    <span class="n">time</span> <span class="o">=</span> <span class="n">notEmpty</span><span class="o">.</span><span class="na">awaitNanos</span><span class="o">(</span><span class="n">time</span><span class="o">);</span>
                <span class="o">}</span><span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">){</span>

                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">T</span> <span class="n">e</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">removeFirst</span><span class="o">();</span>
            <span class="n">notFull</span><span class="o">.</span><span class="na">signal</span><span class="o">();</span>
            <span class="k">return</span> <span class="n">e</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getSize</span><span class="o">(){</span>
        <span class="n">lock</span><span class="o">.</span><span class="na">lock</span><span class="o">();</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">queue</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="n">lock</span><span class="o">.</span><span class="na">unlock</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

<span class="o">}</span>

<span class="nd">@FunctionalInterface</span>
<span class="kd">interface</span> <span class="nc">RejectPolicy</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">{</span>
    <span class="kt">void</span> <span class="nf">reject</span><span class="o">(</span><span class="n">SelfBlockingQueue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">queue</span><span class="o">,</span> <span class="n">T</span> <span class="n">task</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">class</span> <span class="nc">SelfThreadPool</span><span class="o">{</span>
    <span class="c1">// 任务队列</span>
    <span class="kd">private</span> <span class="n">SelfBlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">taskQueue</span><span class="o">;</span>
    <span class="c1">// 任务对列大小</span>
    <span class="kt">int</span> <span class="n">capcity</span><span class="o">;</span>

    <span class="c1">// 工作线程集合</span>
    <span class="kd">private</span> <span class="n">HashSet</span> <span class="n">workers</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashSet</span><span class="o">();</span>

    <span class="c1">// 核心线程数</span>
    <span class="kt">int</span> <span class="n">coreSize</span><span class="o">;</span>

    <span class="c1">// 超时时间，销毁线程</span>
    <span class="kt">long</span> <span class="n">timeout</span><span class="o">;</span>
    <span class="n">TimeUnit</span> <span class="n">timeUnit</span><span class="o">;</span>

    <span class="n">RejectPolicy</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">rejectPolicy</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">SelfThreadPool</span><span class="o">(</span><span class="kt">int</span> <span class="n">coreSize</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span> <span class="n">timeUnit</span><span class="o">,</span> <span class="kt">int</span> <span class="n">capcity</span><span class="o">,</span> <span class="n">RejectPolicy</span> <span class="n">rejectPolicy</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">coreSize</span> <span class="o">=</span> <span class="n">coreSize</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">timeout</span> <span class="o">=</span> <span class="n">timeout</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">timeUnit</span> <span class="o">=</span> <span class="n">timeUnit</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">taskQueue</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SelfBlockingQueue</span><span class="o">&lt;&gt;(</span><span class="n">capcity</span><span class="o">);</span>
        <span class="k">this</span><span class="o">.</span><span class="na">rejectPolicy</span> <span class="o">=</span> <span class="n">rejectPolicy</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="c1">// 执行某个任务</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">){</span>
        <span class="kd">synchronized</span> <span class="o">(</span><span class="n">workers</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// 小于 coreSize 则直接Worker执行，否则加入任务队列</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">workers</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">&lt;</span> <span class="n">coreSize</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;新增worker...&quot;</span> <span class="o">+</span> <span class="n">task</span><span class="o">);</span>
                <span class="n">Worker</span> <span class="n">worker</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Worker</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
                <span class="n">worker</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
                <span class="n">workers</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">worker</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;加入队列等待...&quot;</span> <span class="o">+</span> <span class="n">task</span><span class="o">);</span>
                <span class="c1">// 1. 死等</span>
<span class="c1">//                taskQueue.put(task);</span>
                <span class="c1">// 2. 等待超时</span>
                <span class="c1">// 3. 放弃任务执行</span>
                <span class="c1">// 4. 抛出异常</span>
                <span class="c1">// 5. 调用者自己去执行</span>
                <span class="n">tryReject</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kt">void</span> <span class="nf">tryReject</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">){</span>
        <span class="n">rejectPolicy</span><span class="o">.</span><span class="na">reject</span><span class="o">(</span><span class="n">taskQueue</span><span class="o">,</span> <span class="n">task</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="c1">// 工作</span>
    <span class="kd">class</span> <span class="nc">Worker</span> <span class="kd">extends</span> <span class="n">Thread</span><span class="o">{</span>

        <span class="kd">private</span> <span class="n">Runnable</span> <span class="n">task</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">Worker</span><span class="o">(</span><span class="n">Runnable</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">this</span><span class="o">.</span><span class="na">task</span> <span class="o">=</span> <span class="n">task</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">(){</span>
            <span class="c1">// 执行任务,当前任务；任务队列中</span>
            <span class="c1">// 1. 阻塞等待新任务</span>
<span class="c1">//            while (task != null || (task = taskQueue.take()) != null){</span>
            <span class="c1">// 2. 超时等待新任务，超时则结束核心线程</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">task</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">(</span><span class="n">task</span> <span class="o">=</span> <span class="n">taskQueue</span><span class="o">.</span><span class="na">poll</span><span class="o">(</span><span class="n">timeout</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">))</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">){</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;正在运行...&quot;</span> <span class="o">+</span> <span class="n">task</span><span class="o">);</span>
                    <span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>

                <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                    <span class="n">task</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="n">workers</span><span class="o">){</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;任务执行完，worker被移除...&quot;</span> <span class="o">+</span> <span class="k">this</span><span class="o">);</span>
                <span class="n">workers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>

<span class="c1">//    static void testPool(){</span>
<span class="c1">//        SelfThreadPool selfThreadPool = new SelfThreadPool(2, 1, TimeUnit.SECONDS, 3);</span>
<span class="c1">//        for(int i=0;i&lt;5;i++) {</span>
<span class="c1">//            int[] num = new int[]{i};</span>
<span class="c1">//            Runnable r = () -&gt; {</span>
<span class="c1">//                try {</span>
<span class="c1">//                    TimeUnit.MILLISECONDS.sleep(500);</span>
<span class="c1">//                    System.out.println(&quot;running over...&quot; + num[0]);</span>
<span class="c1">//                } catch (Exception e) {</span>
<span class="c1">//</span>
<span class="c1">//                }</span>
<span class="c1">//            };</span>
<span class="c1">//            selfThreadPool.execute(r);</span>
<span class="c1">//        }</span>
<span class="c1">//    }</span>

<span class="c1">//    static void testPool2(){</span>
<span class="c1">//        SelfThreadPool selfThreadPool = new SelfThreadPool(2, 1, TimeUnit.SECONDS, 3);</span>
<span class="c1">//        for(int i=0;i&lt;10;i++) {</span>
<span class="c1">//            int[] num = new int[]{i};</span>
<span class="c1">//            Runnable r = () -&gt; {</span>
<span class="c1">//                try {</span>
<span class="c1">//                    TimeUnit.MILLISECONDS.sleep(2000);</span>
<span class="c1">//                    System.out.println(&quot;running over...&quot; + num[0]);</span>
<span class="c1">//                } catch (Exception e) {</span>
<span class="c1">//</span>
<span class="c1">//                }</span>
<span class="c1">//            };</span>
<span class="c1">//            selfThreadPool.execute(r);</span>
<span class="c1">//        }</span>
<span class="c1">//    }</span>

    <span class="kd">static</span> <span class="kt">void</span> <span class="nf">testPool3</span><span class="o">(){</span>
        <span class="n">RejectPolicy</span> <span class="n">rejectPolicy1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RejectPolicy</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reject</span><span class="o">(</span><span class="n">SelfBlockingQueue</span> <span class="n">queue</span><span class="o">,</span> <span class="n">Object</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">queue</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">task</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="n">RejectPolicy</span> <span class="n">rejectPolicy2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RejectPolicy</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reject</span><span class="o">(</span><span class="n">SelfBlockingQueue</span> <span class="n">queue</span><span class="o">,</span> <span class="n">Object</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">queue</span><span class="o">.</span><span class="na">offer</span><span class="o">(</span><span class="n">task</span><span class="o">,</span> <span class="mi">500</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="n">RejectPolicy</span> <span class="n">rejectPolicy3</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RejectPolicy</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reject</span><span class="o">(</span><span class="n">SelfBlockingQueue</span> <span class="n">queue</span><span class="o">,</span> <span class="n">Object</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">&quot;任务被拒绝执行...&quot;</span> <span class="o">+</span> <span class="n">task</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="n">RejectPolicy</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">rejectPolicy4</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RejectPolicy</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="kt">void</span> <span class="nf">reject</span><span class="o">(</span><span class="n">SelfBlockingQueue</span><span class="o">&lt;</span><span class="n">Runnable</span><span class="o">&gt;</span> <span class="n">queue</span><span class="o">,</span> <span class="n">Runnable</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">task</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="n">SelfThreadPool</span> <span class="n">selfThreadPool</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SelfThreadPool</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span>
                <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="n">rejectPolicy4</span><span class="o">);</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="o">;</span><span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="kt">int</span><span class="o">[]</span> <span class="n">num</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">int</span><span class="o">[]{</span><span class="n">i</span><span class="o">};</span>
            <span class="n">Runnable</span> <span class="n">r</span> <span class="o">=</span> <span class="o">()</span> <span class="o">-&gt;</span> <span class="o">{</span>
                <span class="k">try</span> <span class="o">{</span>
                    <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MILLISECONDS</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;running over...&quot;</span> <span class="o">+</span> <span class="n">num</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
                <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>

                <span class="o">}</span>
            <span class="o">};</span>
            <span class="n">selfThreadPool</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">testPool3</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 doctording.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-06-28 09:36:13</p>
      </span>
    </div>

    
    
  </body>
</html>