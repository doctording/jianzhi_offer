<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/tango.css">
    <link rel="shortcut icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>ThreadLocal - 剑指Offer</title>
    <meta name="keywords" content="algorithm，python"/>
    <meta name="description" content="for python and algorithm"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/sword_at_offer/">Home</a>&nbsp;&#187;&nbsp;<a href="/sword_at_offer/#java_thread_concurrent">java_thread_concurrent</a>&nbsp;&#187;&nbsp;ThreadLocal
    <span class="updated">Page Updated&nbsp;
      2019-02-15 00:00
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">ThreadLocal</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#threadlocal">ThreadLocal</a><ul>
<li><a href="#_1">实现思路</a><ul>
<li><a href="#set">set源码</a></li>
</ul>
</li>
<li><a href="#_2">使用场景</a></li>
<li><a href="#_3">自己项目中使用到的?</a></li>
<li><a href="#threadlocal_1">ThreadLocal会产生内存泄漏吗?</a></li>
</ul>
</li>
</ul>
</div>
<h1 id="threadlocal">ThreadLocal</h1>
<p><code>ThreadLocal</code>并不是一个<code>Thread</code>，而是<code>Thread</code>的局部变量</p>
<p><code>ThreadLocal</code>用于保存某个线程共享变量：对于同一个static ThreadLocal，不同线程只能从中get，set，remove自己的变量，而不会影响其他线程的变量</p>
<h2 id="_1">实现思路</h2>
<ul>
<li>Thread类有一个类型为<code>ThreadLocal.ThreadLocalMap</code>的实例变量threadLocals，也就是说每个线程有一个自己的ThreadLocalMap(是线程自己拥有的map)。</li>
</ul>
<h3 id="set">set源码</h3>
<div class="hlcode"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
    <span class="n">ThreadLocalMap</span> <span class="n">map</span> <span class="o">=</span> <span class="n">getMap</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
        <span class="n">map</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="k">else</span>
        <span class="nf">createMap</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<ul>
<li>this 是 ThreadLocal 对象，即set到Map的<key, value>即：<ThreadLocal.this, value></li>
<li>只有一个key，new几个ThreadLocal就能有多少个键值对</li>
</ul>
<div class="hlcode"><pre><span class="kd">private</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="n">ThreadLocal</span><span class="o">&lt;?&gt;</span> <span class="n">key</span><span class="o">,</span> <span class="n">Object</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>

    <span class="c1">// We don&#39;t use a fast path as with get() because it is at</span>
    <span class="c1">// least as common to use set() to create new entries as</span>
    <span class="c1">// it is to replace existing ones, in which case, a fast</span>
    <span class="c1">// path would fail more often than not.</span>

    <span class="n">Entry</span><span class="o">[]</span> <span class="n">tab</span> <span class="o">=</span> <span class="n">table</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">tab</span><span class="o">.</span><span class="na">length</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="na">threadLocalHashCode</span> <span class="o">&amp;</span> <span class="o">(</span><span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="o">);</span>

    <span class="k">for</span> <span class="o">(</span><span class="n">Entry</span> <span class="n">e</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
            <span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">;</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">tab</span><span class="o">[</span><span class="n">i</span> <span class="o">=</span> <span class="n">nextIndex</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">len</span><span class="o">)])</span> <span class="o">{</span>
        <span class="n">ThreadLocal</span><span class="o">&lt;?&gt;</span> <span class="n">k</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">==</span> <span class="n">key</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">;</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">k</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">replaceStaleEntry</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">,</span> <span class="n">i</span><span class="o">);</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="n">tab</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Entry</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
    <span class="kt">int</span> <span class="n">sz</span> <span class="o">=</span> <span class="o">++</span><span class="n">size</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">cleanSomeSlots</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">sz</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">sz</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="o">)</span>
        <span class="n">rehash</span><span class="o">();</span>
<span class="o">}</span>

<span class="kd">static</span> <span class="kd">class</span> <span class="nc">Entry</span> <span class="kd">extends</span> <span class="n">WeakReference</span><span class="o">&lt;</span><span class="n">ThreadLocal</span><span class="o">&lt;?&gt;&gt;</span> <span class="o">{</span>
    <span class="cm">/** The value associated with this ThreadLocal. */</span>
    <span class="n">Object</span> <span class="n">value</span><span class="o">;</span>

    <span class="n">Entry</span><span class="o">(</span><span class="n">ThreadLocal</span><span class="o">&lt;?&gt;</span> <span class="n">k</span><span class="o">,</span> <span class="n">Object</span> <span class="n">v</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">k</span><span class="o">);</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">v</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<ul>
<li><code>Entry</code>是个弱引用<code>WeakReference&lt;ThreadLocal&lt;?&gt;</code></li>
</ul>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/java_thread_concurrent/imgs/thread_local.png" /></p>
<ol>
<li>tl不用了，指向<code>ThreadLocal</code>的引用没了，那么Thread要被回收</li>
<li>假如this是个强引用，那么显然只要线程不结束，<code>ThreadLocal</code>就永远不会被回收，会出现内存泄漏</li>
<li>现在是个弱引用，只要gc发现不用了，就回收</li>
<li><code>ThreadLocal</code>被回收后，<code>ThreadLocalMap</code>里面的key是个null，这样value就访问不到，会出现内存泄漏</li>
<li>需要显示的remove掉value:<code>tl1.remove();</code></li>
</ol>
<h2 id="_2">使用场景</h2>
<ol>
<li>
<p>在进行对象跨层传递的时候，可以考虑<code>ThreadLocal</code>，避免方法多次传递，打破层次间的约束</p>
</li>
<li>
<p>线程间数据隔离</p>
</li>
<li>
<p>进行事务操作，用于存储线程事务信息</p>
</li>
</ol>
<h2 id="_3">自己项目中使用到的?</h2>
<p>比如一个查询，要经过一层一层处理，最后还有记录此次的查询记录；</p>
<p>其中有个queryId，可以放到<code>ThreadLocal</code>中，这样打点&amp;记录随时可以取出queryId</p>
<h2 id="threadlocal_1">ThreadLocal会产生内存泄漏吗?</h2>
<ul>
<li>
<p>会</p>
</li>
<li>
<p>弱引用做了一道工作</p>
</li>
<li>需要显示的remove掉ThreadLocal</li>
</ul>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 doctording.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-07-16 22:52:09</p>
      </span>
    </div>

    
    
  </body>
</html>