<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/tango.css">
    <link rel="shortcut icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>CPU,缓存 - 剑指Offer</title>
    <meta name="keywords" content="algorithm，python"/>
    <meta name="description" content="for python and algorithm"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/sword_at_offer/">Home</a>&nbsp;&#187;&nbsp;<a href="/sword_at_offer/#java_thread_concurrent">java_thread_concurrent</a>&nbsp;&#187;&nbsp;CPU,缓存
    <span class="updated">Page Updated&nbsp;
      2019-03-09 00:00
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">CPU,缓存</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#_1">缓存一致性</a><ul>
<li><a href="#cpu">CPU提速优化</a><ul>
<li><a href="#_2">指令乱序例子程序</a></li>
</ul>
</li>
<li><a href="#_3">三级缓存</a></li>
<li><a href="#mesi">MESI协议</a></li>
<li><a href="#_4">总线锁和缓存锁</a></li>
<li><a href="#cache-line">缓存行 cache line</a><ul>
<li><a href="#_5">两个变量在一个缓存行中</a></li>
<li><a href="#_6">消除伪共享</a><ul>
<li><a href="#_7">原因</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="_1">缓存一致性</h1>
<p>计算机体系架构</p>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/java_thread_concurrent/imgs/computer.png" /></p>
<h2 id="cpu">CPU提速优化</h2>
<p>CPU优化的两点</p>
<ol>
<li>指令乱序执行（CPU执行更多的指令）</li>
<li>CPU高速缓存（匹配速度慢的主存，也是能执行更多的指令）</li>
</ol>
<p>cpu中为了能够让指令的执行尽可能地并行起来，从而发明了流水线技术。但是如果两条指令的前后存在依赖关系，比如数据依赖，控制依赖等，此时后一条语句就必需等到前一条指令完成后，才能开始。cpu为了提高流水线的运行效率，会做出比如：</p>
<ol>
<li>对无依赖的前后指令做适当的乱序和调度；</li>
<li>对控制依赖的指令做分支预测；</li>
<li>对读取内存等的耗时操作，做提前预读；</li>
<li>等等。</li>
</ol>
<p>这些都可能会导致指令乱序</p>
<h3 id="_2">指令乱序例子程序</h3>
<div class="hlcode"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>

    <span class="kd">static</span> <span class="kt">int</span> <span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

            <span class="n">Thread</span> <span class="n">A</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">});</span>

            <span class="n">Thread</span> <span class="n">B</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="k">new</span> <span class="n">Runnable</span><span class="o">()</span> <span class="o">{</span>
                <span class="nd">@Override</span>
                <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
                    <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">a</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">});</span>

            <span class="n">A</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
            <span class="n">B</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>

            <span class="n">A</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>
            <span class="n">B</span><span class="o">.</span><span class="na">join</span><span class="o">();</span>

            <span class="n">i</span><span class="o">++;</span>
            <span class="k">if</span><span class="o">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">==</span> <span class="mi">0</span><span class="o">){</span>
                <span class="n">System</span><span class="o">.</span><span class="na">err</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">x</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">y</span><span class="o">);</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;main end&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<h2 id="_3">三级缓存</h2>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/java_thread_concurrent/imgs/cpu.png" /></p>
<ul>
<li>L1高速缓存：也叫一级缓存。一般内置在内核旁边，是与CPU结合最为紧密的CPU缓存。一次访问只需要2~4个时钟周期</li>
<li>L2高速缓存：也叫二级缓存。空间比L1缓存大，速度比L1缓存略慢。一次访问约需要10多个时钟周期</li>
<li>L3高速缓存：也叫三级缓存。部分单CPU多核心的才会有的缓存，介于多核和内存之间。存储空间已达Mb级别，一次访问约需要数十个时钟周期。</li>
</ul>
<p>当CPU要读取一个数据时，首先从L1缓存查找，命中则返回；若未命中，再从L2缓存中查找，如果还没有则从L3缓存查找（如果有L3缓存的话）。如果还是没有，则从内存中查找，并将读取到的数据逐级放入缓存。</p>
<p>eg:</p>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/java_thread_concurrent/imgs/cache_3.png" /></p>
<h2 id="mesi">MESI协议</h2>
<p>多个处理器都涉及同一块主内存区域的更改时，将导致各自的缓存数据不一致？如何解决？</p>
<p>当某个cpu修改缓存行数据时，其它的cpu通过监听机制获悉共享缓存行的数据被修改，会使其共享缓存行失效。本cpu会将修改后的缓存行写回到主内存中。此时其它的cpu如果需要此缓存行共享数据，则从主内存中重新加载，并放入缓存，以此完成了缓存一致性。</p>
<p><a href="https://zh.wikipedia.org/wiki/MESI%E5%8D%8F%E8%AE%AE" target="_blanck">mesi wiki</a></p>
<h2 id="_4">总线锁和缓存锁</h2>
<p><code>总线锁</code>是把CPU和内存的通信给锁住了；使得在锁定期间，其它处理器不能操作内存的其它数据，这样开销较大</p>
<p><code>缓存锁</code>不需锁定总线，只需要“锁定”被缓存的共享对象（实际为：缓存行）即可；接受到lock指令，通过缓存一致性协议，维护本处理器内部缓存和其它处理器缓存的一致性。相比总线锁，会提高cpu利用率。</p>
<h2 id="cache-line">缓存行 cache line</h2>
<ul>
<li>
<p>程序局部性原理（这里解释为：访问内存或缓存但某个位置，顺带但把紧邻的位置一起读取出来）</p>
<ol>
<li>缓存行越大，局部性空间效率越高，但读取时间慢</li>
<li>缓存行越小，局部性空间效率越低，但读取时间快</li>
</ol>
</li>
</ul>
<p>折中取：64字节</p>
<p>消除伪共享</p>
<h3 id="_5">两个变量在一个缓存行中</h3>
<div class="hlcode"><pre><span class="kn">import</span> <span class="nn">java.util.concurrent.CountDownLatch</span><span class="o">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">T</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">x</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">T</span><span class="o">[]</span> <span class="n">arr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">T</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">arr</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">T</span><span class="o">();</span>
        <span class="n">arr</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">T</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// 一亿次</span>
    <span class="kd">static</span> <span class="kt">int</span> <span class="n">FOR_COUNT</span> <span class="o">=</span> <span class="mi">100</span><span class="n">_000_000</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">CountDownLatch</span> <span class="n">latch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>

        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FOR_COUNT</span><span class="o">;</span> <span class="n">i</span> <span class="o">++){</span>
                <span class="n">arr</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">x</span> <span class="o">++;</span>
            <span class="o">}</span>
            <span class="n">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
        <span class="o">});</span>

        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FOR_COUNT</span><span class="o">;</span> <span class="n">i</span> <span class="o">++){</span>
                <span class="n">arr</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">x</span> <span class="o">++;</span>
            <span class="o">}</span>
            <span class="n">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
        <span class="o">});</span>

        <span class="kd">final</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">latch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">((</span><span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">start</span><span class="o">)</span> <span class="o">/</span><span class="mi">1</span><span class="n">_000_000</span> <span class="o">+</span> <span class="s">&quot; ms&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>程序输出：<code>2990 ms</code>,<code>2952 ms</code>,<code>2490 ms</code>，大概3秒左右</p>
<h3 id="_6">消除伪共享</h3>
<div class="hlcode"><pre><span class="kn">import</span> <span class="nn">java.util.concurrent.CountDownLatch</span><span class="o">;</span>


<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Main</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">T</span> <span class="o">{</span>
        <span class="kd">public</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">p1</span><span class="o">,</span> <span class="n">p2</span><span class="o">,</span> <span class="n">p3</span><span class="o">,</span> <span class="n">p4</span><span class="o">,</span> <span class="n">p5</span><span class="o">,</span> <span class="n">p6</span><span class="o">,</span> <span class="n">p7</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">x</span><span class="o">;</span>
        <span class="kd">public</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">p8</span><span class="o">,</span> <span class="n">p9</span><span class="o">,</span> <span class="n">p10</span><span class="o">,</span> <span class="n">p11</span><span class="o">,</span> <span class="n">p12</span><span class="o">,</span> <span class="n">p13</span><span class="o">,</span> <span class="n">p14</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">T</span><span class="o">[]</span> <span class="n">arr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">T</span><span class="o">[</span><span class="mi">2</span><span class="o">];</span>

    <span class="kd">static</span> <span class="o">{</span>
        <span class="n">arr</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">T</span><span class="o">();</span>
        <span class="n">arr</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="k">new</span> <span class="n">T</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="c1">// 一亿次</span>
    <span class="kd">static</span> <span class="kt">int</span> <span class="n">FOR_COUNT</span> <span class="o">=</span> <span class="mi">100</span><span class="n">_000_000</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="n">CountDownLatch</span> <span class="n">latch</span> <span class="o">=</span> <span class="k">new</span> <span class="n">CountDownLatch</span><span class="o">(</span><span class="mi">2</span><span class="o">);</span>

        <span class="n">Thread</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FOR_COUNT</span><span class="o">;</span> <span class="n">i</span> <span class="o">++){</span>
                <span class="n">arr</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">x</span> <span class="o">++;</span>
            <span class="o">}</span>
            <span class="n">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
        <span class="o">});</span>

        <span class="n">Thread</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(()-&gt;{</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FOR_COUNT</span><span class="o">;</span> <span class="n">i</span> <span class="o">++){</span>
                <span class="n">arr</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="na">x</span> <span class="o">++;</span>
            <span class="o">}</span>
            <span class="n">latch</span><span class="o">.</span><span class="na">countDown</span><span class="o">();</span>
        <span class="o">});</span>

        <span class="kd">final</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">();</span>
        <span class="n">t1</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">t2</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
        <span class="n">latch</span><span class="o">.</span><span class="na">await</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">((</span><span class="n">System</span><span class="o">.</span><span class="na">nanoTime</span><span class="o">()</span> <span class="o">-</span> <span class="n">start</span><span class="o">)</span> <span class="o">/</span><span class="mi">1</span><span class="n">_000_000</span> <span class="o">+</span> <span class="s">&quot; ms&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>程序输出：<code>900 ms</code>,<code>894 ms</code>,<code>1189 ms</code>，1秒多</p>
<h4 id="_7">原因</h4>
<div class="hlcode"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">T</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">p1</span><span class="o">,</span> <span class="n">p2</span><span class="o">,</span> <span class="n">p3</span><span class="o">,</span> <span class="n">p4</span><span class="o">,</span> <span class="n">p5</span><span class="o">,</span> <span class="n">p6</span><span class="o">,</span> <span class="n">p7</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">x</span><span class="o">;</span>
    <span class="kd">public</span> <span class="kd">volatile</span> <span class="kt">long</span> <span class="n">p8</span><span class="o">,</span> <span class="n">p9</span><span class="o">,</span> <span class="n">p10</span><span class="o">,</span> <span class="n">p11</span><span class="o">,</span> <span class="n">p12</span><span class="o">,</span> <span class="n">p13</span><span class="o">,</span> <span class="n">p14</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>


<p>数组如下，arr[0].x 与 arr[1].x 不会在一个缓存行中；这样修改用的各自的缓存行，互不影响</p>
<div class="hlcode"><pre><span class="mi">56</span><span class="err">字节</span>
<span class="n">x</span><span class="o">(</span><span class="mi">8</span><span class="err">字节</span><span class="o">)</span>
<span class="mi">56</span><span class="err">字节</span>
<span class="mi">56</span><span class="err">字节</span>
<span class="n">x</span><span class="o">(</span><span class="mi">8</span><span class="err">字节</span><span class="o">)</span>
<span class="mi">56</span><span class="err">字节</span>
</pre></div>


<p>配合<code>import sun.misc.Contended;</code>的<code>@Contended</code>注解(注意加上<code>-XX:-RestrictContended</code>参数)</p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 doctording.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-06-28 09:36:13</p>
      </span>
    </div>

    
    
  </body>
</html>