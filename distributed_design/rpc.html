<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/tango.css">
    <link rel="shortcut icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>rpc - 剑指Offer</title>
    <meta name="keywords" content="algorithm，python"/>
    <meta name="description" content="for python and algorithm"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/sword_at_offer/">Home</a>&nbsp;&#187;&nbsp;<a href="/sword_at_offer/#distributed_design">distributed_design</a>&nbsp;&#187;&nbsp;rpc
    <span class="updated">Page Updated&nbsp;
      2020-05-18 00:00
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">rpc</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#rpcremote-procedure-call">rpc(Remote Procedure Call)</a><ul>
<li><a href="#egsocket">eg:传统的socket编程</a></li>
<li><a href="#stub">Stub代理类屏蔽网络细节</a></li>
<li><a href="#_1">反射 + 动态代理</a><ul>
<li><a href="#_2">改进</a></li>
</ul>
</li>
<li><a href="#_3">任意服务的灵活支持</a></li>
<li><a href="#rpc">RPC 序列化协议</a><ul>
<li><a href="#_4">用序列化协议改写代码</a></li>
</ul>
</li>
<li><a href="#rpc_1">RPC 网络协议</a></li>
<li><a href="#rpc_2">回顾RPC</a></li>
<li><a href="#_5">为什么需要服务注册与发现</a><ul>
<li><a href="#_6">服务发现</a><ul>
<li><a href="#_7">客户端实现</a></li>
<li><a href="#_8">服务端实现</a></li>
<li><a href="#service-registry">服务注册中心（Service Registry）</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="rpcremote-procedure-call">rpc(Remote Procedure Call)</h1>
<p>问题引入：两台不同的主机进程要进行通信？</p>
<p>最易想到的最原始做法：tcp/ip通信，二进制数据传输</p>
<ul>
<li>蛮烦点：写网络；服务动态扩展后，客户端又得对接处理了</li>
</ul>
<p>如下一点一点的改进出来（参考：马士兵老师的RPC讲解课程），知识点</p>
<ul>
<li>JAVA socket编程基础</li>
<li>JAVA反射</li>
<li>代理模式/动态代理</li>
<li>序列化</li>
</ul>
<h2 id="egsocket">eg:传统的socket编程</h2>
<ul>
<li>User</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">rpc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.Serializable</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2020/5/18 23:10</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="kd">implements</span> <span class="n">Serializable</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Integer</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">User</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">Integer</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setName</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;User{&quot;</span> <span class="o">+</span>
                <span class="s">&quot;id=&quot;</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span>
                <span class="s">&quot;, name=&#39;&quot;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="sc">&#39;\&#39;&#39;</span> <span class="o">+</span>
                <span class="sc">&#39;}&#39;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<ul>
<li>IUserService</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">rpc</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2020/5/18 23:10</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">IUserService</span> <span class="o">{</span>
    <span class="n">User</span> <span class="nf">getUserById</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
</pre></div>


<ul>
<li>UserServiceImpl</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">rpc</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2020/5/18 23:10</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserServiceImpl</span> <span class="kd">implements</span> <span class="n">IUserService</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUserById</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">User</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="s">&quot;zhang&quot;</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<ul>
<li>Server</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">rpc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2020/5/18 23:18</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 监听指定的端口</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">55533</span><span class="o">;</span>
        <span class="n">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>

        <span class="c1">// server将一直等待连接的到来</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;server将一直等待连接的到来&quot;</span><span class="o">);</span>
        <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
        <span class="c1">// 建立好连接后，从socket中获取输入流，并建立缓冲区进行读取</span>
        <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
        <span class="n">DataInputStream</span> <span class="n">dis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataInputStream</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="n">DataOutputStream</span> <span class="n">dos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>

        <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;client send id:&quot;</span> <span class="o">+</span> <span class="n">id</span><span class="o">);</span>

        <span class="n">IUserService</span> <span class="n">userService</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserServiceImpl</span><span class="o">();</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">getUserById</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>

        <span class="n">dos</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">dos</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">dos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>

        <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">server</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<ul>
<li>client</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">rpc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2020/5/18 23:18</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 要连接的服务端IP地址和端口</span>
        <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">55533</span><span class="o">;</span>
        <span class="c1">// 与服务端建立连接</span>
        <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
        <span class="c1">// 建立连接后获得输出流</span>
        <span class="n">ByteArrayOutputStream</span> <span class="n">byteArrayOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="n">DataOutputStream</span> <span class="n">dos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">byteArrayOutputStream</span><span class="o">);</span>
        <span class="n">dos</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="mi">12</span><span class="o">);</span>
        <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">byteArrayOutputStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
        <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>

        <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="n">DataInputStream</span> <span class="n">dis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataInputStream</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>

        <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<h2 id="stub"><code>Stub</code>代理类屏蔽网络细节</h2>
<p>client 访问太复杂， 网络这部分非得了解不可</p>
<ul>
<li>
<p>一个代理<code>Stub</code>类，把网络这部分给封装下，客户端轻松点</p>
</li>
<li>
<p>client</p>
</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">rpc</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2020/5/18 23:18</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 代理</span>
        <span class="n">Stub</span> <span class="n">stub</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Stub</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">stub</span><span class="o">.</span><span class="na">getUserById</span><span class="o">(</span><span class="mi">12</span><span class="o">));</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<ul>
<li>Stub</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">rpc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.ByteArrayOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.DataInputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.DataOutputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.io.InputStream</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2020/5/18 23:18</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Stub</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUserById</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="c1">// 要连接的服务端IP地址和端口</span>
        <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">55533</span><span class="o">;</span>
        <span class="c1">// 与服务端建立连接</span>
        <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
        <span class="c1">// 建立连接后获得输出流</span>
        <span class="n">ByteArrayOutputStream</span> <span class="n">byteArrayOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="n">DataOutputStream</span> <span class="n">dos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">byteArrayOutputStream</span><span class="o">);</span>
        <span class="n">dos</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">byteArrayOutputStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
        <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>

        <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="n">DataInputStream</span> <span class="n">dis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataInputStream</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">userName</span><span class="o">);</span>

        <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<h2 id="_1">反射 + 动态代理</h2>
<p>既然服务端 和 客户端都知道约定的方法，那么Stub直接把调用传递的方法，参数什么的直接给服务端；服务端通过反射执行，把结果返回给 Stub 就行了; Stub 把 服务端执行的 service类 代理给客户端；</p>
<p>这样：客户端的调用，就很简单：得到service对象，直接调用service的方法就好了；service增加方法，客户端也是直接调用</p>
<ul>
<li>Client</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">rpc</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2020/5/18 23:18</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span> <span class="n">args</span><span class="o">[])</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="n">IUserService</span> <span class="n">iUserService</span> <span class="o">=</span> <span class="n">Stub</span><span class="o">.</span><span class="na">getStub</span><span class="o">();</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">iUserService</span><span class="o">.</span><span class="na">getUserById</span><span class="o">(</span><span class="mi">12</span><span class="o">));</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<ul>
<li>Server</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">rpc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2020/5/18 23:18</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 监听指定的端口</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">55533</span><span class="o">;</span>
        <span class="n">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>

        <span class="c1">// server将一直等待连接的到来</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;server将一直等待连接的到来&quot;</span><span class="o">);</span>
        <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
        <span class="c1">// 建立好连接后，从socket中获取输入流，并建立缓冲区进行读取</span>
        <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
        <span class="n">ObjectInputStream</span> <span class="n">objectInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="n">DataOutputStream</span> <span class="n">dos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>

<span class="c1">//        int id = dis.readInt();</span>
<span class="c1">//        System.out.println(&quot;client send id:&quot; + id);</span>
<span class="c1">//</span>
<span class="c1">//        IUserService userService = new UserServiceImpl();</span>
<span class="c1">//        User user = userService.getUserById(id);</span>
        <span class="n">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
        <span class="n">Class</span><span class="o">[]</span> <span class="n">parameterTypes</span> <span class="o">=</span> <span class="o">(</span><span class="n">Class</span><span class="o">[])</span><span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">methodArgs</span> <span class="o">=</span> <span class="o">(</span><span class="n">Object</span><span class="o">[])</span><span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>

        <span class="c1">// 方法实现在 UserServiceImpl 对象上</span>
        <span class="n">IUserService</span> <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserServiceImpl</span><span class="o">();</span>
        <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="n">methodName</span><span class="o">,</span> <span class="n">parameterTypes</span><span class="o">);</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span><span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">methodArgs</span><span class="o">);</span>

        <span class="n">dos</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
        <span class="n">dos</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
        <span class="n">dos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>

        <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">server</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<ul>
<li>Stub</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">rpc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2020/5/18 23:18</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Stub</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">IUserService</span> <span class="nf">getStub</span><span class="o">(){</span>
        <span class="c1">// 调用方法处理器</span>
        <span class="n">InvocationHandler</span> <span class="n">h</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvocationHandler</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
                <span class="c1">// 要连接的服务端IP地址和端口</span>
                <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">55533</span><span class="o">;</span>
                <span class="c1">// 与服务端建立连接</span>
                <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
                <span class="c1">// 建立连接后获得输出流</span>
                <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>
                <span class="c1">// 方法名，参数类型和列表（把方法传递给服务端）</span>
                <span class="n">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
                <span class="n">Class</span><span class="o">[]</span> <span class="n">paramTypes</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">();</span>
                <span class="n">oos</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="n">methodName</span><span class="o">);</span>
                <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">paramTypes</span><span class="o">);</span>
                <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
                <span class="n">oos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>

                <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
                <span class="n">DataInputStream</span> <span class="n">dis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataInputStream</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
                <span class="kt">int</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
                <span class="n">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
                <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">userName</span><span class="o">);</span>

                <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

                <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">IUserService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span>
               <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">IUserService</span><span class="o">.</span><span class="na">class</span><span class="o">},</span> <span class="n">h</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getInterfaces</span><span class="o">()[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">IUserService</span><span class="o">)</span><span class="n">o</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Deprecated</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUserById</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="c1">// 要连接的服务端IP地址和端口</span>
        <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">55533</span><span class="o">;</span>
        <span class="c1">// 与服务端建立连接</span>
        <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
        <span class="c1">// 建立连接后获得输出流</span>
        <span class="n">ByteArrayOutputStream</span> <span class="n">byteArrayOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="n">DataOutputStream</span> <span class="n">dos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">byteArrayOutputStream</span><span class="o">);</span>
        <span class="n">dos</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">byteArrayOutputStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
        <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>

        <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="n">DataInputStream</span> <span class="n">dis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataInputStream</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">userName</span><span class="o">);</span>

        <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<h3 id="_2">改进</h3>
<ul>
<li>Stub</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">rpc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2020/5/18 23:18</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Stub</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">IUserService</span> <span class="nf">getStub</span><span class="o">(){</span>
        <span class="c1">// 调用方法处理器</span>
        <span class="n">InvocationHandler</span> <span class="n">h</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvocationHandler</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
                <span class="c1">// 要连接的服务端IP地址和端口</span>
                <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">55533</span><span class="o">;</span>
                <span class="c1">// 与服务端建立连接</span>
                <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
                <span class="c1">// 建立连接后获得输出流</span>
                <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>
                <span class="c1">// 方法名，参数类型和列表（把方法传递给服务端）</span>
                <span class="n">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
                <span class="n">Class</span><span class="o">[]</span> <span class="n">paramTypes</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">();</span>
                <span class="n">oos</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="n">methodName</span><span class="o">);</span>
                <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">paramTypes</span><span class="o">);</span>
                <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
                <span class="n">oos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>

<span class="c1">//                InputStream in = socket.getInputStream();</span>
<span class="c1">//                DataInputStream dis = new DataInputStream(in);</span>
<span class="c1">//                int userId = dis.readInt();</span>
<span class="c1">//                String userName = dis.readUTF();</span>
<span class="c1">//                User user = new User(userId, userName);</span>
                <span class="c1">// 直接读取服务端返回的对象</span>
                <span class="n">ObjectInputStream</span> <span class="n">objectInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
                <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span> <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>

                <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

                <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">IUserService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span>
               <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">IUserService</span><span class="o">.</span><span class="na">class</span><span class="o">},</span> <span class="n">h</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getInterfaces</span><span class="o">()[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">IUserService</span><span class="o">)</span><span class="n">o</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Deprecated</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUserById</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="c1">// 要连接的服务端IP地址和端口</span>
        <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">55533</span><span class="o">;</span>
        <span class="c1">// 与服务端建立连接</span>
        <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
        <span class="c1">// 建立连接后获得输出流</span>
        <span class="n">ByteArrayOutputStream</span> <span class="n">byteArrayOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="n">DataOutputStream</span> <span class="n">dos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">byteArrayOutputStream</span><span class="o">);</span>
        <span class="n">dos</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">byteArrayOutputStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
        <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>

        <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="n">DataInputStream</span> <span class="n">dis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataInputStream</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">userName</span><span class="o">);</span>

        <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<ul>
<li>Server</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">rpc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2020/5/18 23:18</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 监听指定的端口</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">55533</span><span class="o">;</span>
        <span class="n">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>

        <span class="c1">// server将一直等待连接的到来</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;server将一直等待连接的到来&quot;</span><span class="o">);</span>
        <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
        <span class="c1">// 建立好连接后，从socket中获取输入流，并建立缓冲区进行读取</span>
        <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
        <span class="n">ObjectInputStream</span> <span class="n">objectInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
<span class="c1">//        DataOutputStream dos = new DataOutputStream(out);</span>

<span class="c1">//        int id = dis.readInt();</span>
<span class="c1">//        System.out.println(&quot;client send id:&quot; + id);</span>
<span class="c1">//</span>
<span class="c1">//        IUserService userService = new UserServiceImpl();</span>
<span class="c1">//        User user = userService.getUserById(id);</span>
        <span class="n">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
        <span class="n">Class</span><span class="o">[]</span> <span class="n">parameterTypes</span> <span class="o">=</span> <span class="o">(</span><span class="n">Class</span><span class="o">[])</span><span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">methodArgs</span> <span class="o">=</span> <span class="o">(</span><span class="n">Object</span><span class="o">[])</span><span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>

        <span class="c1">// 方法实现在 UserServiceImpl 对象上</span>
        <span class="n">IUserService</span> <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserServiceImpl</span><span class="o">();</span>
        <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getMethod</span><span class="o">(</span><span class="n">methodName</span><span class="o">,</span> <span class="n">parameterTypes</span><span class="o">);</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span><span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">service</span><span class="o">,</span> <span class="n">methodArgs</span><span class="o">);</span>

<span class="c1">//        dos.writeInt(user.getId());</span>
<span class="c1">//        dos.writeUTF(user.getName());</span>
<span class="c1">//        dos.flush();</span>
        <span class="c1">// 直接把返回对象写回给客户端</span>
        <span class="n">ObjectOutputStream</span> <span class="n">objectOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>

        <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">server</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<h2 id="_3">任意服务的灵活支持</h2>
<p>客户端直接传递Service到服务端，服务端获取注册服务的实现类，处理好了之后返回给客户端</p>
<p>不管多少种服务；只要约定好，客户端直接调用即可，基本不需要修改<code>Stub</code>相关代码; client 调用远程方法，就像调用本地方法一样（这样你不需要懂网络底层，直接服务端有什么，你就能用什么）</p>
<ul>
<li>client</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">rpc</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2020/5/18 23:18</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Client</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
<span class="c1">//        IUserService iUserService = (IUserService) Stub.getStub(IUserService.class);</span>
<span class="c1">//        System.out.println(iUserService.getUserById(12));</span>

        <span class="n">IProService</span> <span class="n">iProService</span> <span class="o">=</span> <span class="o">(</span><span class="n">IProService</span><span class="o">)</span> <span class="n">Stub</span><span class="o">.</span><span class="na">getStub</span><span class="o">(</span><span class="n">IProService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">iProService</span><span class="o">.</span><span class="na">getProById</span><span class="o">(</span><span class="mi">12</span><span class="o">));</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<ul>
<li>Stub</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">rpc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2020/5/18 23:18</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Stub</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">getStub</span><span class="o">(</span><span class="n">Class</span> <span class="n">clazz</span><span class="o">){</span>
        <span class="c1">// 调用方法处理器</span>
        <span class="n">InvocationHandler</span> <span class="n">h</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvocationHandler</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
                <span class="c1">// 要连接的服务端IP地址和端口</span>
                <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">55533</span><span class="o">;</span>
                <span class="c1">// 与服务端建立连接</span>
                <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>

                <span class="c1">// 类名,方法名，参数类型和列表（把类+方法传递给服务端）</span>
                <span class="n">String</span> <span class="n">className</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
                <span class="n">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
                <span class="n">Class</span><span class="o">[]</span> <span class="n">paramTypes</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">();</span>

                <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>
                <span class="n">oos</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="n">className</span><span class="o">);</span>
                <span class="n">oos</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="n">methodName</span><span class="o">);</span>
                <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">paramTypes</span><span class="o">);</span>
                <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
                <span class="n">oos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>
                <span class="c1">// 直接读取服务端返回的对象</span>
                <span class="n">ObjectInputStream</span> <span class="n">objectInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
                <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>

                <span class="n">objectInputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

                <span class="k">return</span> <span class="n">o</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">clazz</span><span class="o">},</span> <span class="n">h</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getInterfaces</span><span class="o">()[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="k">return</span> <span class="n">o</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Deprecated</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">IUserService</span> <span class="nf">getStub</span><span class="o">(){</span>
        <span class="c1">// 调用方法处理器</span>
        <span class="n">InvocationHandler</span> <span class="n">h</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvocationHandler</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
                <span class="c1">// 要连接的服务端IP地址和端口</span>
                <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">55533</span><span class="o">;</span>
                <span class="c1">// 与服务端建立连接</span>
                <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
                <span class="c1">// 建立连接后获得输出流</span>
                <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">());</span>
                <span class="c1">// 方法名，参数类型和列表（把方法传递给服务端）</span>
                <span class="n">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
                <span class="n">Class</span><span class="o">[]</span> <span class="n">paramTypes</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">();</span>
                <span class="n">oos</span><span class="o">.</span><span class="na">writeUTF</span><span class="o">(</span><span class="n">methodName</span><span class="o">);</span>
                <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">paramTypes</span><span class="o">);</span>
                <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">args</span><span class="o">);</span>
                <span class="n">oos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>

<span class="c1">//                InputStream in = socket.getInputStream();</span>
<span class="c1">//                DataInputStream dis = new DataInputStream(in);</span>
<span class="c1">//                int userId = dis.readInt();</span>
<span class="c1">//                String userName = dis.readUTF();</span>
<span class="c1">//                User user = new User(userId, userName);</span>
                <span class="c1">// 直接读取服务端返回的对象</span>
                <span class="n">ObjectInputStream</span> <span class="n">objectInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">());</span>
                <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="o">(</span><span class="n">User</span><span class="o">)</span> <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>

                <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

                <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">IUserService</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span>
               <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">IUserService</span><span class="o">.</span><span class="na">class</span><span class="o">},</span> <span class="n">h</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getInterfaces</span><span class="o">()[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="k">return</span> <span class="o">(</span><span class="n">IUserService</span><span class="o">)</span><span class="n">o</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Deprecated</span>
    <span class="kd">public</span> <span class="n">User</span> <span class="nf">getUserById</span><span class="o">(</span><span class="n">Integer</span> <span class="n">id</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span><span class="o">{</span>
        <span class="c1">// 要连接的服务端IP地址和端口</span>
        <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">55533</span><span class="o">;</span>
        <span class="c1">// 与服务端建立连接</span>
        <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>
        <span class="c1">// 建立连接后获得输出流</span>
        <span class="n">ByteArrayOutputStream</span> <span class="n">byteArrayOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="n">DataOutputStream</span> <span class="n">dos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataOutputStream</span><span class="o">(</span><span class="n">byteArrayOutputStream</span><span class="o">);</span>
        <span class="n">dos</span><span class="o">.</span><span class="na">writeInt</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
        <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">write</span><span class="o">(</span><span class="n">byteArrayOutputStream</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">());</span>
        <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">().</span><span class="na">flush</span><span class="o">();</span>

        <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="n">DataInputStream</span> <span class="n">dis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataInputStream</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>
        <span class="kt">int</span> <span class="n">userId</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="na">readInt</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">userName</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
        <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="k">new</span> <span class="n">User</span><span class="o">(</span><span class="n">userId</span><span class="o">,</span> <span class="n">userName</span><span class="o">);</span>

        <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

        <span class="k">return</span> <span class="n">user</span><span class="o">;</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<ul>
<li>Server</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">rpc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2020/5/18 23:18</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 监听指定的端口</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">55533</span><span class="o">;</span>
        <span class="n">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>

        <span class="c1">// server将一直等待连接的到来</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;server将一直等待连接的到来&quot;</span><span class="o">);</span>
        <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>
        <span class="c1">// 建立好连接后，从socket中获取输入流，并建立缓冲区进行读取</span>
        <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="n">ObjectInputStream</span> <span class="n">objectInputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectInputStream</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>

        <span class="n">String</span> <span class="n">clazzName</span> <span class="o">=</span> <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
        <span class="n">String</span> <span class="n">methodName</span> <span class="o">=</span> <span class="n">objectInputStream</span><span class="o">.</span><span class="na">readUTF</span><span class="o">();</span>
        <span class="n">Class</span><span class="o">[]</span> <span class="n">parameterTypes</span> <span class="o">=</span> <span class="o">(</span><span class="n">Class</span><span class="o">[])</span><span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>
        <span class="n">Object</span><span class="o">[]</span> <span class="n">methodArgs</span> <span class="o">=</span> <span class="o">(</span><span class="n">Object</span><span class="o">[])</span><span class="n">objectInputStream</span><span class="o">.</span><span class="na">readObject</span><span class="o">();</span>

        <span class="n">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="c1">// 从服务注册中找到具体的类, 这里写个假的</span>
        <span class="k">if</span><span class="o">(</span><span class="n">clazzName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;rpc.IUserService&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">clazz</span> <span class="o">=</span> <span class="n">UserServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span><span class="n">clazzName</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;rpc.IProService&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">clazz</span> <span class="o">=</span> <span class="n">ProServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="n">methodName</span><span class="o">,</span> <span class="n">parameterTypes</span><span class="o">);</span>
        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(),</span> <span class="n">methodArgs</span><span class="o">);</span>

        <span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
        <span class="c1">// 直接把返回对象写回给客户端</span>
        <span class="n">ObjectOutputStream</span> <span class="n">objectOutputStream</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">o</span><span class="o">);</span>
        <span class="n">objectOutputStream</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>

        <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">server</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<h2 id="rpc">RPC 序列化协议</h2>
<p>上述代码中涉及到了对象的序列化，反序列化：把对象转换字节数组在网络种传输，然后又读取字节数组，再次转换为原始对象</p>
<p>序列化框架：</p>
<ul>
<li>java.io.Serializable</li>
<li>Hessian</li>
<li>google protobuf</li>
<li>facebook thrift</li>
<li>kyro</li>
<li>json序列化框架：Jackson，google Gson，alibaba FastJson</li>
<li>xmlrpc(xstream)</li>
</ul>
<h3 id="_4">用序列化协议改写代码</h3>
<ul>
<li>Stub</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">rpc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.InvocationHandler</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Proxy</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2020/5/18 23:18</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Stub</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Object</span> <span class="nf">getStub</span><span class="o">(</span><span class="n">Class</span> <span class="n">clazz</span><span class="o">){</span>
        <span class="c1">// 调用方法处理器</span>
        <span class="n">InvocationHandler</span> <span class="n">h</span> <span class="o">=</span> <span class="k">new</span> <span class="n">InvocationHandler</span><span class="o">()</span> <span class="o">{</span>
            <span class="nd">@Override</span>
            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">invoke</span><span class="o">(</span><span class="n">Object</span> <span class="n">proxy</span><span class="o">,</span> <span class="n">Method</span> <span class="n">method</span><span class="o">,</span> <span class="n">Object</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Throwable</span> <span class="o">{</span>
                <span class="c1">// 要连接的服务端IP地址和端口</span>
                <span class="n">String</span> <span class="n">host</span> <span class="o">=</span> <span class="s">&quot;127.0.0.1&quot;</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">55533</span><span class="o">;</span>
                <span class="c1">// 与服务端建立连接</span>
                <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Socket</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">);</span>

                <span class="c1">// 构造请求服务器的对象</span>
                <span class="n">RpcRequest</span> <span class="n">rpcRequest</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RpcRequest</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span> <span class="n">method</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span>
                        <span class="n">method</span><span class="o">.</span><span class="na">getParameterTypes</span><span class="o">(),</span> <span class="n">args</span><span class="o">);</span>
                <span class="c1">// 传递二进制给服务端</span>
                <span class="n">OutputStream</span> <span class="n">outputStream</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
                <span class="n">outputStream</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">HessianSerializerUtil</span><span class="o">.</span><span class="na">serialize</span><span class="o">(</span><span class="n">rpcRequest</span><span class="o">));</span>
                <span class="n">socket</span><span class="o">.</span><span class="na">shutdownOutput</span><span class="o">();</span>

                <span class="c1">// 直接读取服务端返回的二进制, 反序列化为对象返回</span>
                <span class="n">InputStream</span> <span class="n">inputStream</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
                <span class="kt">byte</span><span class="o">[]</span> <span class="n">bytes</span> <span class="o">=</span> <span class="n">readInputStream</span><span class="o">(</span><span class="n">inputStream</span><span class="o">);</span>
                <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">HessianSerializerUtil</span><span class="o">.</span><span class="na">deserialize</span><span class="o">(</span><span class="n">bytes</span><span class="o">);</span>

                <span class="n">inputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="n">outputStream</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
                <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>

                <span class="k">return</span> <span class="n">o</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">};</span>

        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">Proxy</span><span class="o">.</span><span class="na">newProxyInstance</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">getClassLoader</span><span class="o">(),</span> <span class="k">new</span> <span class="n">Class</span><span class="o">[]{</span><span class="n">clazz</span><span class="o">},</span> <span class="n">h</span><span class="o">);</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">o</span><span class="o">.</span><span class="na">getClass</span><span class="o">().</span><span class="na">getInterfaces</span><span class="o">()[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="k">return</span> <span class="n">o</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">readInputStream</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">inputStream</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">2048</span><span class="o">];</span>
        <span class="kt">int</span> <span class="n">len</span><span class="o">;</span>
        <span class="n">ByteArrayOutputStream</span> <span class="n">bos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="k">while</span><span class="o">((</span><span class="n">len</span> <span class="o">=</span> <span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">bos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">len</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">bos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<ul>
<li>Server</li>
</ul>
<div class="hlcode"><pre><span class="kn">package</span> <span class="n">rpc</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.*</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.lang.reflect.Method</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.ServerSocket</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.net.Socket</span><span class="o">;</span>

<span class="cm">/**</span>
<span class="cm"> * @Author mubi</span>
<span class="cm"> * @Date 2020/5/18 23:18</span>
<span class="cm"> */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Server</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
        <span class="c1">// 监听指定的端口</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">55533</span><span class="o">;</span>
        <span class="n">ServerSocket</span> <span class="n">server</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ServerSocket</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>

        <span class="c1">// server将一直等待连接的到来</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;server将一直等待连接的到来&quot;</span><span class="o">);</span>
        <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="na">accept</span><span class="o">();</span>

        <span class="c1">// 建立好连接后，从socket中获取客户端传递过来的对象</span>
        <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="n">RpcRequest</span> <span class="n">rpcRequest</span> <span class="o">=</span> <span class="n">HessianSerializerUtil</span><span class="o">.</span><span class="na">deserialize</span><span class="o">(</span><span class="n">readInputStream</span><span class="o">(</span><span class="n">in</span><span class="o">));</span>
<span class="c1">//        System.out.println(&quot;rpcRequest:&quot; + rpcRequest);</span>

        <span class="c1">// 执行方法</span>
        <span class="n">Class</span> <span class="n">clazz</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// 从服务注册中找到具体的类, 这里写个假的</span>
        <span class="k">if</span><span class="o">(</span><span class="n">rpcRequest</span><span class="o">.</span><span class="na">getClassName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;rpc.IUserService&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">clazz</span> <span class="o">=</span> <span class="n">UserServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">if</span><span class="o">(</span><span class="n">rpcRequest</span><span class="o">.</span><span class="na">getClassName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;rpc.IProService&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="n">clazz</span> <span class="o">=</span> <span class="n">ProServiceImpl</span><span class="o">.</span><span class="na">class</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="n">Method</span> <span class="n">method</span> <span class="o">=</span> <span class="n">clazz</span><span class="o">.</span><span class="na">getMethod</span><span class="o">(</span><span class="n">rpcRequest</span><span class="o">.</span><span class="na">getMethodName</span><span class="o">(),</span> <span class="n">rpcRequest</span><span class="o">.</span><span class="na">getParamTypes</span><span class="o">());</span>
        <span class="n">Object</span> <span class="n">o</span> <span class="o">=</span> <span class="n">method</span><span class="o">.</span><span class="na">invoke</span><span class="o">(</span><span class="n">clazz</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(),</span> <span class="n">rpcRequest</span><span class="o">.</span><span class="na">getArgs</span><span class="o">());</span>

        <span class="c1">// 返回对象 二进制形式发送给客户端</span>
        <span class="n">OutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="na">getOutputStream</span><span class="o">();</span>
        <span class="n">out</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">HessianSerializerUtil</span><span class="o">.</span><span class="na">serialize</span><span class="o">(</span><span class="n">o</span><span class="o">));</span>
        <span class="n">out</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>

        <span class="n">socket</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">server</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">byte</span><span class="o">[]</span> <span class="nf">readInputStream</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">inputStream</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="kt">byte</span><span class="o">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[</span><span class="mi">2048</span><span class="o">];</span>
        <span class="kt">int</span> <span class="n">len</span><span class="o">;</span>
        <span class="n">ByteArrayOutputStream</span> <span class="n">bos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">();</span>
        <span class="k">while</span><span class="o">((</span><span class="n">len</span> <span class="o">=</span> <span class="n">inputStream</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">buffer</span><span class="o">))</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">bos</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">buffer</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">len</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">bos</span><span class="o">.</span><span class="na">toByteArray</span><span class="o">();</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>


<h2 id="rpc_1">RPC 网络协议</h2>
<p>通信协议</p>
<ul>
<li>TCP/UDP</li>
<li>Web Service</li>
<li>Restful(http + json)</li>
<li>RMI(Remote Method Invocation)</li>
<li>JMS(Java Message Service)</li>
<li>RPC(Remote Procedure Call)</li>
</ul>
<p>RPC采用的网络协议</p>
<p>RPC本身重点在于方法调用，可以用各种网络协议是实现，比如RMI,restful等，其中(RMI不能跨语言，Resful基于http：带宽占用高，效率低)</p>
<p>RPC多用于服务器集群间的通信</p>
<h2 id="rpc_2">回顾RPC</h2>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/distributed_design/imgs/rpc.png" /></p>
<h2 id="_5">为什么需要服务注册与发现</h2>
<p>随着服务数量的增多，各个服务之间的调用变得错综复杂，一个服务可能依赖外部多个服务，当一个服务的域名或IP地址改变了之后如何通知依赖方，或者依赖方如何快速的发现服务提供方的地址变化。</p>
<ul>
<li>客户端与服务端自己维护：有多少个服务，客户端就要维护多少个(服务增减，负载均衡，心跳)</li>
<li>找个代理，客户端有需求找代理，代理维持这些服务，也能给客户通知；（可以看成<code>代理模式</code>）</li>
</ul>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/distributed_design/imgs/rpc_reg.png" /></p>
<p><strong>服务注册</strong>就是维护一个登记簿，它管理系统内所有的服务地址。当新的服务启动后，它会向登记簿交待自己的地址信息。服务的依赖方直接向登记簿要Service Provider地址就行了</p>
<h3 id="_6">服务发现</h3>
<p><a href="https://www.nginx.com/blog/service-discovery-in-a-microservices-architecture/">Nginx Service Discovery blog</a></p>
<p>问题：Service instances have dynamically assigned network locations. Moreover, the set of service instances changes dynamically because of autoscaling, failures, and upgrades. Consequently, your client code needs to use a more elaborate service discovery mechanism.<br />
（服务实例是动态变化(扩缩容，失败，升级)的，且服务实例的网络地址是动态调整的；显然，客户端需要能及时正确的感知这些变化，需要一个可靠的服务发现机制）。</p>
<h4 id="_7">客户端实现</h4>
<p>When using client‑side discovery, the client is responsible for determining the network locations of available service instances and load balancing requests across them. The client queries a service registry, which is a database of available service instances. The client then uses a load‑balancing algorithm to select one of the available service instances and makes a request.‘</p>
<p>缺点：</p>
<p>One significant drawback of this pattern is that it couples the client with the service registry. You must implement client‑side service discovery logic for each programming language and framework used by your service clients.（这种模式的一个重要缺点是它将客户端与服务注册中心耦合起来。客户端必须为服务端使用的每种编程语言和框架实现一套服务发现逻辑。）</p>
<h4 id="_8">服务端实现</h4>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/distributed_design/imgs/server-discovery.png" /></p>
<p>The client makes a request to a service via a load balancer. The load balancer queries the service registry and routes each request to an available service instance. As with client‑side discovery, service instances are registered and deregistered with the service registry.</p>
<p>优缺点：</p>
<p>The server‑side discovery pattern has several benefits and drawbacks. One great benefit of this pattern is that details of discovery are abstracted away from the client. Clients simply make requests to the load balancer. This eliminates the need to implement discovery logic for each programming language and framework used by your service clients. Also, as mentioned above, some deployment environments provide this functionality for free. This pattern also has some drawbacks, however. Unless the load balancer is provided by the deployment environment, it is yet another highly available system component that you need to set up and manage.</p>
<h4 id="service-registry">服务注册中心（Service Registry）</h4>
<p>It is a database containing the network locations of service instances. A service registry needs to be highly available and up to date. Clients can cache network locations obtained from the service registry. However, that information eventually becomes out of date and clients become unable to discover service instances. Consequently, a service registry consists of a cluster of servers that use a replication protocol to maintain consistency.</p>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2020 doctording.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2020-06-28 09:36:13</p>
      </span>
    </div>

    
    
  </body>
</html>