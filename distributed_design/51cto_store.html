<!DOCTYPE HTML>
<html>
  <head>
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/style.css">
    <link rel="Stylesheet" type="text/css" href="/sword_at_offer/static/css/tango.css">
    <link rel="shortcut icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/sword_at_offer/favicon.ico" type="image/x-icon">
    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="Atom feed">
    <title>分布式存储系统基础 - 剑指Offer</title>
    <meta name="keywords" content="algorithm，python"/>
    <meta name="description" content="for python and algorithm"/>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  </head>

  <body>
    <div id="container">
      
<div id="header">
  <div class="post-nav"><a href="/sword_at_offer/">Home</a>&nbsp;&#187;&nbsp;<a href="/sword_at_offer/#distributed_design">distributed_design</a>&nbsp;&#187;&nbsp;分布式存储系统基础
    <span class="updated">Page Updated&nbsp;
      2019-06-07 00:00
    </span></div>
</div>
<div class="clearfix"></div>

<div class="page_title">分布式存储系统基础</div>

  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#_1">分布式存储系统基础</a><ul>
<li><a href="#_2">大数据对分布式存储对需求</a></li>
<li><a href="#_3">小概率故障</a></li>
<li><a href="#_4">常见分布式系统</a></li>
<li><a href="#_5">分布式系统设计要点</a></li>
<li><a href="#_6">写入流程</a><ul>
<li><a href="#_7">链式写入流程</a></li>
<li><a href="#_8">主从模式</a></li>
<li><a href="#_9">总结</a></li>
</ul>
</li>
<li><a href="#_10">读取流程</a><ul>
<li><a href="#_11">总结</a></li>
</ul>
</li>
<li><a href="#qos">Qos</a></li>
<li><a href="#checksum">CheckSum</a></li>
<li><a href="#replication">Replication</a></li>
<li><a href="#rebalance">Rebalance（数据均衡）</a></li>
<li><a href="#gc">GC</a><ul>
<li><a href="#_12">垃圾回收场景</a></li>
</ul>
</li>
<li><a href="#erasure-coding">Erasure Coding（？）</a></li>
<li><a href="#_13">元数据管理的高可用</a><ul>
<li><a href="#_14">高可用方案</a></li>
<li><a href="#hdfs-namenode">HDFS NameNode (主从模式)</a></li>
<li><a href="#pangu-metadata-server">Pangu Metadata Server</a></li>
<li><a href="#ceph-metadata-server">Ceph Metadata Server</a></li>
<li><a href="#paxos">Paxos 协议</a></li>
<li><a href="#raft">Raft协议</a></li>
</ul>
</li>
<li><a href="#_15">元数据管理的可扩展性</a></li>
<li><a href="#_16">数据的混合存储</a><ul>
<li><a href="#ramcloud">RAMCloud内存存储</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="_1">分布式存储系统基础</h1>
<p><strong>来源：51CTO,分布式存储系统视频课程</strong></p>
<hr />
<h2 id="_2">大数据对分布式存储对需求</h2>
<p>问题引入：对 1PB 数据排序，我们需要怎么样的存储系统</p>
<ol>
<li>存储容量大</li>
<li>高吞吐量</li>
<li>
<p>提高数据可靠性（应对数据规模的增长）</p>
</li>
<li>
<p>服务高可用（容错）</p>
</li>
</ol>
<p>量化下：每年只有几个小时不可用</p>
<ol>
<li>
<p>高效运维</p>
</li>
<li>
<p>将日常硬件处理作为常态，做成流程化</p>
</li>
<li>
<p>对于监控，告警等机制也要有非常完善的支持</p>
</li>
<li>
<p>低成本</p>
</li>
<li>
<p>保证数据安全，正确服务稳定的前提下，降低成本</p>
</li>
</ol>
<h2 id="_3">小概率故障</h2>
<p>大规模集群</p>
<ol>
<li>
<p>磁盘出错</p>
</li>
<li>
<p>机器宕机</p>
</li>
</ol>
<p>怎么把程序平滑的移到其它机器上</p>
<p>怎么把慢节点绕开</p>
<ol>
<li>
<p>Raid卡故障</p>
</li>
<li>
<p>网络故障</p>
</li>
<li>
<p>电源故障</p>
</li>
<li>
<p>数据错误</p>
</li>
<li>
<p>系统错误</p>
</li>
</ol>
<p>网络，内存分配出错</p>
<p>热点</p>
<ol>
<li>软件缺陷</li>
</ol>
<p>设计缺陷</p>
<ol>
<li>误操作</li>
</ol>
<h2 id="_4">常见分布式系统</h2>
<ol>
<li>HDFS</li>
</ol>
<p>nameNode 单节点</p>
<ol>
<li>
<p>Ceph</p>
</li>
<li>
<p>Pangu (阿里云)</p>
</li>
</ol>
<p>Checksum<br />
数据多备份<br />
异常会否机制<br />
回收站<br />
数据聚簇<br />
流控和优先级<br />
热点和满盘规避<br />
混合存储<br />
安全访问认证<br />
配额管理和审计<br />
磁盘自动上下线<br />
热升级<br />
动态扩容/缩容<br />
在线监控离线分析</p>
<ol>
<li>其它如（GPFS, Lustre MooseFS）</li>
</ol>
<h2 id="_5">分布式系统设计要点</h2>
<ul>
<li>读写流程</li>
</ul>
<p>慢节点，热节点<br />
<em> Qos(服务质量)<br />
</em> CheckSum(数据正确性)<br />
<em> Replication<br />
磁盘损坏，宕机，还能服务<br />
</em> Rebalacne（平横）<br />
<em> GC<br />
</em> Erasure Coding(成本)</p>
<h2 id="_6">写入流程</h2>
<h3 id="_7">链式写入流程</h3>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/distributed/imgs/lian.png" /></p>
<p>写入，某个节点有错误的情况</p>
<p>数据安全性/数据成功率</p>
<h3 id="_8">主从模式</h3>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/distributed/imgs/master.png" /></p>
<h3 id="_9">总结</h3>
<table>
<thead>
<tr>
<th>数据写入方法</th>
<th>优点</th>
<th>不足</th>
</tr>
</thead>
<tbody>
<tr>
<td>链式写入</td>
<td>每个节点的负载和流量比较均衡</td>
<td>链条过长，出现异常时诊断和修复过程比较复杂</td>
</tr>
<tr>
<td>主从写入</td>
<td>总路径较短，管理逻辑由主从节点负责</td>
<td>主节点有可能成为负载和流量瓶颈</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>异常处理方式</th>
<th>优点</th>
<th>不足</th>
</tr>
</thead>
<tbody>
<tr>
<td>重写修复</td>
<td>能最大程度保留之前写入的数据</td>
<td>- 直接剔除异常节点会导致后续写入的replica数降低 - 如果补充新的replica进来，需要补齐之前写入的数据，给新的replica</td>
</tr>
<tr>
<td>Seal and New</td>
<td>简单快速，可以绕过异常节点</td>
<td>Chunk长度不固定，需要更多的meta管理</td>
</tr>
</tbody>
</table>
<h2 id="_10">读取流程</h2>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/distributed/imgs/read_error.png" /></p>
<ul>
<li>Backup Read</li>
</ul>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/distributed/imgs/read_2.png" /></p>
<ul>
<li>满节点规避</li>
</ul>
<p>client从Master获取每个节点大概的返回时间</p>
<p><img alt="" src="https://raw.githubusercontent.com/doctording/sword_at_offer/master/content/distributed/imgs/read_3.png" /></p>
<h3 id="_11">总结</h3>
<p>多个副本分布方式：</p>
<ul>
<li>可读取任意的有效副本</li>
<li>副本出现异常时，尝试其它副本</li>
<li>Backup Read可以减少读取延迟</li>
<li>选取最优副本访问</li>
</ul>
<h2 id="qos">Qos</h2>
<p>用户分优先级，分组</p>
<p>IO量（IO量大的拒绝访问）</p>
<p>多个用户访问一个分布式文件系统能都占到IO带宽</p>
<h2 id="checksum">CheckSum</h2>
<ul>
<li>
<p>全链路CheckSum</p>
</li>
<li>
<p>数据： buffer length CRC</p>
</li>
<li>
<p>网络分包</p>
</li>
<li>
<p>数据和CRC是否存储在一起？验证效率和出错情况</p>
</li>
</ul>
<h2 id="replication">Replication</h2>
<ul>
<li>
<p>为防止机器顺坏或磁盘顺坏时，拷贝份数不够造成数据丢失</p>
</li>
<li>
<p>快速恢复</p>
</li>
<li>
<p>流量控制</p>
</li>
</ul>
<h2 id="rebalance">Rebalance（数据均衡）</h2>
<ul>
<li>
<p>充分利用多台机器的带宽</p>
</li>
<li>
<p>复制要有优先级</p>
</li>
<li>
<p>流量控制要严格</p>
</li>
</ul>
<h2 id="gc">GC</h2>
<h3 id="_12">垃圾回收场景</h3>
<ul>
<li>数据被删除的时候</li>
</ul>
<p>异步删除</p>
<ul>
<li>数据写入失败，脏数据留在磁盘上</li>
</ul>
<p>数据版本控制</p>
<ul>
<li>宕机</li>
</ul>
<h2 id="erasure-coding">Erasure Coding（？）</h2>
<p>存储效率和安全性</p>
<h2 id="_13">元数据管理的高可用</h2>
<ul>
<li>高可用</li>
</ul>
<p>多个备份： 在故障时快速切换， 保证状态一致性</p>
<ul>
<li>可扩展性</li>
</ul>
<p>元数据容量可线性扩展</p>
<p>元数据的服务能力可线性扩展</p>
<h3 id="_14">高可用方案</h3>
<ul>
<li>主从模式</li>
</ul>
<p>一主多从</p>
<p>数据一致性通过共享存储</p>
<ul>
<li>分布式协议</li>
</ul>
<p>Paxos/Raft协议</p>
<h3 id="hdfs-namenode">HDFS NameNode (主从模式)</h3>
<h3 id="pangu-metadata-server">Pangu Metadata Server</h3>
<ul>
<li>
<p>使用Paxos一致性协议，保证高可用和快速切换</p>
</li>
<li>
<p>不依赖外部贡献存储和互斥锁服务，独立自包含</p>
</li>
</ul>
<h3 id="ceph-metadata-server">Ceph Metadata Server</h3>
<ul>
<li>
<p>自身具备共享存储能力</p>
</li>
<li>
<p>用心跳代替分布式锁</p>
</li>
<li>
<p>做到独立自包含</p>
</li>
</ul>
<h3 id="paxos">Paxos 协议</h3>
<h3 id="raft">Raft协议</h3>
<h2 id="_15">元数据管理的可扩展性</h2>
<ul>
<li>
<p>HDFS NameNode</p>
</li>
<li>
<p>Ceph Metadata Server</p>
</li>
</ul>
<h2 id="_16">数据的混合存储</h2>
<ul>
<li>不存存储截介质的特性</li>
</ul>
<table>
<thead>
<tr>
<th>-</th>
<th>磁盘</th>
<th>SSD</th>
<th>内存</th>
</tr>
</thead>
<tbody>
<tr>
<td>容量</td>
<td>1-4TB</td>
<td>400-800GB</td>
<td>24 -128GB</td>
</tr>
<tr>
<td>延迟</td>
<td>10ms</td>
<td>50-75pm</td>
<td>100nm</td>
</tr>
<tr>
<td>吞吐</td>
<td>100-200MB/s</td>
<td>400MB/s</td>
<td>20GB/s</td>
</tr>
<tr>
<td>成本</td>
<td>低</td>
<td>中</td>
<td>高</td>
</tr>
</tbody>
</table>
<h3 id="ramcloud">RAMCloud内存存储</h3>
    </div>
    <div id="footer">
      <span>
        <p>Copyright © 2019 doctording.
        Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.</p>
        <p>Site Generated 2019-09-07 10:28:46</p>
      </span>
    </div>

    
    
  </body>
</html>